<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classified Abstract - FAC76 Report Generator</title>
    <style>
        :root {
            --sidebar-width: 340px;
            --primary-bg: #f4f4f4;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-item-bg: #34495e;
            --sidebar-item-hover-bg: #4a627a;
            --accent-color: #3498db;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
            color: #333;
        }

        #lockout-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 3000;
            flex-direction: column;
        }
        #lockout-overlay h2 { font-size: 2em; }
        #lockout-overlay p { font-size: 1.2em; }

        /* --- START: Login Page Styles --- */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-box h2 { margin-bottom: 20px; color: #333; }
        .login-box .input-group { margin-bottom: 15px; text-align: left; }
        .login-box label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .login-box input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-box button:hover { background-color: #218838; }
        .login-box a { display: block; margin-top: 20px; color: #007bff; text-decoration: none; font-size: 14px; }
        .login-box a:hover { text-decoration: underline; }
        .login-footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            text-align: center;
            width: 90%;
            max-width: 1000px;
            font-size: 14px;
            line-height: 1.5;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }
        /* --- END: Login Page Styles --- */

        /* --- START: New App Layout --- */
        #app-container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        /* --- END: New App Layout --- */

        /* --- START: Sidebar Control Styles --- */
        #sidebar details {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--sidebar-item-bg);
            border-radius: 6px;
        }
        #sidebar summary {
            font-weight: bold;
            font-size: 1.1em;
            padding: 12px 15px;
            cursor: pointer;
            background-color: var(--sidebar-item-bg);
            border-radius: 5px 5px 0 0;
            list-style: none; /* Remove default marker */
        }
        #sidebar summary::-webkit-details-marker { display: none; } /* Chrome/Safari */
        #sidebar summary::before { content: '▶ '; font-size: 0.8em; }
        #sidebar details[open] > summary::before { content: '▼ '; }

        .sidebar-group {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sidebar-group label {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: -5px; /* Reduce space after label */
        }

        .sidebar-group input,
        .sidebar-group select {
            width: 100%;
            padding: 8px 10px;
            box-sizing: border-box;
            background-color: var(--sidebar-item-bg);
            color: var(--sidebar-text);
            border: 1px solid var(--sidebar-item-hover-bg);
            border-radius: 4px;
            font-size: 14px;
        }
        .sidebar-group input::placeholder { color: #bdc3c7; }
        .sidebar-group select option { background-color: var(--sidebar-item-bg); color: var(--sidebar-text); }
        .sidebar-group input[type="file"] { display: none; }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .toolbar-btn {
            background-color: var(--accent-color);
            color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer;
            font-weight: bold; font-size: 13px; display: inline-flex; align-items: center;
            gap: 8px; transition: all 0.2s ease-in-out; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .toolbar-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
		.toolbar-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn-success { background-color: #2ecc71; } .btn-success:hover { background-color: #27ae60; }
        .btn-warning { background-color: #f39c12; } .btn-warning:hover { background-color: #e67e22; }
        .btn-info { background-color: #1abc9c; } .btn-info:hover { background-color: #16a085; }
        .btn-danger { background-color: #e74c3c; } .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: #95a5a6; } .btn-secondary:hover { background-color: #7f8c8d; }
        .btn-special { background-color: #9b59b6; } .btn-special:hover { background-color: #8e44ad; }
        .btn-logout { background-color: #f1c40f; color: #2c3e50; } .btn-logout:hover { background-color: #f39c12; }
        /* --- END: Sidebar Control Styles --- */
        
        #report-output { margin-top: 20px; }
        .report-wrapper:last-of-type, .fac63-wrapper:last-of-type { page-break-after: avoid; }
        .main-report-header { text-align: center; margin-bottom: 15px; }
        .main-report-header h2, .main-report-header h3 { margin: 5px 0; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        
        #report-output .report-wrapper .report table th,
        #report-output .report-wrapper .report table td { border: 2px solid black; }
        
        #report-output .abstract-table th,
        #report-output .abstract-table td { border: 1px solid black; }

        th { background-color: #f2f2f2; font-weight: bold; }
        td.amount, th.amount { text-align: right; }
        tfoot td { font-weight: bold; }
        .grand-total { margin-top: 30px; padding-top: 15px; border-top: 2px solid #333; page-break-before: avoid; }
        .grand-total h3 { margin: 0; }
        .grand-total p { margin: 5px 0 0; }
        #status-message { margin-top: 10px; font-weight: bold; padding: 0 20px;}
        #error-message { color: red; font-weight: bold; }

        .abstract-section { margin-top: 40px; page-break-before: auto; display: flex; justify-content: center; flex-direction: column; align-items: center; }
        .abstract-table { width: 60%; }
        .abstract-table h3 { text-align: center; margin-bottom: 10px; font-weight: bold; }
        
        .signature-container { margin-top: 80px; display: flex; justify-content: space-between; align-items: flex-start; page-break-inside: avoid; }
        .acf-signature, .rfo-signature { font-weight: bold; width: 48%; }
        .acf-signature p, .rfo-signature p { margin: 5px 0; }
        .acf-signature { text-align: left; }
        .rfo-signature { text-align: right; }

        .contract-certificate-wrapper, .work-abstract-wrapper, .fac63-wrapper, .fac84-wrapper { page-break-before: always; }
        
        .fac63-header { text-align: center; }
        .fac63-main-table th, .fac63-main-table td {
            border: 2px solid black;
        }
        .fac63-wrapper .fac63-details-grid table td {
            border: 2px solid black;
        }
        .fac63-main-table tfoot .sub-total td { font-weight: bold; background-color: #f2f2f2; }


        .work-abstract-wrapper .wa-header { text-align: center; font-weight: bold; font-size: 1.1em; margin-bottom: 20px; }
        .work-abstract-wrapper .wa-header h4, .work-abstract-wrapper .wa-header p { margin: 5px 0; }
        .work-abstract-wrapper .wa-table { width: 100%; border: 2px solid black; border-collapse: collapse; }
        .work-abstract-wrapper .wa-table th, .work-abstract-wrapper .wa-table td { border: 1px solid black; padding: 5px; }
        .work-abstract-wrapper .wa-table .sub-total td { font-weight: bold; background-color: #f2f2f2; }
        .work-abstract-wrapper .wa-footer { margin-top: 20px; }
        .work-abstract-wrapper .wa-footer p { margin: 10px 0; }
        .work-abstract-wrapper .wa-signatures { margin-top: 60px; display: flex; justify-content: space-between; font-weight: bold; }

        .fac85-wrapper { page-break-before: always; }
        .fac85-header { display: flex; justify-content: space-between; }
        .fac85-title { text-align: center; font-weight: bold; margin: 10px 0; }
        .fac85-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .fac85-body p { margin: 10px 0; line-height: 1.6; }
        .fac85-signatures { margin-top: 20px; display: flex; justify-content: space-between; }
        .fac85-memo-table { border: 2px solid black; margin-top: 15px; }
        .fac85-memo-table td { border: 1px solid black; padding: 5px; }
        
        #dynamic-fields-container {
            width: 100%; margin-top: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px;
        }
        .dynamic-field-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .dynamic-field-row label { font-weight: bold; white-space: nowrap; }
        .dynamic-field-row input, .dynamic-field-row select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .dynamic-field-row input[readonly] { background-color: #e9ecef; }

        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; }
        .modal-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: black; }
        .modal-form { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 20px; align-items: center;}
        .modal-form input, .modal-form button, .modal-form select { width: 100%; padding: 8px; box-sizing: border-box; }
        .modal-list ul { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .modal-list li { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .modal-list li:last-child { border-bottom: none; }
        .modal-list .delete-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .modal-list .view-btn, .modal-list .edit-btn, .modal-list .unmerge-btn { 
            background-color: #007bff; color: white; border: none; padding: 5px 10px; 
            border-radius: 4px; cursor: pointer; margin-left: auto; 
        }
        .modal-list .unmerge-btn { background-color: #f39c12; }
        
        .editable-particulars {
            padding: 5px;
            border: 1px dashed #a9a9a9;
            background-color: #f9f9f9;
            min-height: 50px;
        }
        .editable-particulars:focus {
            outline: 1px solid var(--accent-color);
            background-color: #fff;
        }
        .editable-input {
            width: 95%;
            padding: 4px;
            border: 1px dashed #a9a9a9;
            background-color: #f9f9f9;
            text-align: right;
        }
        .editable-input:focus {
            outline: 1px solid var(--accent-color);
            background-color: #fff;
        }
        .editable-select {
            padding: 4px;
            border: 1px dashed #a9a9a9;
            background-color: #f9f9f9;
        }
        .delete-item-btn, .add-item-btn, .edit-purchase-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 10px;
            vertical-align: middle;
        }
        .add-item-btn {
            background-color: #2ecc71;
            display: block;
            margin: 8px 0 8px auto;
            width: fit-content;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
        }
        .edit-purchase-btn {
            background-color: #f39c12;
            padding: 3px 8px;
            font-size: 11px;
        }
        .delete-option-btn {
            background-color: #e74c3c; color: white; border: none; border-radius: 50%;
            cursor: pointer; width: 20px; height: 20px; font-size: 10px;
            line-height: 20px; text-align: center; padding: 0;
        }
        .delete-item-btn:hover, .delete-option-btn:hover { background-color: #c0392b; }
        .add-item-btn:hover { background-color: #27ae60; }
        .edit-purchase-btn:hover { background-color: #e67e22; }

        /* Payee Ledger Styles */
        #payee-ledger-content h3 {
            background-color: #f2f2f2;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }
        .ledger-table th, .ledger-table td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        .ledger-table td:first-child {
            font-weight: bold;
            width: 70%;
        }
        .ledger-table td:last-child {
            text-align: right;
        }
        .ledger-table .total-row td {
            font-weight: bold;
            background-color: #f2f2f2;
            border-top: 2px solid black;
        }
        .payee-wise-summary {
            width: 100%;
            margin-top: 20px;
        }
        .payee-wise-summary th, .payee-wise-summary td {
            border: 1px solid black;
        }


        @media print {
            @page {
                size: A4 portrait;
                margin: 0.5in;
            }
            
            #sidebar, .no-print {
                display: none !important;
            }

            body, .report-wrapper, .work-abstract-wrapper, .fac85-wrapper, .fac63-wrapper, .main-table, .cashbook-inner-table, .summary-table {
                font-size: 1em !important;
                line-height: 1.4;
            }

            body {
                margin: 0;
                background-color: #fff;
            }

            #app-container {
                display: block !important;
                height: auto !important;
                padding: 0 !important;
            }
            #main-content {
                padding: 0 !important;
                overflow: visible !important;
                flex-grow: 1 !important;
            }
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            .container > *:not(#report-output) {
                display: none;
            }
            #report-output {
                display: block;
                margin-top: 0;
            }
            
            .editable-particulars, .editable-input, .editable-select {
                border: none !important;
                background-color: transparent !important;
                padding: 0 !important;
                width: auto !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            .editable-particulars { min-height: unset; }
            .editable-input { text-align: right; }

            .summary-section { page-break-before: auto; }
            .cashbook-page { page-break-after: always; }
            .cashbook-page:last-child { page-break-after: avoid; }

            /* New styles for printing the ledger */
            body.printing-ledger > *:not(#payee-ledger-modal) {
                display: none !important;
            }
            body.printing-ledger #payee-ledger-modal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                background-color: white !important;
            }
            body.printing-ledger #payee-ledger-modal .modal-content {
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                max-width: none !important;
                max-height: none !important;
                overflow: visible !important;
            }
            body.printing-ledger #payee-ledger-content {
                max-height: none !important;
                overflow: visible !important;
            }
        }
    </style>
</head>
<body>

<div id="lockout-overlay"></div>

<!-- Login and Password Change UI -->
<div id="login-container">
    <div class="login-box">
        <h2>Report Generator Login</h2>
        <p id="login-error" style="color: red; text-align: center; min-height: 1em;"></p>
        <form id="login-form">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <a href="#" id="change-password-link">Change Password</a>
    </div>
     <div class="login-footer">
        N. Mohamed Iqbal Ahamed, Superintendent, Karnataka Forest Department, "Developer-cum-Vendor of Estimate Creation Web Application " utilizing advanced AI technologies and prompt-engineering methodologies.
        <br>Contact:📞 +91 91102 49941 | 📧 esaleiqb1988@gmail.com
        <br>
        <strong>”NOT FOR SALE”</strong>
    </div>
</div>

<div id="change-password-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close-btn">×</span>
        <h2>Change Password</h2>
        <p id="change-password-message" style="text-align: center; font-weight: bold; min-height: 1em;"></p>
        <form id="change-password-form" class="modal-form" style="grid-template-columns: 1fr 2fr;">
            <label for="current-password">Current Password:</label>
            <input type="password" id="current-password" required>

            <label for="new-password">New Password:</label>
            <input type="password" id="new-password" required>

            <label for="confirm-new-password">Confirm New Password:</label>
            <input type="password" id="confirm-new-password" required>

            <label></label>
            <button type="submit" style="background-color: #007bff; color: white; border: none;">Update Password</button>
        </form>
    </div>
</div>
<!-- End Login UI -->


<!-- Main Application Container (Initially Hidden) -->
<div id="app-container" style="display: none;">
    
    <nav id="sidebar">
        <details open>
            <summary>Core Actions</summary>
            <div class="sidebar-group">
                <label for="json-file-input" class="toolbar-btn"><span>&#x1F4C2;</span> Import JSON</label>
                <input type="file" id="json-file-input" accept=".json">

                <label for="report-type-select">Report Type:</label>
                <select id="report-type-select">
                    <option value="work">Work</option>
                    <option value="timber">Timber</option>
                    <option value="civil">Civil</option>
                    <option value="e-procurmentTender">e-procurmentTender</option>
                    <option value="selectedVoucher">Selected Voucher</option>
                    <option value="non-work">Non Work (FAC-63)</option>
                </select>
                
                <label for="token-input">Token No:</label>
                <select id="token-input">
                    <option value="">-- Import JSON First --</option>
                </select>
                
                <div class="btn-grid" style="margin-top: 10px;">
                    <button id="generate-btn" class="toolbar-btn btn-success"><span>&#x25B6;</span> Generate</button>
                    <button id="save-pdf-btn" class="toolbar-btn btn-info"><span>&#x1F5A8;</span> Save PDF</button>
                </div>
            </div>
        </details>

        <details open>
            <summary>Report Parameters</summary>
            <div class="sidebar-group">
                <label for="contractor-details-input">Payee:</label>
                <select id="contractor-details-input" disabled>
                    <option value="">-- Loading... --</option>
                </select>
                
                <label for="k2-bill-input">K2 Bill No & Date:</label>
                <input type="text" id="k2-bill-input" placeholder="e.g., 123/25-26 Dt: 01-07-25">
                
                <label>Tax & Cess Deductions (%)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label for="it-percent-input" style="font-size:12px;">IT%:</label>
                        <input type="number" id="it-percent-input" value="1" step="0.1">
                    </div>
                    <div>
                        <label for="labour-cess-input" style="font-size:12px;">Labour%:</label>
                        <input type="number" id="labour-cess-input" value="1" step="0.1">
                    </div>
                    <div>
                        <label for="cgst-percent-input" style="font-size:12px;">CGST%:</label>
                        <input type="number" id="cgst-percent-input" value="1" step="0.1">
                    </div>
                    <div>
                        <label for="sgst-percent-input" style="font-size:12px;">SGST%:</label>
                        <input type="number" id="sgst-percent-input" value="1" step="0.1">
                    </div>
                    <div id="royalty-percent-container" style="display: none;">
                        <label for="royalty-percent-input" style="font-size:12px;">Royalty%:</label>
                        <input type="number" id="royalty-percent-input" value="0.70" step="0.1">
                    </div>
                </div>
            </div>
        </details>

        <details>
            <summary>Data Management</summary>
            <div class="sidebar-group btn-grid">
                <button id="manage-contractors-btn" class="toolbar-btn btn-warning"><span>&#x1F464;</span> Payees</button>
                <button id="manage-agreements-btn" class="toolbar-btn btn-warning"><span>&#x1F4DC;</span> Agreements</button>
                <button id="manage-saved-reports-btn" class="toolbar-btn btn-info"><span>&#x1F4BE;</span> Saved Reports</button>
                <button id="edit-saved-reports-btn" class="toolbar-btn btn-warning"><span>✏️</span> Edit Reports</button>
                <button id="view-all-tokens-btn" class="toolbar-btn btn-special"><span>&#x1F50E;</span> View Tokens</button>
                <button id="view-payee-ledger-btn" class="toolbar-btn btn-special" style="display: none;"><span>&#x1F4D2;</span> Payee Ledger</button>
            </div>
        </details>
        
        <details>
            <summary>Application Settings</summary>
             <div class="sidebar-group btn-grid">
                <button id="export-all-data-btn" class="toolbar-btn btn-secondary"><span>&#x1F4E4;</span> Export All</button>
                <label for="import-all-data-input" class="toolbar-btn btn-secondary"><span>&#x1F4E5;</span> Import All</label>
                <input type="file" id="import-all-data-input" accept=".json">
                <button id="refresh-btn" class="toolbar-btn btn-secondary"><span>&#x21BB;</span> Refresh</button>
                <button id="clear-data-btn" class="toolbar-btn btn-danger"><span>&#x1F5D1;</span> Clear Data</button>
             </div>
             <div class="sidebar-group">
                <button id="logout-btn" class="toolbar-btn btn-logout" style="width: 100%;"><span>&#x23FB;</span> Logout</button>
             </div>
        </details>

        <details>
            <summary>Static Office Info</summary>
            <div class="sidebar-group">
                 <label for="rfo-name-input">RFO:</label>
                <input type="text" id="rfo-name-input" value=" Range Forest Officer" readonly>
                <label for="division-input">Division:</label>
                <input type="text" id="division-input" value="SAGAR DIVISION, SAGAR" readonly>
                <label for="sub-division-input">Sub-Division:</label>
                <input type="text" id="sub-division-input" value="Shikaripura Sub Division, Shikaripura" readonly>
            </div>
        </details>

    </nav>

    <main id="main-content">
        <div class="container">
            <div id="dynamic-fields-container"></div>
            <div id="status-message"></div>
            <div class="no-print" style="text-align: right; margin-bottom: 10px;">
                <button id="save-edits-btn" class="toolbar-btn btn-success" style="display: none;"><span>💾</span> Save Edits</button>
                <button id="print-report-btn" class="toolbar-btn btn-special" style="display: none;"><span>🖨️</span> Print Report</button>
            </div>
            <div id="report-output"></div>
        </div>
    </main>

    <!-- Modals -->
    <div id="contractor-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">×</span>
            <h2>Manage Contractors / Payees</h2>
            <div class="modal-io-controls">
                <button id="export-contractors-btn">Export to JSON</button>
                <button id="import-contractors-btn">Import from JSON</button>
                <input type="file" id="import-contractors-input" accept=".json" style="display: none;">
            </div>
            <hr><h4>Add New</h4>
            <form id="add-contractor-form" class="modal-form">
                <label for="new-contractor-name">Name:</label><input type="text" id="new-contractor-name" required>
                <label for="new-contractor-address">Address:</label><input type="text" id="new-contractor-address" required>
                <label for="new-contractor-gst">GSTIN:</label><input type="text" id="new-contractor-gst" required>
                <label for="new-contractor-pan">PAN:</label><input type="text" id="new-contractor-pan" required>
                <label></label><button type="submit" style="background-color: #28a745; color: white; border: none;">Save</button>
            </form><hr><h4>Saved List</h4>
            <div id="contractor-list" class="modal-list"></div>
        </div>
    </div>
    <div id="agreement-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">×</span>
            <h2>Manage Agreements & Work Orders</h2>
            <div class="modal-io-controls">
                <button id="export-agreements-btn">Export to JSON</button>
                <button id="import-agreements-btn">Import from JSON</button>
                <input type="file" id="import-agreements-input" accept=".json" style="display: none;">
            </div>
            <hr><h4>Add New Entry</h4>
            <form id="add-agreement-form" class="modal-form">
                <label for="new-agreement-estimate">Estimate No:</label><input type="text" id="new-agreement-estimate" placeholder="e.g., EST/2023-24/1" required>
                <label for="new-agreement-no">Agreement Number & Year:</label><input type="text" id="new-agreement-no" placeholder="e.g., 5/2023-24" required>
                <label for="new-agreement-workorder">Work Order No. & Date:</label><input type="text" id="new-agreement-workorder" placeholder="e.g., 123 Dt: 01-07-2023" required>
                <label></label><button type="submit" style="background-color: #28a745; color: white; border: none;">Save Entry</button>
            </form><hr><h4>Saved Entries</h4>
            <div id="agreement-list" class="modal-list"></div>
        </div>
    </div>
    <div id="nonwork-payee-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" id="nonwork-payee-close-btn">×</span>
            <h2>Enter Payee Details for Non-Work Report</h2>
            <div id="nonwork-payee-input-container">
                <!-- Content is generated by JavaScript -->
            </div>
        </div>
    </div>
    <div id="saved-reports-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">×</span>
            <h2>Saved Classified Abstracts</h2>
            <div id="saved-reports-list" class="modal-list"></div>
        </div>
    </div>
    <div id="all-tokens-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">×</span>
            <h2>Saved Tokens & Treasury Details</h2>
            <div id="all-tokens-list" class="modal-list"></div>
            <div id="cashbook-filter-container"></div>
            <div class="modal-footer-buttons">
                <button id="save-treasury-btn" style="background-color: #28a745;">Save Treasury Details</button>
            </div>
        </div>
    </div>
    
    <div id="tender-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close-btn">×</span>
            <h2>Enter Tender Percentage ("iff tender")</h2>
            <p>Please enter the tender percentage for each estimate. The final report amounts will be calculated based on this.</p>
            <hr>
            <form id="tender-form">
                <!-- Dynamic content will be injected here by JavaScript -->
            </form>
            <div class="modal-footer-buttons">
                 <button type="submit" form="tender-form" class="toolbar-btn btn-success">Continue</button>
            </div>
        </div>
    </div>

    <div id="gst-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close-btn">×</span>
            <h2>Add GST (For Timber/Civil/e-Procurement)</h2>
            <p>Please enter the GST percentages to be added to the net amount.</p>
            <hr>
            <form id="gst-form">
                 <div class="modal-form" style="grid-template-columns: 1fr 1fr; align-items: center;">
                    <label for="add-cgst-percent"><b>Add CGST (%):</b></label>
                    <input type="number" id="add-cgst-percent" class="gst-percent-input" placeholder="e.g., 9" step="any" value="9" required>
                    <label for="add-sgst-percent"><b>Add SGST (%):</b></label>
                    <input type="number" id="add-sgst-percent" class="gst-percent-input" placeholder="e.g., 9" step="any" value="9" required>
                 </div>
            </form>
            <div class="modal-footer-buttons">
                 <button type="submit" form="gst-form" class="toolbar-btn btn-success">Apply GST & Generate Report</button>
            </div>
        </div>
    </div>
    
    <!-- VOUCHER TYPE SELECTION MODAL -->
    <div id="selected-voucher-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close-btn">×</span>
            <h2>Select Voucher Form Type</h2>
            <div id="selected-voucher-form">
                <div style="padding: 10px 0;">
                    <input type="radio" id="select-fac63" name="voucher-type" value="fac63" checked>
                    <label for="select-fac63">Form FAC-63 (With Work Abstract)</label>
                </div>
                <div style="padding: 10px 0;">
                    <input type="radio" id="select-fac85" name="voucher-type" value="fac85">
                    <label for="select-fac85">Form FAC-85 (Full Contract)</label>
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                 <button id="selected-voucher-ok-btn" class="toolbar-btn btn-success">OK</button>
            </div>
        </div>
    </div>

    <!-- EDITING SAVED REPORTS MODAL -->
    <div id="edit-report-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close-btn">×</span>
            <h2>Edit Saved Report Parameters</h2>
            <div id="edit-report-list-container">
                <h4>Select a Report to Edit or Merge</h4>
				<p><small>Note: You can only merge reports that share the same Budget Head.</small></p>
                <div id="edit-report-list" class="modal-list"></div>
				<div style="text-align: right; margin-top: 15px;">
                    <button id="merge-reports-btn" class="toolbar-btn btn-special" style="display: none;"><span>🔄</span> Edit/Merge Selected</button>
                </div>
            </div>
            <div id="edit-report-form-container" style="display: none; max-height: 70vh; overflow-y: auto;">
                <!-- Form will be dynamically generated here -->
            </div>
        </div>
    </div>
	
	<!-- MERGE PAYEE SELECTION MODAL -->
    <div id="merge-payee-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <span class="modal-close-btn">×</span>
            <h2>Confirm Report Merge</h2>
            <p>You are about to merge the selected reports. The original payees for each part of the report will be preserved.</p>
            <p>Click 'Proceed to Merge' to continue.</p>
            <div style="text-align: right; margin-top: 20px;">
                 <button id="confirm-merge-btn" class="toolbar-btn btn-success">Proceed to Merge</button>
            </div>
        </div>
    </div>
    
    <!-- MANUAL ROYALTY MODAL -->
    <div id="manual-royalty-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close-btn">×</span>
            <h2>Enter Royalty Details for Sand/Redearth</h2>
            <p>Please enter the quantities and rates for royalty calculation. Leave fields as 0 if not applicable.</p>
            <hr>
            <form id="manual-royalty-form">
                 <div class="modal-form" style="grid-template-columns: 1fr 1fr; align-items: center;">
                    <label for="sand-qty"><b>Sand Quantity (Cum):</b></label>
                    <input type="number" id="sand-qty" class="royalty-calc-input" placeholder="e.g., 10.5" step="any" value="0">
                    <label for="sand-rate"><b>Sand Rate (per Cum):</b></label>
                    <input type="number" id="sand-rate" class="royalty-calc-input" placeholder="e.g., 50" step="any" value="0">
                    <label for="redearth-qty"><b>Redearth Quantity (Cum):</b></label>
                    <input type="number" id="redearth-qty" class="royalty-calc-input" placeholder="e.g., 15" step="any" value="0">
                    <label for="redearth-rate"><b>Redearth Rate (per Cum):</b></label>
                    <input type="number" id="redearth-rate" class="royalty-calc-input" placeholder="e.g., 30" step="any" value="0">
                    <hr style="grid-column: 1 / -1;">
                    <label><b>Total Calculated Royalty:</b></label>
                    <input type="text" id="total-royalty-display" readonly style="font-weight: bold; background-color: #e9ecef;">
                 </div>
            </form>
            <div class="modal-footer-buttons">
                 <button type="submit" form="manual-royalty-form" class="toolbar-btn btn-success">Apply Royalty & Continue</button>
            </div>
        </div>
    </div>
    
    <!-- PURCHASE/COST MODAL -->
    <div id="purchase-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close-btn">×</span>
            <h2>Enter Purchase/Cost Details</h2>
            <p>Enter the original bill amount. GST will be added to calculate the new total expenditure for this item.</p>
            <hr>
            <form id="purchase-form">
                 <div class="modal-form" style="grid-template-columns: 1fr 1fr; align-items: center;">
                    <input type="hidden" id="purchase-voucher-index">
                    <input type="hidden" id="purchase-item-index">
                    <label for="purchase-original-amount"><b>Bill Original Amount:</b></label>
                    <input type="number" id="purchase-original-amount" class="purchase-calc-input" placeholder="e.g., 10000" step="any" value="0" required>
                    <label for="purchase-add-cgst"><b>Add CGST (%):</b></label>
                    <input type="number" id="purchase-add-cgst" class="purchase-calc-input" placeholder="e.g., 9" step="any" value="9">
                    <label for="purchase-add-sgst"><b>Add SGST (%):</b></label>
                    <input type="number" id="purchase-add-sgst" class="purchase-calc-input" placeholder="e.g., 9" step="any" value="9">
                    <hr style="grid-column: 1 / -1;">
                    <label><b>Total Item Amount:</b></label>
                    <input type="text" id="total-purchase-display" readonly style="font-weight: bold; background-color: #e9ecef;">
                 </div>
            </form>
            <div class="modal-footer-buttons">
                 <button type="submit" form="purchase-form" class="toolbar-btn btn-success">Update Item Amount</button>
            </div>
        </div>
    </div>


    <!-- PAYEE LEDGER MODAL -->
    <div id="payee-ledger-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1050px;">
            <span class="modal-close-btn no-print">×</span>
            <h2>Payee Ledger (ಪಾವತಿದಾರರ ಲೆಡ್ಜರ್)</h2>
            <div id="payee-ledger-filters" class="no-print"></div>
            <div id="payee-ledger-chart-container" style="max-height: 60vh; overflow-y: auto; margin-top:20px;"></div>
            <div id="payee-ledger-content" style="display:none;"></div>
        </div>
    </div>


</div> <!-- End #app-container -->


<script>
let data = null;
let nonWorkPayees = [];
let capturedAgreementData = {};
let voucherFinancialLimit = 49999;
let currentReportVouchers = [];
let currentReportParameters = {};
let currentEditingReportId = null;
let selectedVoucherSubType = 'fac63'; // To store the choice from the new modal

const LS_CREDENTIALS_KEY = 'cashbook_credentials';
const LS_CONTRACTOR_KEY = 'cashbook56_contractors';
const LS_AGREEMENT_KEY = 'cashbook56_agreements';
const LS_SAVED_REPORTS_KEY = 'cashbook86_savedReports';
const LS_SVR_NO_KEY = 'cashbook86_svrCounters';
const LS_TREASURY_DATA_KEY = 'cashbook_treasury_data';

// --- START: Auth & Login/Logout Logic ---
const loginContainer = document.getElementById('login-container');
const appContainer = document.getElementById('app-container');
const loginForm = document.getElementById('login-form');
const loginError = document.getElementById('login-error');
const changePasswordLink = document.getElementById('change-password-link');
const changePasswordModal = document.getElementById('change-password-modal');
const changePasswordForm = document.getElementById('change-password-form');
const changePasswordMessage = document.getElementById('change-password-message');

function handleLogin(event) {
    event.preventDefault();
    const usernameInput = document.getElementById('username').value;
    const passwordInput = document.getElementById('password').value;
    const credentials = JSON.parse(localStorage.getItem(LS_CREDENTIALS_KEY));

    if (credentials && usernameInput === credentials.username && passwordInput === credentials.password) {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'flex';
        loginError.textContent = '';
        loginForm.reset();
    } else {
        loginError.textContent = 'Invalid username or password.';
    }
}

function handleChangePassword(event) {
    event.preventDefault();
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmNewPassword = document.getElementById('confirm-new-password').value;
    const credentials = JSON.parse(localStorage.getItem(LS_CREDENTIALS_KEY));
    
    changePasswordMessage.style.color = 'red';

    if (!credentials || currentPassword !== credentials.password) {
        changePasswordMessage.textContent = 'Current password is incorrect.';
        return;
    }
    if (newPassword.length < 4) {
        changePasswordMessage.textContent = 'New password must be at least 4 characters long.';
        return;
    }
    if (newPassword !== confirmNewPassword) {
        changePasswordMessage.textContent = 'New passwords do not match.';
        return;
    }

    credentials.password = newPassword;
    localStorage.setItem(LS_CREDENTIALS_KEY, JSON.stringify(credentials));
    
    changePasswordMessage.textContent = 'Password updated successfully!';
    changePasswordMessage.style.color = 'green';
    
    setTimeout(() => {
        changePasswordModal.style.display = 'none';
        changePasswordForm.reset();
        changePasswordMessage.textContent = '';
    }, 2000);
}

document.addEventListener('DOMContentLoaded', () => {
    if (!localStorage.getItem(LS_CREDENTIALS_KEY)) {
        const defaultCredentials = { username: 'admin', password: 'password' };
        localStorage.setItem(LS_CREDENTIALS_KEY, JSON.stringify(defaultCredentials));
        alert('First time setup: Default login is username "admin" and password "password". Please use the "Change Password" link to set a new password.');
    }

    loginForm.addEventListener('submit', handleLogin);
    changePasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        changePasswordModal.style.display = 'block';
    });
    changePasswordForm.addEventListener('submit', handleChangePassword);
    
    changePasswordModal.querySelector('.modal-close-btn').addEventListener('click', () => {
        changePasswordModal.style.display = 'none';
        changePasswordForm.reset();
        changePasswordMessage.textContent = '';
    });
    
    window.addEventListener('click', (event) => {
        if (event.target == changePasswordModal) {
            changePasswordModal.style.display = "none";
            changePasswordForm.reset();
            changePasswordMessage.textContent = '';
        }
    });
    
    // --- END: Auth & Login/Logout Logic ---


    // --- START: Main Application Logic ---
    const contractorModal = document.getElementById('contractor-modal');
    const manageContractorsBtn = document.getElementById('manage-contractors-btn');
    const addContractorForm = document.getElementById('add-contractor-form');
    const contractorListDiv = document.getElementById('contractor-list');
    const mainContractorSelect = document.getElementById('contractor-details-input');
    const getContractors = () => JSON.parse(localStorage.getItem(LS_CONTRACTOR_KEY) || '[]');
    const saveContractors = (contractors) => localStorage.setItem(LS_CONTRACTOR_KEY, JSON.stringify(contractors));
    const renderContractors = () => {
        const contractors = getContractors();
        contractorListDiv.innerHTML = '<ul>' + contractors.map((c, index) => `<li><div><strong>${c.name}</strong><br><small>${c.address} | GST: ${c.gst} | PAN: ${c.pan}</small></div><button class="delete-btn" data-index="${index}">Delete</button></li>`).join('') + '</ul>';
        const selectedValue = mainContractorSelect.value;
        mainContractorSelect.innerHTML = '';
        if (contractors.length === 0) { mainContractorSelect.innerHTML = `<option value="">-- No payees saved --</option>`; } else {
            mainContractorSelect.innerHTML = `<option value="" disabled selected>-- Select Payee --</option>`;
            contractors.forEach(c => { const fullDetails = `${c.name}, ${c.address} (GST: ${c.gst}, PAN: ${c.pan})`; mainContractorSelect.innerHTML += `<option value="${fullDetails}">${c.name}</option>`; });
            mainContractorSelect.value = selectedValue;
            if (!mainContractorSelect.value) mainContractorSelect.selectedIndex = 0;
        }
        mainContractorSelect.disabled = !data || document.getElementById('report-type-select').value === 'non-work';
    };
    manageContractorsBtn.onclick = () => { contractorModal.style.display = 'block'; };
    addContractorForm.addEventListener('submit', (e) => { e.preventDefault(); const c = getContractors(); c.push({name: document.getElementById('new-contractor-name').value.trim(), address: document.getElementById('new-contractor-address').value.trim(), gst: document.getElementById('new-contractor-gst').value.trim(), pan: document.getElementById('new-contractor-pan').value.trim()}); saveContractors(c); renderContractors(); addContractorForm.reset(); });
    contractorListDiv.addEventListener('click', (e) => { if (e.target.classList.contains('delete-btn')) { if (confirm('Are you sure?')) { const c = getContractors(); c.splice(e.target.dataset.index, 1); saveContractors(c); renderContractors(); } } });

    const agreementModal = document.getElementById('agreement-modal');
    const manageAgreementsBtn = document.getElementById('manage-agreements-btn');
    const addAgreementForm = document.getElementById('add-agreement-form');
    const agreementListDiv = document.getElementById('agreement-list');
    const getAgreements = () => JSON.parse(localStorage.getItem(LS_AGREEMENT_KEY) || '[]');
    const saveAgreements = (agreements) => localStorage.setItem(LS_AGREEMENT_KEY, JSON.stringify(agreements));
    const renderAgreements = () => { const agreements = getAgreements(); agreementListDiv.innerHTML = '<ul>' + agreements.map((a, index) => `<li><div><strong>Est No:</strong> ${a.estimateId}<br><small><strong>Agreement:</strong> ${a.agreementNo} | <strong>Work Order:</strong> ${a.workOrder}</small></div><button class="delete-btn" data-index="${index}">Delete</button></li>`).join('') + '</ul>'; };
    manageAgreementsBtn.onclick = () => { agreementModal.style.display = 'block'; };
    addAgreementForm.addEventListener('submit', (e) => { e.preventDefault(); const a = getAgreements(); a.push({ estimateId: document.getElementById('new-agreement-estimate').value.trim(), agreementNo: document.getElementById('new-agreement-no').value.trim(), workOrder: document.getElementById('new-agreement-workorder').value.trim() }); saveAgreements(a); renderAgreements(); addAgreementForm.reset(); });
    agreementListDiv.addEventListener('click', (e) => { if (e.target.classList.contains('delete-btn')) { if (confirm('Are you sure?')) { const a = getAgreements(); a.splice(e.target.dataset.index, 1); saveAgreements(a); renderAgreements(); } } });

    const savedReportsModal = document.getElementById('saved-reports-modal');
    const manageSavedReportsBtn = document.getElementById('manage-saved-reports-btn');
    const savedReportsListDiv = document.getElementById('saved-reports-list');
    const getSvrCounters = () => JSON.parse(localStorage.getItem(LS_SVR_NO_KEY) || '{}');
    const saveSvrCounters = (counters) => localStorage.setItem(LS_SVR_NO_KEY, JSON.stringify(counters));
    const getSavedReports = () => JSON.parse(localStorage.getItem(LS_SAVED_REPORTS_KEY) || '[]');
    const saveSavedReports = (reports) => localStorage.setItem(LS_SAVED_REPORTS_KEY, JSON.stringify(reports));

    const renderSavedReports = () => {
        const reports = getSavedReports();
        if (reports.length === 0) { savedReportsListDiv.innerHTML = '<p>No saved reports found.</p>'; return; }
        savedReportsListDiv.innerHTML = '<ul>' + reports.map(report => `
            <li>
                <div style="flex-grow: 1; margin-right: 10px;">
                    <strong>${report.mainHeader || report.title}</strong><br>
                    <small>
                        Budget Head: ${report.budgetHead || 'N/A'}<br>
                        Scheme: ${report.schemeName || 'N/A'}<br>
                        Svr Nos: ${(report.svrNumbersUsed || []).join(', ')}<br>
                        <strong>Total: ${report.grandTotal ? `Rs. ${Math.round(report.grandTotal).toLocaleString('en-IN')}/-` : 'N/A'}</strong>
                    </small>
                </div>
                <div>
                    <button class="view-btn" data-id="${report.id}">View/Edit</button>
                    <button class="delete-btn" data-id="${report.id}">Delete</button>
                </div>
            </li>`).join('') + '</ul>';
    };

    manageSavedReportsBtn.onclick = () => { renderSavedReports(); savedReportsModal.style.display = 'block'; };

    savedReportsListDiv.addEventListener('click', (e) => {
        const target = e.target; const reportId = target.dataset.id; if (!reportId) return;
        if (target.classList.contains('delete-btn')) {
            if (confirm('Are you sure you want to delete this saved report? This will adjust the SVr, no. counter for its scheme.')) {
                let reports = getSavedReports(); const reportToDelete = reports.find(r => r.id == reportId); if (!reportToDelete) return; const schemeNameToUpdate = reportToDelete.schemeName;
                reports = reports.filter(r => r.id != reportId); saveSavedReports(reports);
                const remainingReportsForScheme = reports.filter(r => r.schemeName === schemeNameToUpdate); let newMaxSvrNo = 0;
                if (remainingReportsForScheme.length > 0) { newMaxSvrNo = Math.max(0, ...remainingReportsForScheme.flatMap(r => r.svrNumbersUsed || [])); }
                const svrCounters = getSvrCounters(); svrCounters[schemeNameToUpdate] = newMaxSvrNo; saveSvrCounters(svrCounters);
                renderSavedReports(); updateTokenDropdown();
                alert(`Report deleted. SVr, no. counter for scheme "${schemeNameToUpdate}" has been updated to ${newMaxSvrNo}.`);
            }
        } else if (target.classList.contains('view-btn')) {
            const reports = getSavedReports(); const reportToLoad = reports.find(r => r.id == reportId);
            if (reportToLoad) { loadReportState(reportToLoad); savedReportsModal.style.display = 'none'; }
        }
    });

    function loadReportState(report) {
        currentEditingReportId = report.id;
        currentReportVouchers = report.vouchersData || [];
        currentReportParameters = report.inputs || {};
        
        const { reportType, tokenNo, rfoName, division, subDivision, k2BillNoDate, taxes, tenderData, gstData, agreementData, workOrderData, contractorDetails, nonWorkPayees, schemeName, budgetHead } = currentReportParameters;

        const reportHtml = renderReportHtmlFromData(currentReportVouchers, {
            ...currentReportParameters
        });
        document.getElementById('report-output').innerHTML = reportHtml;
        addEditEventListeners();
        document.getElementById('print-report-btn').style.display = 'inline-flex';
        document.getElementById('save-edits-btn').style.display = 'inline-flex';
        document.getElementById('view-payee-ledger-btn').style.display = 'inline-flex';


        document.getElementById('report-type-select').value = reportType;
        document.getElementById('rfo-name-input').value = rfoName;
        document.getElementById('division-input').value = division;
        document.getElementById('sub-division-input').value = subDivision;
        document.getElementById('k2-bill-input').value = k2BillNoDate;
        document.getElementById('it-percent-input').value = taxes.itPercent;
        document.getElementById('cgst-percent-input').value = taxes.cgstPercent || 0;
        document.getElementById('sgst-percent-input').value = taxes.sgstPercent || 0;
        document.getElementById('royalty-percent-input').value = taxes.royaltyPercent;
        document.getElementById('labour-cess-input').value = taxes.labourCessPercent;
        
        let tokenInput = document.getElementById('token-input');
        tokenInput.value = tokenNo;

        capturedAgreementData = { agreement: agreementData, workOrder: workOrderData };

        setTimeout(() => {
            document.getElementById('status-message').textContent = `Loaded saved report: ${report.title}. You can now edit certain fields.`;
            document.getElementById('status-message').style.color = 'blue';
        }, 200);

        if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) {
            document.getElementById('contractor-details-input').value = contractorDetails;
        }
    }


    const allTokensModal = document.getElementById('all-tokens-modal');
    const viewAllTokensBtn = document.getElementById('view-all-tokens-btn');
    const allTokensListDiv = document.getElementById('all-tokens-list');
    const saveTreasuryBtn = document.getElementById('save-treasury-btn');
    const cashbookFilterContainer = document.getElementById('cashbook-filter-container');
    const getTreasuryData = () => JSON.parse(localStorage.getItem(LS_TREASURY_DATA_KEY) || '{}');
    const saveTreasuryData = (data) => localStorage.setItem(LS_TREASURY_DATA_KEY, JSON.stringify(data));

    function renderAllTokensList() {
        const savedReports = getSavedReports();
        const treasuryData = getTreasuryData();

        // Find all IDs of reports that have been merged into another report.
        const mergedOriginalIds = new Set(
            savedReports.flatMap(r => r.inputs.originalReportIds || [])
        );

        // Filter the reports to show only standalone reports or the final merged/edited reports.
        const reportsToShow = savedReports.filter(report => !mergedOriginalIds.has(String(report.id)));

        if (reportsToShow.length === 0) {
            allTokensListDiv.innerHTML = '<p>No saved reports found. Please generate and save a report first.</p>';
            cashbookFilterContainer.innerHTML = '';
            return;
        }
        
        let listHtml = '<ul>';
        reportsToShow.forEach(report => {
            const tokenNo = report.inputs.tokenNo;
            const savedInfo = treasuryData[tokenNo] || { vrNo: '', date: '' };
            const isMerged = report.inputs.originalReportIds && report.inputs.originalReportIds.length > 0;
            const statusLabel = isMerged 
                ? `<span style="color: #9b59b6; font-weight: bold;">[MERGED]</span>`
                : `<span style="color: red; font-weight: bold;">[SAVED]</span>`;

            listHtml += `
                <li>
                    <div style="width:100%;">
                        <strong>Token: ${tokenNo}</strong> ${statusLabel}<br>
                        <small>Scheme: ${report.schemeName || 'N/A'}<br>
                               Budget Head: ${report.budgetHead || 'N/A'}<br>
                               <strong>Total Amount: Rs. ${Math.round(report.grandTotal || 0).toLocaleString('en-IN')}/-</strong>
                        </small>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <label for="vr-${tokenNo}" style="font-weight: bold; font-size: 0.9em;">Treasury W.No:</label>
                            <input type="text" id="vr-${tokenNo}" class="treasury-vr-input" data-token="${tokenNo}" value="${savedInfo.vrNo}" style="padding: 5px; flex-grow: 1; max-width: 200px;">
                            <label for="date-${tokenNo}" style="font-weight: bold; font-size: 0.9em;">Date:</label>
                            <input type="date" id="date-${tokenNo}" class="treasury-date-input" data-token="${tokenNo}" value="${savedInfo.date}" style="padding: 5px;">
                        </div>
                    </div>
                </li>`;
        });
        listHtml += '</ul>';
        allTokensListDiv.innerHTML = listHtml;

        const uniqueSchemes = [...new Set(reportsToShow.map(r => r.schemeName))];
        const currentYear = new Date().getFullYear();
        let filterHtml = `
            <div class="cashbook-filter-controls">
                <label for="cb-month">Month:</label>
                <select id="cb-month">
                    <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option>
                    <option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option>
                    <option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
                <label for="cb-year">Year:</label>
                <input type="number" id="cb-year" value="${currentYear}" style="width: 80px;">
                <label for="cb-scheme">Scheme:</label>
                <select id="cb-scheme">
                    <option value="all">All Schemes</option>
                    ${uniqueSchemes.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
                <button id="print-cashbook-btn">Generate & Print Cashbook</button>
            </div>`;
        cashbookFilterContainer.innerHTML = filterHtml;
        document.getElementById('print-cashbook-btn').addEventListener('click', generateAndPrintCashbook);
    }
    
    function generateAndPrintCashbook() {
        const allSavedReports = getSavedReports();
        if (!allSavedReports || allSavedReports.length === 0) {
            alert("No saved reports available.");
            return;
        }

        const selectedMonth = document.getElementById('cb-month').value;
        const selectedYear = document.getElementById('cb-year').value;
        const selectedScheme = document.getElementById('cb-scheme').value;
        const treasuryData = getTreasuryData();

        const filteredReports = allSavedReports.filter(report => {
            const reportDateStr = treasuryData[report.inputs.tokenNo]?.date;
            if (!reportDateStr) return false;
            const reportDate = new Date(reportDateStr);
            const monthMatch = (reportDate.getMonth() + 1) == selectedMonth;
            const yearMatch = reportDate.getFullYear() == selectedYear;
            const schemeMatch = (selectedScheme === 'all') || (report.schemeName === selectedScheme);
            return monthMatch && yearMatch && schemeMatch;
        });

        if (filteredReports.length === 0) {
            alert("No saved reports found for the selected month, year, and scheme.");
            return;
        }

        const roundToRupee = (num) => Math.round(num);

        const numberToWords = (num) => {
            num = roundToRupee(num);
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            if ((num = num.toString()).length > 9) return 'overflow';
            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim().replace(/\s+/g, ' ').toUpperCase() + ' RUPEES ONLY';
        };

        const rfoNameValue = document.getElementById('rfo-name-input').value || 'Range Forest Officer';
        const rangeName = (filteredReports[0]?.inputs?.rangeName || 'Shiralakoppa Range');
        const monthName = new Date(selectedYear, selectedMonth - 1).toLocaleString('default', { month: 'long' });
        const monthYear = `${monthName}-${selectedYear}`;

        let crSideRows = '';
        let drSideRows = [];
        let expenditureAbstract = {};
        let deductionAbstract = { tender: 0, it: 0, labour: 0, cgst: 0, sgst: 0, royalty: 0 };
        let totalCredit = 0;
        let totalDebit = 0;

        filteredReports.sort((a, b) => {
             const dateA = new Date(treasuryData[a.inputs.tokenNo]?.date);
             const dateB = new Date(treasuryData[b.inputs.tokenNo]?.date);
             return dateA - dateB;
        });
        
        filteredReports.forEach((report, index) => {
            const tokenTreasuryInfo = treasuryData[report.inputs.tokenNo] || { vrNo: '', date: '' };
            const formattedDate = tokenTreasuryInfo.date ? new Date(tokenTreasuryInfo.date).toLocaleDateString('en-GB') : 'N/A';
            const creditAmount = report.grandTotalBeforeTax || 0;
            totalCredit += creditAmount;
            
            crSideRows += `
                <tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td contenteditable="true">By an Amount Received from Deputy conservator of forest Sagar division, Sagar towards through DC.Bill No. ${report.inputs.k2BillNoDate || 'N/A'} Token No.${report.inputs.tokenNo}/${formattedDate}</td>
                    <td class="amount">${roundToRupee(creditAmount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                </tr>`;
        });

        let drSlNoCounter = 1;
        filteredReports.forEach((report) => {
            const tokenTreasuryInfo = treasuryData[report.inputs.tokenNo] || { vrNo: '', date: '' };
            const formattedDate = tokenTreasuryInfo.date ? new Date(tokenTreasuryInfo.date).toLocaleDateString('en-GB') : 'N/A';

            report.vouchersData.sort((a,b) => a.svrNo - b.svrNo).forEach(voucher => {
                let voucherRows = [];
                let voucherGrossTotal = 0;
                let voucherNetAfterTender = 0;
                
                const headerContent = `<div contenteditable="true" style="font-weight:bold;">Vr.No: ${voucher.svrNo}</div>` + voucher.items[0].finalParticularsText.split('<br><br>')[0];
                voucherRows.push({ type: 'header', content: headerContent });
                
                voucher.items.forEach(item => {
                    const roundedGrossAmount = Math.round(item.expenditureAmount);
                    voucherGrossTotal += roundedGrossAmount;

                    const tenderPercent = (report.inputs.tenderData[item.estimate.id] !== undefined) ? report.inputs.tenderData[item.estimate.id] : 0;
                    const itemTenderDeduction = (roundedGrossAmount * tenderPercent) / 100;
                    const roundedItemTenderDeduction = Math.round(itemTenderDeduction);
                    
                    voucherNetAfterTender += (roundedGrossAmount - roundedItemTenderDeduction);

                    const workContent = item.finalParticularsText.split('<br><br>')[1] || item.particularsTextSnapshot || '';
                     voucherRows.push({
                        type: 'item',
                        content: workContent,
                        amount: item.expenditureAmount,
                        quantity: item.quantitySnapshot,
                        rate: item.rateSnapshot,
                        timesday: item.timesdaySnapshot,
                        unit: item.unitSnapshot,
                        per: item.perSnapshot,
                        fullItem: item,
                        report: report
                    });
                });
                
                const tenderDeductionTotalForDisplay = voucherGrossTotal - voucherNetAfterTender;
                
                const gstData = report.inputs.gstData || {cgst: 0, sgst: 0};
                let addCgstAmount = 0;
                let addSgstAmount = 0;
                
                let applyGst = true;
                if(report.inputs.reportType === 'timber' && voucher.isEngagingVoucher) {
                    applyGst = false;
                }

                if(applyGst) {
                    addCgstAmount = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                    addSgstAmount = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                }
                
                const subTotalForDeductions = voucherNetAfterTender + addCgstAmount + addSgstAmount;
                
                const taxes = report.inputs.taxes;
                const itDeduct = Math.round((subTotalForDeductions * taxes.itPercent) / 100);
                const labourDeduct = Math.round((subTotalForDeductions * taxes.labourCessPercent) / 100);
                const cgstDeduct = Math.round((voucherNetAfterTender * taxes.cgstPercent) / 100);
                const sgstDeduct = Math.round((voucherNetAfterTender * taxes.sgstPercent) / 100);
                
                let royaltyDeduct = 0;
                if (report.inputs.manualRoyaltyData && report.inputs.manualRoyaltyData.total > 0) {
                     const reportGrandTotal = report.grandTotalBeforeTax || 1;
                     royaltyDeduct = Math.round((subTotalForDeductions / reportGrandTotal) * report.inputs.manualRoyaltyData.total);
                } else {
                     royaltyDeduct = Math.round((subTotalForDeductions * taxes.royaltyPercent) / 100);
                }
                
                const netPayable = subTotalForDeductions - (itDeduct + labourDeduct + cgstDeduct + sgstDeduct + royaltyDeduct);

                voucherRows.push({ type: 'summary', gross: voucherGrossTotal, tender: tenderDeductionTotalForDisplay, addCgst: addCgstAmount, addSgst: addSgstAmount, netBill: subTotalForDeductions, it: itDeduct, labour: labourDeduct, cgst: cgstDeduct, sgst: sgstDeduct, royalty: royaltyDeduct, netPayable: netPayable });
                
                totalDebit += netPayable;
                deductionAbstract.tender += tenderDeductionTotalForDisplay;
                deductionAbstract.it += itDeduct;
                deductionAbstract.labour += labourDeduct;
                deductionAbstract.cgst += cgstDeduct;
                deductionAbstract.sgst += sgstDeduct;
                deductionAbstract.royalty += royaltyDeduct;
                
                const budgetKey = `${report.budgetHead} - ${report.schemeName}`;
                if (!expenditureAbstract[budgetKey]) {
                    expenditureAbstract[budgetKey] = { gross: 0, net: 0 };
                }
                expenditureAbstract[budgetKey].gross += subTotalForDeductions;
                expenditureAbstract[budgetKey].net += netPayable;
                
                drSideRows.push({
                    slNo: drSlNoCounter++,
                    date: formattedDate,
                    rows: voucherRows,
                    budget: `${report.budgetHead}<br><small>(${report.schemeName})</small>`
                });
            });
        });
        
        let drHtml = '';
        let royaltyChartAddedToCashbook = false;
        const formatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        drSideRows.forEach(vr => {
            const rowCount = vr.rows.length;
            vr.rows.forEach((row, index) => {
                drHtml += '<tr>';
                if (index === 0) {
                    drHtml += `<td style="text-align:center;" rowspan="${rowCount}">${vr.slNo}</td>`;
                    drHtml += `<td rowspan="${rowCount}">${vr.date}</td>`;
                }
                
                if(row.type === 'header') {
                    drHtml += `<td contenteditable="true" colspan="6">${row.content}</td><td></td>`;
                } else if (row.type === 'item') {
                    let itemChartHtml = '';
                    const item = row.fullItem;
                    const report = row.report;
                    const particularsTextLower = item.particularsTextSnapshot.toLowerCase();

                    // Check for Purchase Chart
                    if (item.purchaseDetails && (particularsTextLower.includes('purchase') || particularsTextLower.includes('cost of'))) {
                        const { original, cgst, sgst } = item.purchaseDetails;
                        const originalAmount = parseFloat(original) || 0;
                        const cgstAmount = originalAmount * (parseFloat(cgst) / 100);
                        const sgstAmount = originalAmount * (parseFloat(sgst) / 100);
                        const total = originalAmount + cgstAmount + sgstAmount;
                        itemChartHtml += `<div class="purchase-calculation-chart" style="margin-left: 20px; padding: 8px; border: 1px dashed #555; margin-top: 8px; font-size: 0.9em; background-color: #f0f8ff;">
                            <strong style="text-decoration: underline;">Purchase Calculation:</strong>
                            <table style="width: auto; margin-top: 5px; border: none; font-size: 0.95em;">
                                <tbody>
                                    <tr style="border: none;"><td style="border: none; padding: 2px 8px;">Original Bill Amount:</td><td class="amount" style="border: none; padding: 2px 8px;">${roundToRupee(originalAmount).toLocaleString('en-IN', formatOptions)}</td></tr>
                                    <tr style="border: none;"><td style="border: none; padding: 2px 8px;">CGST (${parseFloat(cgst).toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${roundToRupee(cgstAmount).toLocaleString('en-IN', formatOptions)}</td></tr>
                                    <tr style="border: none;"><td style="border: none; padding: 2px 8px;">SGST (${parseFloat(sgst).toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${roundToRupee(sgstAmount).toLocaleString('en-IN', formatOptions)}</td></tr>
                                    <tr style="border: none; font-weight: bold; border-top: 1px solid #999;"><td style="border: none; padding: 4px 8px 2px;">Total:</td><td class="amount" style="border: none; padding: 4px 8px 2px;">${roundToRupee(total).toLocaleString('en-IN', formatOptions)}</td></tr>
                                </tbody>
                            </table>
                        </div>`;
                    }

                    // Check for Royalty Chart
                    const manualRoyaltyData = report.inputs.manualRoyaltyData;
                    if (!royaltyChartAddedToCashbook && manualRoyaltyData && manualRoyaltyData.total > 0 && (particularsTextLower.includes('sand') || particularsTextLower.includes('red earth') || particularsTextLower.includes('redearth'))) {
                        const sandTotal = manualRoyaltyData.sandQty * manualRoyaltyData.sandRate;
                        const redearthTotal = manualRoyaltyData.redearthQty * manualRoyaltyData.redearthRate;
                        const totalRoyalty = sandTotal + redearthTotal;

                        itemChartHtml += `<div class="royalty-calculation-chart" style="margin-left: 20px; padding: 8px; border: 1px dashed #555; margin-top: 8px; font-size: 0.9em; background-color: #f9f9f9;">
                            <strong style="text-decoration: underline;">Royalty Calculation Details (for Report):</strong>
                            <table style="width: auto; margin-top: 5px; border: none; font-size: 0.95em;">
                                <tbody>
                                    ${manualRoyaltyData.sandQty > 0 ? `
                                    <tr style="border: none;">
                                        <td style="border: none; padding: 2px 8px;">${manualRoyaltyData.sandQty.toFixed(2)} cum. of Sand</td>
                                        <td style="border: none; padding: 2px 8px;">x ${manualRoyaltyData.sandRate.toFixed(2)}/-</td>
                                        <td style="border: none; padding: 2px 8px; text-align: right;">= ${roundToRupee(sandTotal).toLocaleString('en-IN', formatOptions)}/-</td>
                                    </tr>` : ''}
                                    ${manualRoyaltyData.redearthQty > 0 ? `
                                    <tr style="border: none;">
                                        <td style="border: none; padding: 2px 8px;">${manualRoyaltyData.redearthQty.toFixed(2)} cum of Redearth</td>
                                        <td style="border: none; padding: 2px 8px;">x ${manualRoyaltyData.redearthRate.toFixed(2)}/-</td>
                                        <td style="border: none; padding: 2px 8px; text-align: right;">= ${roundToRupee(redearthTotal).toLocaleString('en-IN', formatOptions)}/-</td>
                                    </tr>` : ''}
                                    <tr style="border: none; font-weight: bold; border-top: 1px solid #999;">
                                        <td style="border: none; padding: 4px 8px 2px;" colspan="2">Total Report Royalty:</td>
                                        <td style="border: none; padding: 4px 8px 2px; text-align: right;">= ${roundToRupee(totalRoyalty).toLocaleString('en-IN', formatOptions)}/-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>`;
                        royaltyChartAddedToCashbook = true;
                    }


                    drHtml += `<td contenteditable="true" style="padding-left: 20px;">${row.content}${itemChartHtml}</td>`;
                    drHtml += `<td class="amount">${row.quantity !== undefined ? parseFloat(row.quantity.toFixed(3)) : ''}</td>`;
                    drHtml += `<td class="amount">${row.rate !== undefined ? row.rate.toFixed(2) : ''}</td>`;
                    drHtml += `<td class="amount">${row.timesday !== undefined ? row.timesday : ''}</td>`;
                    drHtml += `<td style="text-align:center;">${row.unit || ''}</td>`;
                    drHtml += `<td class="amount">${row.per !== undefined ? row.per : ''}</td>`;
                    drHtml += `<td class="amount">${roundToRupee(row.amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                } else if (row.type === 'summary') {
                     let summaryHtml = `<strong>${roundToRupee(row.gross).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong><br>`;
                    if (row.tender > 0) summaryHtml += `(Less Tender: ${roundToRupee(row.tender).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.addCgst > 0) summaryHtml += `(Add CGST: ${roundToRupee(row.addCgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.addSgst > 0) summaryHtml += `(Add SGST: ${roundToRupee(row.addSgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    summaryHtml += `<hr style="border:none; border-top: 1px solid black; margin: 2px 0;">`;
                    summaryHtml += `<strong contenteditable="true">Net Bill: ${roundToRupee(row.netBill).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong><br>`;
                    if (row.it > 0) summaryHtml += `(Less IT: ${roundToRupee(row.it).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.labour > 0) summaryHtml += `(Less Labour: ${roundToRupee(row.labour).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.cgst > 0) summaryHtml += `(Less CGST: ${roundToRupee(row.cgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.sgst > 0) summaryHtml += `(Less SGST: ${roundToRupee(row.sgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    if (row.royalty > 0) summaryHtml += `(Less Royalty: ${roundToRupee(row.royalty).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br>`;
                    summaryHtml += `<hr style="border:none; border-top: 1px solid black; margin: 2px 0;"><strong>${roundToRupee(row.netPayable).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
                    
                    drHtml += `<td colspan="6"></td><td class="amount" style="line-height: 1.6;">${summaryHtml}</td>`;
                }

                if (index === 0) {
                    drHtml += `<td contenteditable="true" rowspan="${rowCount}" style="border-left: 2px solid black; border-right: 2px solid black;">${vr.budget}</td>`;
                }
                drHtml += '</tr>';
            });
        });
        
        let expenditureAbstractRows = '';
        Object.keys(expenditureAbstract).forEach(key => {
            expenditureAbstractRows += `
                <tr>
                    <td>${key}</td>
                    <td class="amount">${roundToRupee(expenditureAbstract[key].gross).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="amount">${roundToRupee(expenditureAbstract[key].net).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                </tr>`;
        });
        
        let roundedTotalCredit = roundToRupee(totalCredit);
        let roundedTotalDebit = roundToRupee(totalDebit);
        let closingBalance = roundedTotalCredit - roundedTotalDebit;

        let cashbookHtml = `
            <!DOCTYPE html><html><head><title>Cashbook - ${monthYear}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .report-container { width: 100%; }
                .header { text-align: center; margin-bottom: 20px; }
                h2, h3 { margin: 5px 0; font-weight: bold; }
                .cashbook-page {
                    page-break-after: always;
                    border: 2px solid black;
                    padding: 15px;
                    margin-bottom: 15px;
                }
                .cashbook-page:last-child { page-break-after: avoid; }
                .cashbook-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8em; }
                .cashbook-table th, .cashbook-table td { border: 1px solid black; padding: 4px; vertical-align: top; word-wrap: break-word;}
                .cashbook-table th { font-weight: bold; text-align: center; background-color: #f2f2f2; }
                td.amount { text-align: right; }
                .abstract-container { margin-top: 40px; display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
                .abstract-table { width: 48%; border-collapse: collapse; }
                .abstract-table h4 { text-align: center; }
                .abstract-table th, .abstract-table td { border: 1px solid black; padding: 5px; }
                .grand-total-words { margin-top: 20px; font-weight: bold; }
                .signature { margin-top: 60px; text-align: right; font-weight: bold; }
                .no-print { position: fixed; bottom: 10px; right: 10px; z-index: 100; padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;}
                 @media print {
                    @page { size: A4 Portrait; margin: 0.5in; }
                    body { margin: 0; font-size: 0.8em;}
                    .cashbook-page { border: 2px solid black; padding: 0.25in; margin: 0; }
                    .no-print { display: none; }
                    [contenteditable="true"] { border: none !important; background-color: transparent !important; }
                }
            </style>
            </head><body>
                <div class="report-container">
                    <div class="cashbook-page">
                        <div class="header">
                            <h2>Cash Book for the Month of ${monthYear}</h2>
                            <h3>Cash book of ${rfoNameValue}, ${rangeName}</h3>
                        </div>
                        <table class="cashbook-table">
                            <thead><tr><th colspan="4" style="background-color: #d3d3d3;">CR. SIDE (Receipts)</th></tr>
                                <tr>
                                    <th style="width:5%;">Sl.No</th>
                                    <th style="width:15%;">Date</th>
                                    <th>Particulars</th>
                                    <th style="width:20%;" class="amount">Amount</th>
                                </tr>
                            </thead>
                            <tbody>${crSideRows}</tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right; font-weight:bold;">Total Credit:</td>
                                    <td class="amount" style="font-weight:bold;">${roundedTotalCredit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="font-style: italic;">In Words: ${numberToWords(roundedTotalCredit)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="cashbook-page">
                         <div class="header">
                            <h2>Cash Book for the Month of ${monthYear}</h2>
                            <h3>Cash book of ${rfoNameValue}, ${rangeName}</h3>
                        </div>
                        <table class="cashbook-table">
                            <thead>
                                <tr><th colspan="10" style="background-color: #d3d3d3;">DR. SIDE (Payments)</th></tr>
                                <tr>
                                    <th style="width:3%;">Sl.No</th>
                                    <th style="width:7%;">Date</th>
                                    <th style="width:25%;">Particulars</th>
                                    <th style="width:5%;">Qty</th>
                                    <th style="width:5%;">Rate</th>
                                    <th style="width:5%;">Time/Day</th>
                                    <th style="width:5%;">Unit</th>
                                    <th style="width:5%;">Per</th>
                                    <th style="width:15%;" class="amount">Amount</th>
                                    <th style="width:25%; border-left: 2px solid black; border-right: 2px solid black;">Budget Head/Scheme</th>
                                </tr>
                            </thead>
                            <tbody>${drHtml}</tbody>
                             <tfoot>
                                <tr>
                                    <td colspan="9" style="text-align:right; font-weight:bold;">Total Debit:</td>
                                    <td class="amount" style="font-weight:bold;">${roundedTotalDebit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="cashbook-page">
                         <div class="header"><h3>Abstracts for ${monthYear}</h3></div>
                         <div class="abstract-container">
                            <div class="abstract-table">
                                <h4 style="text-align:center;">Expenditure Abstract</h4>
                                <table>
                                    <thead><th>Budget Head - Scheme</th><th class="amount">Gross Amount</th><th class="amount">Net Amount</th></thead>
                                    <tbody>${expenditureAbstractRows}</tbody>
                                </table>
                            </div>
                            <div class="abstract-table">
                                 <h4 style="text-align:center;">Deductions Abstract</h4>
                                 <table>
                                    <thead><th>Deduction Type</th><th class="amount">Amount</th></thead>
                                    <tbody>
                                        <tr><td>Tender Deduction</td><td class="amount">${roundToRupee(deductionAbstract.tender).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                        <tr><td>IT Deduction</td><td class="amount">${roundToRupee(deductionAbstract.it).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                        <tr><td>Labour Cess</td><td class="amount">${roundToRupee(deductionAbstract.labour).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                        <tr><td>CGST Deduction</td><td class="amount">${roundToRupee(deductionAbstract.cgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                        <tr><td>SGST Deduction</td><td class="amount">${roundToRupee(deductionAbstract.sgst).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                        <tr><td>Royalty Deduction</td><td class="amount">${roundToRupee(deductionAbstract.royalty).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                    </tbody>
                                    <tfoot>
                                        <tr><td style="font-weight:bold;">Total Deductions</td><td class="amount" style="font-weight:bold;">${roundToRupee(Object.values(deductionAbstract).reduce((a, b) => a + b, 0)).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                                    </tfoot>
                                 </table>
                            </div>
                        </div>
                        <div style="margin-top: 30px; border-top: 2px solid black; padding-top: 15px;">
                            <p class="grand-total-words">Grand Total Credit: ${roundedTotalCredit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ( ${numberToWords(roundedTotalCredit)} )</p>
                            <p class="grand-total-words">Grand Total Debit: ${roundedTotalDebit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ( ${numberToWords(roundedTotalDebit)} )</p>
                            <h3 style="margin-top: 20px;">Closing Balance:(Excluding Tender Deduction amount) ${closingBalance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                        </div>
                        <div class="signature"><p>${rfoNameValue}<br>${rangeName}</p></div>
                    </div>
                </div>
                <button class="no-print" onclick="window.print()">Print Cashbook</button>
            </body></html>`;

        const printWindow = window.open('', '_blank');
        if (printWindow) {
            printWindow.document.open();
            printWindow.document.write(cashbookHtml);
            printWindow.document.close();
            printWindow.focus();
        } else {
            alert("Could not open a new window. Please check your pop-up blocker settings.");
        }
    }


    viewAllTokensBtn.addEventListener('click', () => { renderAllTokensList(); allTokensModal.style.display = 'block'; });
    saveTreasuryBtn.addEventListener('click', () => {
        const treasuryData = getTreasuryData();
        const vrInputs = document.querySelectorAll('.treasury-vr-input');
        vrInputs.forEach(input => {
            const tokenNo = input.dataset.token;
            const dateInput = document.querySelector(`.treasury-date-input[data-token="${tokenNo}"]`);
            const vrValue = input.value.trim(); const dateValue = dateInput.value;
            if (vrValue || dateValue) { treasuryData[tokenNo] = { vrNo: vrValue, date: dateValue }; } else { delete treasuryData[tokenNo]; }
        });
        saveTreasuryData(treasuryData);
        alert('Treasury details saved successfully!');
        allTokensModal.style.display = 'none';
    });
    
    const selectedVoucherModal = document.getElementById('selected-voucher-modal');
    const selectedVoucherOkBtn = document.getElementById('selected-voucher-ok-btn');

    selectedVoucherOkBtn.addEventListener('click', () => {
        const selectedType = document.querySelector('input[name="voucher-type"]:checked');
        if (selectedType) {
            selectedVoucherSubType = selectedType.value;
        }
        selectedVoucherModal.style.display = 'none';
        statusMessage.textContent = `Selected form type: ${selectedVoucherSubType.toUpperCase()}. Please select a token.`;
        statusMessage.style.color = 'blue';
    });
    
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.onclick = () => {
            const modal = btn.closest('.modal-overlay');
            if (modal && modal.id !== 'change-password-modal') {
                if (modal.id === 'nonwork-payee-modal' && nonWorkPayees.length === 0) {
                    alert('Please enter and save payee details to continue. (ಮುಂದುವರೆಯಲು ದಯವಿಟ್ಟು ಪಾವತಿದಾರರ ವಿವರಗಳನ್ನು ನಮೂದಿಸಿ ಮತ್ತು ಉಳಿಸಿ.)');
                    return;
                }
                modal.style.display = 'none';
            }
        };
    });
    window.onclick = (event) => {
        if (event.target.classList.contains('modal-overlay') && event.target.id !== 'change-password-modal') {
            if (event.target.id === 'nonwork-payee-modal' && nonWorkPayees.length === 0) {
                alert('Please enter and save payee details to continue. (ಮುಂದುವರೆಯಲು ದಯವಿಟ್ಟು ಪಾವತಿದಾರರ ವಿವರಗಳನ್ನು ನಮೂದಿಸಿ ಮತ್ತು ಉಳಿಸಿ.)');
                return;
            }
            event.target.style.display = 'none';
        }
    };

    const nonWorkPayeeModal = document.getElementById('nonwork-payee-modal');
    const nonWorkPayeeInputContainer = document.getElementById('nonwork-payee-input-container');

    function showNonWorkPayeeModalForToken() {
        const tokenNo = document.getElementById('token-input').value;
        if (!tokenNo || !data) return;

        const relevantTransactions = data.estimates.flatMap(est => (est.balanceTransactions || []).map(bt => ({...bt, estimate: est}))).filter(bt => bt.tokenNo === tokenNo);
        
        if (relevantTransactions.length === 0) {
            alert('No transactions found for this token.');
            document.getElementById('token-input').value = '';
            return;
        }

        let tokenInfoHtml = '<h4>Token Details Summary</h4><div style="background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; max-height: 200px; overflow-y: auto;">';
        let totalAmountSpent = 0;
        const uniqueEstimates = {};

        relevantTransactions.forEach(tx => {
            totalAmountSpent += tx.expenditureAmount;
            const estId = tx.estimate.id;
            if (!uniqueEstimates[estId]) {
                uniqueEstimates[estId] = {
                    workName: tx.estimate.workName,
                    transactions: []
                };
            }
            const ssrItem = tx.estimate.ssrItems[tx.ssrItemIndex] || {};
            uniqueEstimates[estId].transactions.push({
                quantity: tx.quantitySnapshot,
                rate: ssrItem.rate,
                amount: tx.expenditureAmount,
                fnbMb: `${tx.fnbMbBookNumber || ''} / Page: ${tx.fnbMbPageNumber || ''}`
            });
        });

        tokenInfoHtml += `<p><strong>Token No:</strong> ${tokenNo}</p>`;
        tokenInfoHtml += `<p><strong>TOTAL AMOUNT SPENT (₹):</strong> ${Math.round(totalAmountSpent).toLocaleString('en-IN')}</p><hr>`;

        Object.keys(uniqueEstimates).forEach(estId => {
            tokenInfoHtml += `<p style="margin-bottom: 2px;"><strong>Est No:</strong> ${estId}<br><strong>Work:</strong> ${uniqueEstimates[estId].workName}</p>`;
            tokenInfoHtml += '<ul style="margin-top: 0; padding-left: 20px;">';
            uniqueEstimates[estId].transactions.forEach(t => {
                tokenInfoHtml += `<li style="font-size: 0.9em;">Qty: ${t.quantity}, Rate: ${t.rate}, Amount: ${Math.round(t.amount)}, FNB/MB: ${t.fnbMb}</li>`;
            });
            tokenInfoHtml += '</ul>';
        });

        tokenInfoHtml += '</div>';

        nonWorkPayees = [];
        let formHtml = tokenInfoHtml;
        formHtml += `<hr><h4>Enter Payee Details</h4><div class="modal-form"><label for="payee-count-input">Number of Payees:</label><input type="number" id="payee-count-input" min="1" value="1" style="width: 100px;"></div><button id="payee-count-submit-btn" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Next</button>`;
        
        nonWorkPayeeInputContainer.innerHTML = formHtml;
        nonWorkPayeeModal.style.display = 'block';

        document.getElementById('payee-count-submit-btn').onclick = () => {
            const count = parseInt(document.getElementById('payee-count-input').value, 10);
            if (count > 0) {
                showPayeeNameStepWithTokenInfo(count, tokenInfoHtml);
            } else {
                alert('Please enter a valid number of payees.');
            }
        };
    }

    function showPayeeNameStepWithTokenInfo(count, tokenInfoHtml) {
        let formHtml = tokenInfoHtml;
        formHtml += '<form id="nonwork-payee-name-form">';
        for (let i = 0; i < count; i++) {
            formHtml += `<div class="payee-entry-container" style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;"><div class="modal-form" style="grid-template-columns: auto 1fr; margin-bottom: 10px;"><label>Payee ${i + 1} Name:</label><input type="text" class="payee-name-input" placeholder="Name" required></div><div class="modal-form" style="grid-template-columns: repeat(5, 1fr); gap: 8px; align-items: center; margin-bottom: 5px;"><input type="number" class="payee-quantity-input" placeholder="Quantity" step="any" required><input type="number" class="payee-rate-input" placeholder="Rate" step="any" required><input type="number" class="payee-timesday-input" placeholder="Times/Day" value="1" step="any" required><input type="number" class="payee-per-input" placeholder="Per" value="1" step="any" required><input type="number" class="payee-amount-input" placeholder="Amount" readonly style="background-color: #e9ecef;"></div></div>`;
        }
        
        formHtml += `
            <hr><h4>Tax & Cess Deductions (%)</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <div>
                    <label for="nw-it-percent" style="font-weight:bold; font-size:13px;">IT%:</label>
                    <input type="number" id="nw-it-percent" value="1" step="0.1" style="width:100%; padding: 5px;">
                </div>
                <div>
                    <label for="nw-labour-cess" style="font-weight:bold; font-size:13px;">Labour%:</label>
                    <input type="number" id="nw-labour-cess" value="1" step="0.1" style="width:100%; padding: 5px;">
                </div>
                <div>
                    <label for="nw-cgst-percent" style="font-weight:bold; font-size:13px;">CGST%:</label>
                    <input type="number" id="nw-cgst-percent" value="1" step="0.1" style="width:100%; padding: 5px;">
                </div>
                <div>
                    <label for="nw-sgst-percent" style="font-weight:bold; font-size:13px;">SGST%:</label>
                    <input type="number" id="nw-sgst-percent" value="1" step="0.1" style="width:100%; padding: 5px;">
                </div>
                <div>
                    <label for="nw-royalty-percent" style="font-weight:bold; font-size:13px;">Royalty%:</label>
                    <input type="number" id="nw-royalty-percent" value="0" step="0.1" style="width:100%; padding: 5px;">
                </div>
            </div>
        `;

        formHtml += '<button type="submit" style="margin-top: 15px; padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Payees & Close</button></form>';
        
        nonWorkPayeeInputContainer.innerHTML = formHtml;
        
        document.querySelectorAll('.payee-entry-container').forEach(container => {
            const qtyInput = container.querySelector('.payee-quantity-input'); const rateInput = container.querySelector('.payee-rate-input'); const timesdayInput = container.querySelector('.payee-timesday-input'); const perInput = container.querySelector('.payee-per-input'); const amountInput = container.querySelector('.payee-amount-input');
            const calculateAmount = () => {
                const qty = parseFloat(qtyInput.value) || 0; const rate = parseFloat(rateInput.value) || 0; const timesday = parseFloat(timesdayInput.value) || 0; const per = parseFloat(perInput.value) || 0;
                if (per !== 0) { const calculatedAmount = (qty * rate * timesday) / per; amountInput.value = Math.round(calculatedAmount); } else { amountInput.value = 0; }
            };
            [qtyInput, rateInput, timesdayInput, perInput].forEach(input => input.addEventListener('input', calculateAmount));
        });

        document.getElementById('nonwork-payee-name-form').onsubmit = (e) => {
            e.preventDefault();
            nonWorkPayees = [];
            const entryContainers = document.querySelectorAll('.payee-entry-container');
            let allFilled = true;
            for (let i = 0; i < entryContainers.length; i++) {
                const container = entryContainers[i];
                const name = container.querySelector('.payee-name-input').value.trim(); const quantity = parseFloat(container.querySelector('.payee-quantity-input').value); const rate = parseFloat(container.querySelector('.payee-rate-input').value); const timesPerDay = parseFloat(container.querySelector('.payee-timesday-input').value); const per = parseFloat(container.querySelector('.payee-per-input').value); const amount = parseFloat(container.querySelector('.payee-amount-input').value);
                if (name && !isNaN(quantity) && !isNaN(rate) && !isNaN(timesPerDay) && !isNaN(per) && per !== 0 && !isNaN(amount)) {
                    nonWorkPayees.push({ name, quantity, rate, timesPerDay, per, amount });
                } else {
                    allFilled = false; break;
                }
            }
            if (allFilled) {
                document.getElementById('it-percent-input').value = document.getElementById('nw-it-percent').value;
                document.getElementById('labour-cess-input').value = document.getElementById('nw-labour-cess').value;
                document.getElementById('cgst-percent-input').value = document.getElementById('nw-cgst-percent').value;
                document.getElementById('sgst-percent-input').value = document.getElementById('nw-sgst-percent').value;
                document.getElementById('royalty-percent-input').value = document.getElementById('nw-royalty-percent').value;
                
                document.getElementById('nonwork-payee-modal').style.display = 'none';
                const statusMessage = document.getElementById('status-message');
                statusMessage.textContent = `${nonWorkPayees.length} payee(s) details populated and tax values updated. Click 'Generate'.`;
                statusMessage.style.color = 'blue';

            } else {
                alert('Please fill in valid details for all fields for all payees. "Per" cannot be zero.');
            }
        };
    }


    const fileInput = document.getElementById('json-file-input'); const reportTypeSelect = document.getElementById('report-type-select'); const generateBtn = document.getElementById('generate-btn'); const savePdfBtn = document.getElementById('save-pdf-btn'); let tokenInput = document.getElementById('token-input'); const reportOutput = document.getElementById('report-output'); const statusMessage = document.getElementById('status-message'); const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
    const refreshBtn = document.getElementById('refresh-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const printReportBtn = document.getElementById('print-report-btn');
    const saveEditsBtn = document.getElementById('save-edits-btn');
    const viewPayeeLedgerBtn = document.getElementById('view-payee-ledger-btn');


    printReportBtn.addEventListener('click', () => window.print());
    saveEditsBtn.addEventListener('click', () => saveManualEdits(true));
    viewPayeeLedgerBtn.addEventListener('click', showPayeeLedger);

    function refreshApplicationState() {
        renderContractors();
        renderAgreements();
        if (data) {
            updateTokenDropdown();
        }
        document.getElementById('report-output').innerHTML = '';
        document.getElementById('dynamic-fields-container').innerHTML = '';
        document.getElementById('token-input').value = '';
        statusMessage.textContent = 'Application state refreshed.';
        statusMessage.style.color = 'blue';
        document.getElementById('print-report-btn').style.display = 'none';
        document.getElementById('save-edits-btn').style.display = 'none';
        document.getElementById('view-payee-ledger-btn').style.display = 'none';
        currentReportVouchers = [];
        currentReportParameters = {};
        currentEditingReportId = null;
        setTimeout(() => {
            statusMessage.textContent = '';
        }, 3000);
    }

    clearDataBtn.addEventListener('click', () => {
        if(confirm('Are you sure you want to clear ALL saved data? This will remove contractors, agreements, saved reports, and treasury details permanently.')) {
            localStorage.removeItem(LS_CONTRACTOR_KEY);
            localStorage.removeItem(LS_AGREEMENT_KEY);
            localStorage.removeItem(LS_SAVED_REPORTS_KEY);
            localStorage.removeItem(LS_SVR_NO_KEY);
            localStorage.removeItem(LS_TREASURY_DATA_KEY);
            data = null;
            document.getElementById('json-file-input').value = '';
            alert('All saved data has been cleared.');
            refreshApplicationState();
        }
    });

    logoutBtn.addEventListener('click', () => {
        if(confirm('Are you sure you want to logout? This will clear all application data permanently.')) {
            localStorage.removeItem(LS_CONTRACTOR_KEY);
            localStorage.removeItem(LS_AGREEMENT_KEY);
            localStorage.removeItem(LS_SAVED_REPORTS_KEY);
            localStorage.removeItem(LS_SVR_NO_KEY);
            localStorage.removeItem(LS_TREASURY_DATA_KEY);
            data = null;
            document.getElementById('json-file-input').value = '';
            
            appContainer.style.display = 'none';
            loginContainer.style.display = 'flex';
            
            refreshApplicationState();
            
            alert('You have been logged out. All data has been cleared.');
        }
    });

    refreshBtn.addEventListener('click', refreshApplicationState);
    
    const handleTokenChange = () => {
        const reportType = document.getElementById('report-type-select').value;
        const tokenNo = tokenInput.value.trim();
        capturedAgreementData = {};
        dynamicFieldsContainer.innerHTML = '';
        
        if (!tokenNo) return;
        
        const showAgreementModalForToken = () => {
            if (!data) return;
            const relevantTransactions = data.estimates.flatMap(est => (est.balanceTransactions || []).map(bt => ({...bt, estimate: est}))).filter(bt => bt.tokenNo === tokenNo);
            const uniqueEstimateIds = [...new Set(relevantTransactions.map(tx => tx.estimate.id))];

            if (uniqueEstimateIds.length === 0) return;

            const agreementsDb = getAgreements();
            let agreementOptionsHtml = '<option value="">-- Select a saved agreement to fill details --</option>';
            agreementsDb.forEach(a => {
                agreementOptionsHtml += `<option value="${a.estimateId}">Est: ${a.estimateId} | Agr: ${a.agreementNo}</option>`;
            });

            let formHtml = '<form id="agreement-entry-form">';
            formHtml += `<div style="display: grid; grid-template-columns: 1fr 2fr 2fr; align-items: center; gap: 10px 15px; margin-bottom: 10px; font-weight: bold; padding-left: 175px;"><span>Agreement No & Year</span><span>Work Order No & Date</span></div>`;
            uniqueEstimateIds.forEach(estimateId => {
                const prefilled = agreementsDb.find(a => a.estimateId === estimateId) || { agreementNo: '', workOrder: '' };
                formHtml += `<div class="agreement-row-container" style="border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 15px;"><div class="modal-form" style="grid-template-columns: 1fr 3fr; align-items: center; gap: 15px; margin-bottom: 10px;"><label><b>For Est No ${estimateId}:</b></label><select class="saved-agreement-select" data-target-estimate-id="${estimateId}">${agreementOptionsHtml}</select></div><div class="modal-form" style="grid-template-columns: 1fr 2fr 2fr; align-items: center; gap: 15px; margin-bottom: 0;"><label></label><input type="text" data-type="agreement" class="agreement-input" data-estimate-id="${estimateId}" placeholder="e.g., 5/2023-24" value="${prefilled.agreementNo}" required><input type="text" data-type="workorder" class="workorder-input" data-estimate-id="${estimateId}" placeholder="e.g., 123 Dt: 01-07-2023" value="${prefilled.workOrder}" required></div></div>`;
            });
            formHtml += '</form>';

            let modal = document.getElementById('agreement-entry-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'agreement-entry-modal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `<div class="modal-content" style="max-width: 800px;"><span class="modal-close-btn">&times;</span><h2>Enter Agreement & Work Order Details</h2><p>For each estimate, enter the details below. You can select a saved agreement from the dropdown to auto-fill the fields.</p><hr>${formHtml}<div class="modal-footer-buttons" style="text-align: right; margin-top: 20px;"><button type="submit" form="agreement-entry-form" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Save Details</button></div></div>`;
            modal.style.display = 'block';

            modal.querySelectorAll('.saved-agreement-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const selectedEstimateId = e.target.value;
                    const targetEstimateId = e.target.dataset.targetEstimateId;
                    if (selectedEstimateId) {
                        const selectedAgreement = agreementsDb.find(a => a.estimateId === selectedEstimateId);
                        if (selectedAgreement) {
                            const rowContainer = e.target.closest('.agreement-row-container');
                            rowContainer.querySelector(`.agreement-input[data-estimate-id="${targetEstimateId}"]`).value = selectedAgreement.agreementNo;
                            rowContainer.querySelector(`.workorder-input[data-estimate-id="${targetEstimateId}"]`).value = selectedAgreement.workOrder;
                        }
                    }
                });
            });

            const closeModal = () => { modal.style.display = 'none'; };
            modal.querySelector('.modal-close-btn').onclick = closeModal;
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); }, { once: true });

            modal.querySelector('#agreement-entry-form').onsubmit = (e) => {
                e.preventDefault();
                const agreementInputData = {};
                const workOrderInputData = {};
                modal.querySelectorAll('.agreement-input').forEach(input => { agreementInputData[input.dataset.estimateId] = input.value; });
                modal.querySelectorAll('.workorder-input').forEach(input => { workOrderInputData[input.dataset.estimateId] = input.value; });
                capturedAgreementData = { agreement: agreementInputData, workOrder: workOrderInputData };
                closeModal();
                statusMessage.textContent = 'Agreement details captured. Ready to generate report.';
                statusMessage.style.color = 'blue';
            };
        };

        if (reportType === 'non-work') {
            showNonWorkPayeeModalForToken();
        } else if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) {
             if (reportType === 'e-procurmentTender') {
                showAgreementModalForToken(); // For e-procurement, skip limit prompt
             } else {
                const limitInput = prompt("Please enter the financial limit for each voucher (ಪ್ರತಿ ವೋಚರ್‌ನ ಆರ್ಥಿಕ ಮಿತಿಯನ್ನು ನಮೂದಿಸಿ):", voucherFinancialLimit);
                if (limitInput === null) { tokenInput.value = ''; return; }
                const newLimit = parseInt(limitInput, 10);
                if (isNaN(newLimit) || newLimit <= 0) {
                    alert("Invalid limit entered. Please enter a valid positive number.\n(ಅಮಾನ್ಯ ಮಿತಿಯನ್ನು ನಮೂದಿಸಲಾಗಿದೆ. ದಯವಿಟ್ಟು ಮಾನ್ಯ ಧನಾತ್ಮಕ ಸಂಖ್ಯೆಯನ್ನು ನಮೂದಿಸಿ.)");
                    tokenInput.value = ''; return;
                }
                voucherFinancialLimit = newLimit;
                showAgreementModalForToken();
            }
        }
    };

    const updateTokenDropdown = () => {
        if (!data) return;
        const tokenSelect = document.getElementById('token-input');
        
        const savedTokenNos = getSavedReports().map(r => r.inputs.tokenNo);
        
        const tokenDetails = {};
        data.estimates.forEach(est => {
            (est.balanceTransactions || []).forEach(bt => {
                const token = bt.tokenNo;
                if (token && !savedTokenNos.includes(token)) {
                    if (!tokenDetails[token]) {
                        tokenDetails[token] = { estimates: new Set(), works: new Set() };
                    }
                    tokenDetails[token].estimates.add(est.id);
                    tokenDetails[token].works.add(est.workName);
                }
            });
        });

        const availableTokens = Object.keys(tokenDetails);
        
        tokenSelect.innerHTML = '';
        if (availableTokens.length > 0) {
            tokenSelect.innerHTML = `<option value="" disabled selected>-- Select Token --</option>`;
            availableTokens.forEach(token => {
                const details = tokenDetails[token];
                const workStr = [...details.works].map(w => w.length > 40 ? w.substring(0, 37) + '...' : w).join('; ');
                const estStr = [...details.estimates].join(', ');
                
                const optionText = `${token} [Est: ${estStr}] [Work: ${workStr}]`;
                tokenSelect.innerHTML += `<option value="${token}">${optionText}</option>`;
            });
            tokenSelect.disabled = false;
        } else {
            tokenSelect.innerHTML = `<option value="">-- No available tokens --</option>`;
            tokenSelect.disabled = true;
        }
        tokenSelect.addEventListener('change', handleTokenChange);
    };
    
    const royaltyContainer = document.getElementById('royalty-percent-container');

    function toggleRoyaltyInput() {
        if (reportTypeSelect.value === 'civil') {
            royaltyContainer.style.display = 'block';
        } else {
            royaltyContainer.style.display = 'none';
        }
    }
    
    reportTypeSelect.addEventListener('change', (e) => {
        const reportType = e.target.value;
        toggleRoyaltyInput();
        dynamicFieldsContainer.innerHTML = '';
        mainContractorSelect.disabled = (['non-work'].includes(reportType) || !data);
        if (reportType === 'non-work') mainContractorSelect.value = '';
        
        if (reportType === 'selectedVoucher') {
            document.getElementById('selected-voucher-modal').style.display = 'block';
        }

        nonWorkPayees = [];
        nonWorkPayeeModal.style.display = 'none';
        reportOutput.innerHTML = '';
    });
    
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = (e) => { try {
            data = JSON.parse(e.target.result);
            statusMessage.textContent = '';
            reportOutput.innerHTML = '';
            dynamicFieldsContainer.innerHTML = '';
            renderContractors();
            updateTokenDropdown();
        } catch (error) {
            statusMessage.textContent = 'Error: Invalid JSON file.';
            statusMessage.style.color = 'red';
            data = null;
        } };
        reader.readAsText(file);
    });

    function executeReportGeneration(tenderData, gstData = null, manualRoyaltyData = null) {
        const reportType = reportTypeSelect.value;
        const contractorDetails = document.getElementById('contractor-details-input').value.trim();
        const tokenNo = document.getElementById('token-input').value.trim();
        const rfoName = document.getElementById('rfo-name-input').value.trim();
        const division = document.getElementById('division-input').value.trim();
        const subDivision = document.getElementById('sub-division-input').value.trim();
        const k2BillNoDate = document.getElementById('k2-bill-input').value.trim();
        const taxes = { itPercent: parseFloat(document.getElementById('it-percent-input').value) || 0, cgstPercent: parseFloat(document.getElementById('cgst-percent-input').value) || 0, sgstPercent: parseFloat(document.getElementById('sgst-percent-input').value) || 0, royaltyPercent: parseFloat(document.getElementById('royalty-percent-input').value) || 0, labourCessPercent: parseFloat(document.getElementById('labour-cess-input').value) || 0 };
        
        const agreementData = capturedAgreementData.agreement || {};
        const workOrderData = capturedAgreementData.workOrder || {};
        
        currentReportParameters = { reportType, tokenNo, rfoName, subDivision, agreementData, workOrderData, contractorDetails, k2BillNoDate, division, taxes, tenderData, gstData, nonWorkPayees, selectedVoucherSubType, manualRoyaltyData };

        generateReport(currentReportParameters);
    }

    function showGstModal(tenderData, manualRoyaltyData = null) {
        const gstModal = document.getElementById('gst-modal');
        const gstForm = document.getElementById('gst-form');
        gstModal.style.display = 'block';

        const submitHandler = function(e) {
            e.preventDefault();
            const gstData = {
                cgst: parseFloat(document.getElementById('add-cgst-percent').value) || 0,
                sgst: parseFloat(document.getElementById('add-sgst-percent').value) || 0
            };
            gstModal.style.display = 'none';
            gstForm.removeEventListener('submit', submitHandler);
            executeReportGeneration(tenderData, gstData, manualRoyaltyData);
        };
        gstForm.addEventListener('submit', submitHandler);
    }
    
    function showManualRoyaltyModal(relevantTransactions, callback) {
        const modal = document.getElementById('manual-royalty-modal');
        const form = document.getElementById('manual-royalty-form');
        const sandQtyInput = document.getElementById('sand-qty');
        const sandRateInput = document.getElementById('sand-rate');
        const redearthQtyInput = document.getElementById('redearth-qty');
        const redearthRateInput = document.getElementById('redearth-rate');
        const totalDisplay = document.getElementById('total-royalty-display');

        let totalSand = 0;
        let totalRedearth = 0;
        const sandRegex = /(\d*\.?\d+)\s*cum\s*(?:\.|of)?\s*sand/gi;
        const redearthRegex = /(\d*\.?\d+)\s*cum\s*(?:of)?\s*redearth/gi;
        
        relevantTransactions.forEach(tx => {
            let match;
            sandRegex.lastIndex = 0;
            while ((match = sandRegex.exec(tx.particularsTextSnapshot)) !== null) {
                totalSand += parseFloat(match[1]) || 0;
            }
            redearthRegex.lastIndex = 0;
            while ((match = redearthRegex.exec(tx.particularsTextSnapshot)) !== null) {
                totalRedearth += parseFloat(match[1]) || 0;
            }
        });

        sandQtyInput.value = totalSand > 0 ? totalSand.toFixed(3) : '0';
        redearthQtyInput.value = totalRedearth > 0 ? totalRedearth.toFixed(3) : '0';
        sandRateInput.value = '0';
        redearthRateInput.value = '0';

        const calculateTotal = () => {
            const sandQty = parseFloat(sandQtyInput.value) || 0;
            const sandRate = parseFloat(sandRateInput.value) || 0;
            const redearthQty = parseFloat(redearthQtyInput.value) || 0;
            const redearthRate = parseFloat(redearthRateInput.value) || 0;
            const sandTotal = Math.round(sandQty * sandRate);
            const redearthTotal = Math.round(redearthQty * redearthRate);
            const total = sandTotal + redearthTotal;
            totalDisplay.value = `Rs. ${total.toFixed(2)}`;
            return total;
        };

        const inputChangeHandler = () => calculateTotal();
        modal.querySelectorAll('.royalty-calc-input').forEach(input => {
            input.addEventListener('input', inputChangeHandler);
        });

        const submitHandler = (e) => {
            e.preventDefault();
            const totalRoyalty = calculateTotal();
            const royaltyData = {
                total: totalRoyalty,
                sandQty: parseFloat(sandQtyInput.value) || 0,
                sandRate: parseFloat(sandRateInput.value) || 0,
                redearthQty: parseFloat(redearthQtyInput.value) || 0,
                redearthRate: parseFloat(redearthRateInput.value) || 0
            };
            modal.style.display = 'none';
            form.removeEventListener('submit', submitHandler);
            modal.querySelectorAll('.royalty-calc-input').forEach(input => {
                input.removeEventListener('input', inputChangeHandler);
            });
            callback(royaltyData);
        };
        form.addEventListener('submit', submitHandler);

        modal.querySelector('.modal-close-btn').onclick = () => { modal.style.display = 'none'; };
        calculateTotal();
        modal.style.display = 'block';
    }


    generateBtn.addEventListener('click', () => {
        if (!data) { reportOutput.innerHTML = `<p id="error-message">Please import a JSON file first.</p>`; return; }
        const reportType = reportTypeSelect.value; const contractorDetails = document.getElementById('contractor-details-input').value.trim(); const tokenNo = document.getElementById('token-input').value.trim(); if (!tokenNo) { reportOutput.innerHTML = `<p id="error-message">Please select a Token Number.</p>`; return; }
        
        if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType) && (!capturedAgreementData.agreement || Object.keys(capturedAgreementData.agreement).length === 0)) {
             reportOutput.innerHTML = `<p id="error-message">Please select a token again to enter Agreement/Work Order details.</p>`; return;
        }

        if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType) && !contractorDetails) { reportOutput.innerHTML = `<p id="error-message">Please select Contractor for this report type.</p>`; return; }
        if (reportType === 'non-work' && nonWorkPayees.length === 0) { reportOutput.innerHTML = `<p id="error-message">Please enter Payee Details for Non-Work report.</p>`; showNonWorkPayeeModalForToken(); return; }

        const relevantTransactionsForModal = data.estimates.flatMap(est => (est.balanceTransactions || []).map(bt => ({...bt, estimate: est}))).filter(bt => bt.tokenNo === tokenNo);
        const uniqueEstimateIds = [...new Set(relevantTransactionsForModal.map(tx => tx.estimate.id))];

        const continueGeneration = (tenderData, manualRoyaltyData = null) => {
            if (['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) {
                showGstModal(tenderData, manualRoyaltyData);
            } else {
                executeReportGeneration(tenderData, null, manualRoyaltyData);
            }
        };
        
        const showTenderModal = (callbackWithRoyalty) => {
            if (uniqueEstimateIds.length > 0) {
                const tenderModal = document.getElementById('tender-modal');
                const tenderForm = document.getElementById('tender-form');
                tenderForm.innerHTML = uniqueEstimateIds.map(id => `
                    <div class="modal-form" style="grid-template-columns: 2fr 1fr; align-items: center;">
                        <label for="tender-${id}"><b>${id}:</b></label>
                        <input type="number" id="tender-${id}" data-estimate-id="${id}" class="tender-percent-input" placeholder="% of tender" step="any" value="1.75" required>
                    </div>`).join('');
                tenderModal.style.display = 'block';

                const submitHandler = function(e) {
                    e.preventDefault();
                    const tenderData = {};
                    tenderForm.querySelectorAll('.tender-percent-input').forEach(input => {
                        tenderData[input.dataset.estimateId] = parseFloat(input.value);
                    });
                    tenderModal.style.display = 'none';
                    tenderForm.removeEventListener('submit', submitHandler);
                    callbackWithRoyalty(tenderData);
                };
                tenderForm.addEventListener('submit', submitHandler);

            } else {
                callbackWithRoyalty({});
            }
        };

        if (reportType === 'work' || reportType === 'selectedVoucher') {
            const containsRoyaltyKeywords = relevantTransactionsForModal.some(tx => 
                /sand|redearth/i.test(tx.particularsTextSnapshot)
            );

            if (containsRoyaltyKeywords) {
                showManualRoyaltyModal(relevantTransactionsForModal, manualRoyaltyData => {
                    showTenderModal(tenderData => continueGeneration(tenderData, manualRoyaltyData));
                });
            } else {
                 showTenderModal(tenderData => continueGeneration(tenderData, { total: 0 }));
            }
        } else if (['timber', 'civil', 'e-procurmentTender'].includes(reportType)) {
             showTenderModal(tenderData => continueGeneration(tenderData));
        } else if (reportType === 'non-work') {
            if (confirm("Apply tender? (ಟೆಂಡರ್ ಅನ್ವಯಿಸಬೇಕೆ?)")) {
                showTenderModal(tenderData => executeReportGeneration(tenderData, null));
            } else {
                executeReportGeneration({}, null);
            }
        }
    });


    savePdfBtn.addEventListener('click', () => { const reportContent = reportOutput.innerHTML.trim(); if (reportContent === '' || document.getElementById('error-message')) { alert('Please generate a valid report first.'); return; } window.print(); });
    function exportDataAsJson(data, filename) { const jsonString = JSON.stringify(data, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    document.getElementById('export-contractors-btn').addEventListener('click', () => { exportDataAsJson(getContractors(), 'contractors-export.json'); });
    const importContractorsBtn = document.getElementById('import-contractors-btn'); const importContractorsInput = document.getElementById('import-contractors-input');
    importContractorsBtn.addEventListener('click', () => importContractorsInput.click());
    importContractorsInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file || !confirm('Replace current contractors?')) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData)) throw new Error('Invalid format.'); saveContractors(importedData); renderContractors(); alert('Imported!'); } catch (error) { alert('Error: ' + error.message); } finally { event.target.value = ''; } }; reader.readAsText(file); });
    document.getElementById('export-agreements-btn').addEventListener('click', () => { exportDataAsJson(getAgreements(), 'agreements-export.json'); });
    const importAgreementsBtn = document.getElementById('import-agreements-btn'); const importAgreementsInput = document.getElementById('import-agreements-input');
    importAgreementsBtn.addEventListener('click', () => importAgreementsInput.click());
    importAgreementsInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file || !confirm('Replace current agreements?')) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData)) throw new Error('Invalid format.'); saveAgreements(importedData); renderAgreements(); alert('Imported!'); } catch (error) { alert('Error: ' + error.message); } finally { event.target.value = ''; } }; reader.readAsText(file); });
    
    document.getElementById('export-all-data-btn').addEventListener('click', () => {
        if (!confirm('Do you want to export all saved data (Contractors, Agreements, Saved Reports, Treasury Details) into a single backup file?')) {
            return;
        }
        const allData = {
            contractors: getContractors(),
            agreements: getAgreements(),
            savedReports: getSavedReports(),
            svrCounters: getSvrCounters(),
            treasuryData: getTreasuryData()
        };
        const today = new Date().toISOString().slice(0, 10);
        exportDataAsJson(allData, `cashbook_backup_${today}.json`);
        alert('All data has been exported to `cashbook_backup_' + today + '.json`.');
    });

    const importAllBtn = document.querySelector('label[for="import-all-data-input"]');
    const importAllInput = document.getElementById('import-all-data-input');
    importAllBtn.addEventListener('click', () => importAllInput.click());
    importAllInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm('Are you sure you want to import data from this file? This will ERASE and OVERWRITE ALL currently saved data (Contractors, Agreements, Reports, etc.). This action cannot be undone.')) {
            event.target.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!importedData.contractors || !importedData.agreements || !importedData.savedReports || !importedData.svrCounters || !importedData.treasuryData) {
                    throw new Error('The backup file is missing required data sections or is invalid. Import aborted.');
                }
                saveContractors(importedData.contractors || []);
                saveAgreements(importedData.agreements || []);
                saveSavedReports(importedData.savedReports || []);
                saveSvrCounters(importedData.svrCounters || {});
                saveTreasuryData(importedData.treasuryData || {});
                alert('Data imported successfully! The application will now refresh with the new data.');
                refreshApplicationState();
            } catch (error) {
                alert('Error importing file: ' + error.message);
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    });
    
    const formatDateSafely = (dateString, fallback = '') => { try { if (!dateString) return fallback; const date = new Date(dateString); return isNaN(date.getTime()) ? fallback : date.toLocaleDateString('en-GB'); } catch { return fallback; } };
    
    const numberToWordsLocal = (num) => {
        num = Math.round(num);
        const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
        const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        if ((num = num.toString()).length > 9) return 'overflow';
        const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!n) return '';
        let str = '';
        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
        str = str.replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
        return str.trim() + ' Rupees Only';
    };

    const generateReport = (params) => {
        currentEditingReportId = null; // Reset for new report generation
        const { tokenNo } = params;
        reportOutput.innerHTML = '';
        document.getElementById('print-report-btn').style.display = 'none';
        document.getElementById('save-edits-btn').style.display = 'none';
        document.getElementById('view-payee-ledger-btn').style.display = 'none';

        const relevantTransactions = data.estimates.flatMap(est => (est.balanceTransactions || []).map(bt => ({...bt, estimate: est}))).filter(bt => bt.tokenNo === tokenNo);
        if (relevantTransactions.length === 0) {
            reportOutput.innerHTML = `<p id="error-message">No data for Token: ${tokenNo}</p>`;
            return;
        }

        const firstTransactionDate = new Date(relevantTransactions[0].date);
        const startDate = new Date('2029-04-01');
        const endDate = new Date('2200-03-31');
        
        firstTransactionDate.setHours(0, 0, 0, 0);
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);

        if (firstTransactionDate >= startDate && firstTransactionDate <= endDate) {
            alert('For the full version of our software, please get in touch with your official vendor.');
            const appContainer = document.getElementById('app-container');
            const lockoutOverlay = document.getElementById('lockout-overlay');
            if (appContainer) appContainer.style.display = 'none';
            if (lockoutOverlay) {
                lockoutOverlay.innerHTML = '<h2>Access Restricted</h2><p>For the Next year 2029-30 new version of our software, please get in touch with your official vendor Cell 9110249941.</p>';
                lockoutOverlay.style.display = 'flex';
            }
            return;
        }

        const firstTx = relevantTransactions[0];
        const schemeName = firstTx.estimate.schemeName;
        const budgetHead = firstTx.estimate.budgetHead;
        currentReportParameters.schemeName = schemeName;
        currentReportParameters.budgetHead = budgetHead;

        const svrCounters = getSvrCounters();
        const lastSvrNo = svrCounters[schemeName] || 0;

        let initialSvrCounter = lastSvrNo;

        const userInputSvr = prompt(`Enter the starting SVr, no. for scheme "${schemeName}".\n(Leave blank or cancel for automatic numbering starting from ${lastSvrNo + 1})`, "");
        const customStartSvr = parseInt(userInputSvr, 10);

        if (userInputSvr && !isNaN(customStartSvr) && customStartSvr > 0) {
            initialSvrCounter = customStartSvr - 1;
        }

        const hasDayBasedItems = relevantTransactions.some(tx => {
            const ssrItem = (tx.estimate.ssrItems && tx.estimate.ssrItems[tx.ssrItemIndex]) ? tx.estimate.ssrItems[tx.ssrItemIndex] : { unit: '' };
            const unit = (ssrItem.unit || '').toLowerCase().trim();
            return unit.includes('day');
        });

        const finalizeReportGeneration = (dateInfoByTxIndex, startCounter) => {
            let processedTransactions = relevantTransactions.map((tx, index) => ({
                ...JSON.parse(JSON.stringify(tx)),
                originalIndex: index
            }));

            let vouchers = [];
            const { reportType, agreementData, workOrderData, contractorDetails, nonWorkPayees, tenderData, gstData } = params;
            
            const voucherDate = new Date(firstTx.date);
            const month = voucherDate.toLocaleString('default', { month: 'long' });
            const year = voucherDate.getFullYear();
            currentReportParameters.month = month;
            currentReportParameters.year = year;
            
            if (reportType === 'non-work') {
                let svrNoCounter = startCounter;
                let nonWorkVouchersData = [];
                nonWorkPayees.forEach((payee, index) => {
                    const currentSvrNo = svrNoCounter + 1 + index;
                    const estForNonWork = firstTx.estimate;
                    let plantationDetailsHtml = '';
                    if (estForNonWork.location) plantationDetailsHtml += `<b>Location:</b> ${estForNonWork.location}<br/>`;
                    if (estForNonWork.plantationFSyNo) plantationDetailsHtml += `<b>FSy, No:</b> ${estForNonWork.plantationFSyNo}<br/>`;
                    if (estForNonWork.plantationExtentHa) plantationDetailsHtml += `<b>Extent(Ha):</b> ${estForNonWork.plantationExtentHa}<br/>`;
                    if (estForNonWork.plantationNoOfSeedlings) plantationDetailsHtml += `<b>No.of Seedlings:</b> ${estForNonWork.plantationNoOfSeedlings}<br/>`;
                    if (estForNonWork.quantity) plantationDetailsHtml += `<b>Quantity:</b> ${estForNonWork.quantity}<br/>`;

                    const itemParticulars = `<b>Payee:</b> ${payee.name}<br><b>Work:</b> ${firstTx.estimate.workName || ''}<br>${plantationDetailsHtml}<b>Estimate No:</b> ${firstTx.estimate.id}<br><b>Period of Work:</b> ${firstTx.periodOfWork || '-'}<br><b>FNB/MB:</b> ${firstTx.fnbMbBookNumber || 'N/A'} &nbsp;&nbsp; <b>PAGE NO:</b> ${firstTx.fnbMbPageNumber || 'N/A'}<br><b>C.M DATE:</b> ${formatDateSafely(firstTx.checkMeasurementDate, '-')}`;
                    
                    const tenderPercent = (tenderData[firstTx.estimate.id] !== undefined && !isNaN(tenderData[firstTx.estimate.id])) ? tenderData[firstTx.estimate.id] : 0;
                    const itemGrossAmount = payee.amount;
                    const itemDeduction = (itemGrossAmount * tenderPercent) / 100;
                    const roundedItemDeduction = Math.round(itemDeduction);
                    const netAfterTender = itemGrossAmount - roundedItemDeduction;
                    const subTotal = netAfterTender; // For non-work, subtotal is same as net after tender.
                    const itDeductAmount = Math.round((subTotal * params.taxes.itPercent) / 100);
                    const labourCessDeductAmount = Math.round((subTotal * params.taxes.labourCessPercent) / 100);
                    const cgstDeductAmount = Math.round((netAfterTender * params.taxes.cgstPercent) / 100);
                    const sgstDeductAmount = Math.round((netAfterTender * params.taxes.sgstPercent) / 100);
                    const royaltyDeductAmount = Math.round((subTotal * params.taxes.royaltyPercent) / 100);
                    const totalDeductions = itDeductAmount + labourCessDeductAmount + cgstDeductAmount + sgstDeductAmount + royaltyDeductAmount;
                    const finalNetPayable = subTotal - totalDeductions;
                    
                    const matchingTx = relevantTransactions[0] || {};
                    const ssrItem = (matchingTx.estimate && matchingTx.estimate.ssrItems[matchingTx.ssrItemIndex]) ? matchingTx.estimate.ssrItems[matchingTx.ssrItemIndex] : {unit: 'Ls'};

                    nonWorkVouchersData.push({
                        svrNo: currentSvrNo,
                        finalTotalWithGst: finalNetPayable,
                        subTotalForDeductions: subTotal,
                        items: [{
                            estimate: { ...firstTx.estimate },
                            particularsTextSnapshot: itemParticulars,
                            quantitySnapshot: firstTx.quantitySnapshot, // Use quantity from original JSON data as requested
                            rateSnapshot: payee.rate,
                            timesdaySnapshot: payee.timesPerDay,
                            perSnapshot: payee.per,
                            unitSnapshot: ssrItem.unit,
                            expenditureAmount: payee.amount,
                            date: firstTx.date,
                            checkMeasurementDate: firstTx.checkMeasurementDate,
                            periodOfWork: firstTx.periodOfWork,
                            fnbMbBookNumber: firstTx.fnbMbBookNumber,
                            fnbMbPageNumber: firstTx.fnbMbPageNumber,
                        }]
                    });
                });
                vouchers = nonWorkVouchersData;
            } else if (reportType === 'e-procurmentTender') {
                const svrNo = startCounter + 1;
                let allItems = [];
                processedTransactions.forEach(tx => {
                    allItems.push(tx);
                });
                if(allItems.length > 0) {
                     vouchers.push({ svrNo: svrNo, items: allItems });
                }
            }
            else { // Logic for Work, Timber, Civil, Selected Voucher
                const splitTransactionsIntoVouchers = (transactionsToSplit, gstFactor) => {
                    const tempVouchers = [];
                    const transactionsByEstimate = new Map();
                    transactionsToSplit.forEach(tx => {
                        const estId = tx.estimate.id;
                        if (!transactionsByEstimate.has(estId)) {
                            transactionsByEstimate.set(estId, []);
                        }
                        transactionsByEstimate.get(estId).push(tx);
                    });

                    transactionsByEstimate.forEach((transactionsForEstimate, estimateId) => {
                        let currentVoucherItems = [];
                        let currentVoucherTotal = 0;
                        for (const originalTx of transactionsForEstimate) {
                            let remainingQty = originalTx.quantitySnapshot;
                            let totalAllocatedAmount = 0;
                            const costPerUnit = (originalTx.quantitySnapshot > 0) ? (originalTx.expenditureAmount / originalTx.quantitySnapshot) : 0;
                            const costPerUnitWithGST = costPerUnit * gstFactor;
                            while (remainingQty > 0.00001) {
                                const currentVoucherTotalWithGST = currentVoucherTotal * gstFactor;
                                const spaceInVoucher = voucherFinancialLimit - currentVoucherTotalWithGST;
                                const costOfRemainingQtyWithGST = (remainingQty * costPerUnit) * gstFactor;
                                if (costOfRemainingQtyWithGST <= spaceInVoucher + 0.01) {
                                    const finalPart = JSON.parse(JSON.stringify(originalTx));
                                    finalPart.quantitySnapshot = remainingQty;
                                    finalPart.expenditureAmount = originalTx.expenditureAmount - totalAllocatedAmount;
                                    currentVoucherItems.push(finalPart);
                                    currentVoucherTotal += finalPart.expenditureAmount;
                                    remainingQty = 0;
                                } else {
                                    const quantityThatCanFit = (costPerUnitWithGST > 0) ? (spaceInVoucher / costPerUnitWithGST) : 0;
                                    const wholeQuantityToFit = Math.floor(quantityThatCanFit);
                                    if (wholeQuantityToFit > 0) {
                                        const part1 = JSON.parse(JSON.stringify(originalTx));
                                        const part1Amount = parseFloat((wholeQuantityToFit * costPerUnit).toFixed(2));
                                        part1.quantitySnapshot = wholeQuantityToFit;
                                        part1.expenditureAmount = part1Amount;
                                        currentVoucherItems.push(part1);
                                        totalAllocatedAmount += part1Amount;
                                        remainingQty -= wholeQuantityToFit;
                                        currentVoucherTotal += part1Amount;
                                    }
                                    if (currentVoucherItems.length > 0) {
                                        tempVouchers.push({ items: currentVoucherItems });
                                    }
                                    currentVoucherItems = [];
                                    currentVoucherTotal = 0;
                                }
                            }
                        }
                        if (currentVoucherItems.length > 0) {
                            tempVouchers.push({ items: currentVoucherItems });
                        }
                    });
                    return tempVouchers;
                };

                const gstFactor = (['timber', 'civil', 'selectedVoucher'].includes(reportType) && gstData) ? (1 + (gstData.cgst / 100) + (gstData.sgst / 100)) : 1;
                
                if (reportType === 'timber') {
                    const engagingTransactions = processedTransactions.filter(tx =>
                        tx.particularsTextSnapshot.trim().toLowerCase().startsWith('engaging')
                    );
                    const otherTransactions = processedTransactions.filter(tx =>
                        !tx.particularsTextSnapshot.trim().toLowerCase().startsWith('engaging')
                    );
                    
                    const otherVouchers = splitTransactionsIntoVouchers(otherTransactions, gstFactor);
                    const engagingVouchers = splitTransactionsIntoVouchers(engagingTransactions, 1); // GST factor is 1 for non-GST items

                    engagingVouchers.forEach(v => v.isEngagingVoucher = true);

                    vouchers = [...otherVouchers, ...engagingVouchers];
                } else { // For Work, Civil, Selected Voucher
                    vouchers = splitTransactionsIntoVouchers(processedTransactions, gstFactor);
                }

                let svrNoCounter = startCounter;
                vouchers.forEach((voucher) => {
                    if(!voucher.svrNo){
                        svrNoCounter++;
                        voucher.svrNo = svrNoCounter;
                    }
                });
            }

            // Common processing for all voucher-based reports
            vouchers.forEach((voucher) => {
                const allCmDates = [...new Set(voucher.items.map(item => item.checkMeasurementDate).filter(Boolean))].join(', ');
                const allPeriodsOfWork = [...new Set(voucher.items.map(item => item.periodOfWork).filter(Boolean))].join(', ');

                voucher.items.forEach((tx, itemIndex) => {
                    if(tx.finalParticularsText) return; // Skip if already processed

                    const est = tx.estimate;
                    const ssrItem = (est.ssrItems && est.ssrItems[tx.ssrItemIndex]) ? est.ssrItems[tx.ssrItemIndex] : { rate: 0, per: 0, unit: '' };
                    
                    const isDayBasedItem = (ssrItem.unit || '').toLowerCase().trim().includes('day');
                    const dateInfoForThisTx = (dateInfoByTxIndex && isDayBasedItem) ? dateInfoByTxIndex.get(tx.originalIndex) : null;
                    
                    const dateRemovalRegex = /\s*from\s+[\d\.\/-]+\s+to\s+[\d\.\/-]+.*?=*\s*\d+\s*days?/i;
                    const baseParticulars = tx.particularsTextSnapshot.replace(dateRemovalRegex, '').trim();

                    let particularsContent;

                    if (dateInfoForThisTx) {
                        let addedText = '';
                        if (dateInfoForThisTx.type === 'range') {
                            addedText = ` from ${dateInfoForThisTx.from} to ${dateInfoForThisTx.to} = ${tx.mandaysSnapshot} days.`;
                        } else if (dateInfoForThisTx.type === 'text' && dateInfoForThisTx.text) {
                            addedText = ` ${dateInfoForThisTx.text}`;
                        }
                        particularsContent = baseParticulars + addedText;
                    } else {
                        particularsContent = tx.particularsTextSnapshot;
                    }
                    
                    let headerPart = '';
                    if (itemIndex === 0 && reportType !== 'non-work') {
                        let plantationDetailsHtml = '';
                        if (est.location) plantationDetailsHtml += `<b>Location:</b> ${est.location}<br/>`;
                        if (est.plantationFSyNo) plantationDetailsHtml += `<b>FSy, No:</b> ${est.plantationFSyNo}<br/>`;
                        if (est.plantationExtentHa) plantationDetailsHtml += `<b>Extent(Ha):</b> ${est.plantationExtentHa}<br/>`;
                        if (est.plantationNoOfSeedlings) plantationDetailsHtml += `<b>No.of Seedlings:</b> ${est.plantationNoOfSeedlings}<br/>`;
                        if (est.quantity) plantationDetailsHtml += `<b>Quantity:</b> ${est.quantity}<br/>`;

                        headerPart = `<b>Payee:</b> ${contractorDetails}<br/><b>Agreement:</b> ${agreementData[est.id] || est.agreementNo || '----'} &nbsp;&nbsp; <b>Work Order:</b> ${workOrderData[est.id] || '----'}<br/><b>Work:</b> ${est.workName || ''}<br/>${plantationDetailsHtml}<b>Est No:</b> ${est.id || ''}<br/><b>Period of Work:</b> ${allPeriodsOfWork || ''}<br/><b>FNB/MB:</b> ${tx.fnbMbBookNumber || ''} <b>Page:</b> ${tx.fnbMbPageNumber || ''}<br/><b>C.M Date:</b> ${allCmDates || ''}`;
                    }

                    tx.finalParticularsText = headerPart ? `${headerPart}<br><br>${particularsContent}` : particularsContent;
                    tx.rateSnapshot = ssrItem.rate;
                    tx.perSnapshot = ssrItem.per;
                    tx.unitSnapshot = ssrItem.unit;
                    tx.timesdaySnapshot = tx.mandaysSnapshot;
                });
            });
            
            currentReportVouchers = vouchers;
            
            const reportHtml = renderReportHtmlFromData(vouchers, { ...params, schemeName, budgetHead, month, year });
            reportOutput.innerHTML = reportHtml;

            addEditEventListeners();
            document.getElementById('print-report-btn').style.display = 'inline-flex';
            document.getElementById('save-edits-btn').style.display = 'inline-flex';
            document.getElementById('view-payee-ledger-btn').style.display = 'inline-flex';


            if (confirm('Do you want to save this report for later viewing?')) {
                let finalSvrNo;
                if(reportType === 'e-procurmentTender') {
                    finalSvrNo = vouchers.length > 0 ? vouchers[0].svrNo : startCounter;
                } else {
                     finalSvrNo = (params.reportType === 'non-work' && nonWorkPayees.length > 0)
                        ? startCounter + nonWorkPayees.length
                        : (vouchers.length > 0 ? vouchers[vouchers.length - 1].svrNo : startCounter);
                }

                saveCurrentReport(vouchers, { ...currentReportParameters, finalSvrNo });
                
                if (!(userInputSvr && !isNaN(customStartSvr) && customStartSvr > 0)) {
                    svrCounters[schemeName] = finalSvrNo;
                    saveSvrCounters(svrCounters);
                }
                updateTokenDropdown();
                alert(`Report saved! The last SVr, no. used was ${finalSvrNo}.`);
            }
        };

        if (hasDayBasedItems && params.reportType !== 'non-work') {
            showDayBasedItemModal(relevantTransactions, (dateInfoMap) => {
                finalizeReportGeneration(dateInfoMap, initialSvrCounter);
            });
        } else {
            finalizeReportGeneration(null, initialSvrCounter);
        }
    };

    function showDayBasedItemModal(transactions, callback) {
        const modalId = 'day-based-item-modal';
        let modal = document.getElementById(modalId);
        if (modal) modal.remove();

        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        
        const dayBasedTransactions = transactions
            .map((tx, index) => ({ ...tx, originalIndex: index }))
            .filter(tx => {
                const ssrItem = (tx.estimate.ssrItems && tx.estimate.ssrItems[tx.ssrItemIndex]) ? tx.estimate.ssrItems[tx.ssrItemIndex] : { unit: '' };
                return (ssrItem.unit || '').toLowerCase().trim().includes('day');
            });

        const transactionsGroupedByEst = dayBasedTransactions.reduce((acc, tx) => {
            const estId = tx.estimate.id;
            if (!acc[estId]) acc[estId] = [];
            acc[estId].push(tx);
            return acc;
        }, {});

        let formContentHtml = '';
        Object.keys(transactionsGroupedByEst).forEach(estId => {
            formContentHtml += `<h4 style="background-color: #f0f0f0; padding: 5px; border-radius: 3px; margin-top: 15px;">Estimate No: ${estId}</h4>`;
            transactionsGroupedByEst[estId].forEach(tx => {
                const ssrItem = (tx.estimate.ssrItems && tx.estimate.ssrItems[tx.ssrItemIndex]) ? tx.estimate.ssrItems[tx.ssrItemIndex] : {};
                const txIndex = tx.originalIndex;

                formContentHtml += `
                <div class="day-item-container" data-tx-index="${txIndex}" style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                    <p style="margin:0; font-size: 0.9em; line-height: 1.4;"><strong>Particulars:</strong> ${tx.particularsTextSnapshot}<br>
                    <small><strong>Qty:</strong> ${tx.quantitySnapshot}, <strong>Rate:</strong> ${ssrItem.rate}, <strong>Times/day:</strong> ${tx.mandaysSnapshot}, <strong>Unit:</strong> ${ssrItem.unit}, <strong>Per:</strong> ${ssrItem.per}</small></p>
                    <hr style="margin: 8px 0;">
                    
                    <div class="date-option-container date-range-option">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label>From:</label> <input type="date" class="from-date-input">
                            <label>To:</label> <input type="date" class="to-date-input">
                            <button type="button" class="delete-option-btn no-print" title="Delete this option">❌</button>
                        </div>
                    </div>

                    <div class="date-option-container text-option" style="margin-top: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label>Or Text:</label> <input type="text" class="text-date-input" placeholder="e.g., Work done on 15-08-2025" style="flex-grow:1;">
                            <button type="button" class="delete-option-btn no-print" title="Delete this option">❌</button>
                        </div>
                    </div>
                </div>`;
            });
        });

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <span class="modal-close-btn">&times;</span>
                <h2>Enter Work Period for Day-based Items</h2>
                <p>For each item below, provide either a date range OR a text description of the period. Delete the option you are not using for each item.</p>
                <hr>
                <form id="days-date-form">${formContentHtml}</form>
                <div style="text-align: right; margin-top: 20px;">
                    <button id="update-report-btn" class="toolbar-btn btn-success" style="padding: 10px 20px;">Update Report</button>
                </div>
            </div>`;
        document.body.appendChild(modal);
        
        const closeModal = () => { const modalToClose = document.getElementById(modalId); if (modalToClose) modalToClose.remove(); };
        
        modal.querySelector('.modal-close-btn').onclick = () => {
            if (confirm('Are you sure you want to cancel? The report will be generated with the original data.')) {
                closeModal();
                callback(null);
            }
        };

        modal.querySelectorAll('.delete-option-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const optionContainer = e.target.closest('.date-option-container');
                if(optionContainer) {
                    optionContainer.style.display = 'none';
                    optionContainer.querySelectorAll('input').forEach(input => input.value = '');
                }
            });
        });

        modal.querySelector('#update-report-btn').addEventListener('click', () => {
            const dateInfoByTxIndex = new Map();
            let allValid = true;

            modal.querySelectorAll('.day-item-container').forEach(container => {
                if (!allValid) return;

                const txIndex = parseInt(container.dataset.txIndex, 10);
                
                const rangeOption = container.querySelector('.date-range-option');
                const textOption = container.querySelector('.text-option');

                const isRangeVisible = rangeOption.style.display !== 'none';
                const isTextVisible = textOption.style.display !== 'none';
                
                const fromDateInput = rangeOption.querySelector('.from-date-input');
                const toDateInput = rangeOption.querySelector('.to-date-input');
                const textInput = textOption.querySelector('.text-date-input');

                const fromVal = fromDateInput.value;
                const toVal = toDateInput.value;
                const textVal = textInput.value.trim();
                
                if (isRangeVisible && (fromVal || toVal)) {
                    if (fromVal && toVal) {
                        const startDate = new Date(fromVal);
                        const endDate = new Date(toVal);
                        if (endDate < startDate) {
                            alert(`For item with original index ${txIndex}, the 'To' date cannot be before the 'From' date.`);
                            allValid = false;
                            return;
                        }
                         const formatInputDate = (d) => { const [y, m, day] = d.split('-'); return `${day}-${m}-${y}`; };
                         dateInfoByTxIndex.set(txIndex, { type: 'range', from: formatInputDate(fromVal), to: formatInputDate(toVal) });
                    } else {
                        alert(`For item with original index ${txIndex}, please provide both From and To dates if using the date range option.`);
                        allValid = false;
                        return;
                    }
                } else if (isTextVisible && textVal) {
                     dateInfoByTxIndex.set(txIndex, { type: 'text', text: textVal });
                }
            });
            
            if (allValid) {
                closeModal();
                callback(dateInfoByTxIndex);
            }
        });
    }

    function rerenderReport() {
        if (!currentReportVouchers || !currentReportParameters) return;
        const fullReportHtml = renderReportHtmlFromData(currentReportVouchers, currentReportParameters);
        document.getElementById('report-output').innerHTML = fullReportHtml;
        addEditEventListeners();
        saveManualEdits(false); // Autosave on every rerender
    }

    function handleDeleteItem(voucherIndex, itemIndex) {
        const voucher = currentReportVouchers[voucherIndex];
        if (voucher && voucher.items.length > itemIndex) {
            voucher.items.splice(itemIndex, 1);
        }
        if (voucher && voucher.items.length === 0) {
            currentReportVouchers.splice(voucherIndex, 1);
        }
        rerenderReport();
    }

    function handleAddItem(voucherIndex) {
        const voucher = currentReportVouchers[voucherIndex];
        if (!voucher || voucher.items.length === 0) return;
        
        const firstItem = voucher.items[0];
        const newItem = {
            ...JSON.parse(JSON.stringify(firstItem)),
            quantitySnapshot: 0,
            rateSnapshot: 0,
            timesdaySnapshot: 1,
            perSnapshot: 1,
            unitSnapshot: 'Ls',
            expenditureAmount: 0,
            finalParticularsText: `<i>New item for ${firstItem.estimate.workName} - please edit details.</i>`
        };
        
        voucher.items.push(newItem);
        rerenderReport();
    }

    function handleReportEdit(event) {
        const target = event.target;
        const editableContainer = target.closest('[contenteditable="true"], .editable-input, .editable-select');
        if (!editableContainer) return;

        const voucherIndex = parseInt(editableContainer.dataset.voucherIndex, 10);
        const itemIndex = parseInt(editableContainer.dataset.itemIndex, 10);
        const field = editableContainer.dataset.field;

        if (isNaN(voucherIndex) || isNaN(itemIndex) || !field) return;

        const item = currentReportVouchers[voucherIndex]?.items[itemIndex];
        if(!item) return;
        
        let value;
        if (field === 'finalParticularsText') {
            value = editableContainer.innerHTML;
        } else if (editableContainer.tagName === 'INPUT' && editableContainer.type === 'number') {
            value = parseFloat(editableContainer.value) || 0;
        } else {
            value = editableContainer.value;
        }

        if (item[field] === value) return;
        
        item[field] = value;
        
        if (['quantitySnapshot', 'rateSnapshot', 'timesdaySnapshot', 'perSnapshot'].includes(field)) {
            const { quantitySnapshot, rateSnapshot, timesdaySnapshot, perSnapshot } = item;
            if (perSnapshot > 0) {
                item.expenditureAmount = (quantitySnapshot * rateSnapshot * timesdaySnapshot) / perSnapshot;
            } else {
                item.expenditureAmount = 0;
            }
             rerenderReport();
        } else {
            saveManualEdits(false);
        }
        
        if (field === 'finalParticularsText' && currentReportParameters.manualRoyaltyData && (currentReportParameters.manualRoyaltyData.sandRate > 0 || currentReportParameters.manualRoyaltyData.redearthRate > 0)) {
            let newTotalSand = 0;
            let newTotalRedearth = 0;
            const sandRegex = /(\d*\.?\d+)\s*cum\s*(?:\.|of)?\s*sand/gi;
            const redearthRegex = /(\d*\.?\d+)\s*cum\s*(?:of)?\s*redearth/gi;

            currentReportVouchers.forEach(voucher => {
                voucher.items.forEach(item => {
                    let match;
                    sandRegex.lastIndex = 0;
                    while ((match = sandRegex.exec(item.finalParticularsText)) !== null) {
                        newTotalSand += parseFloat(match[1]) || 0;
                    }
                    redearthRegex.lastIndex = 0;
                    while ((match = redearthRegex.exec(item.finalParticularsText)) !== null) {
                        newTotalRedearth += parseFloat(match[1]) || 0;
                    }
                });
            });

            currentReportParameters.manualRoyaltyData.sandQty = newTotalSand;
            currentReportParameters.manualRoyaltyData.redearthQty = newTotalRedearth;
            
            const sandTotal = Math.round(newTotalSand * currentReportParameters.manualRoyaltyData.sandRate);
            const redearthTotal = Math.round(newTotalRedearth * currentReportParameters.manualRoyaltyData.redearthRate);
            currentReportParameters.manualRoyaltyData.total = sandTotal + redearthTotal;

            rerenderReport();
        }
    }

    function addEditEventListeners() {
         document.querySelectorAll('.editable-particulars, [contenteditable="true"]').forEach(el => {
            el.addEventListener('blur', (e) => handleReportEdit(e));
        });
        document.querySelectorAll('.editable-input, .editable-select').forEach(el => {
            el.addEventListener('input', (e) => handleReportEdit(e));
        });
    }

    reportOutput.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-item-btn')) {
            if (confirm('Are you sure you want to delete this item?')) {
                const voucherIndex = parseInt(event.target.dataset.voucherIndex, 10);
                const itemIndex = parseInt(event.target.dataset.itemIndex, 10);
                handleDeleteItem(voucherIndex, itemIndex);
            }
        } else if (event.target.classList.contains('add-item-btn')) {
            const voucherIndex = parseInt(event.target.dataset.voucherIndex, 10);
            handleAddItem(voucherIndex);
        } else if (event.target.classList.contains('edit-purchase-btn')) {
            const voucherIndex = parseInt(event.target.dataset.voucherIndex, 10);
            const itemIndex = parseInt(event.target.dataset.itemIndex, 10);
            showPurchaseModal(voucherIndex, itemIndex);
        }
    });


    function saveManualEdits(showAlert = true) {
        if (!currentReportParameters.tokenNo || currentReportVouchers.length === 0) {
            if (showAlert) alert('No active report to save.');
            return;
        }
        
        const finalSvrNo = currentReportVouchers.length > 0 ? currentReportVouchers[currentReportVouchers.length - 1].svrNo : 0;
        saveCurrentReport(currentReportVouchers, { ...currentReportParameters, finalSvrNo });
        if (showAlert) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Your edits have been saved successfully!';
            statusMessage.style.color = 'green';
            setTimeout(() => { statusMessage.textContent = '' }, 3000);
        }
    }
    
    function saveCurrentReport(vouchers, params) {
        const { tokenNo } = params;
        const finalHtml = renderReportHtmlFromData(vouchers, params);
        const workAbstractMarker = '<div class="work-abstract-wrapper">';
        const fac63Marker = '<div class="fac63-wrapper">';
        
        let classifiedAbstractHtml = '';
        let otherPagesHtml = '';

        if (finalHtml.includes(workAbstractMarker)) {
             classifiedAbstractHtml = finalHtml.substring(0, finalHtml.indexOf(workAbstractMarker));
             otherPagesHtml = finalHtml.substring(finalHtml.indexOf(workAbstractMarker));
        } else if (finalHtml.includes(fac63Marker)) {
            classifiedAbstractHtml = finalHtml.substring(0, finalHtml.indexOf(fac63Marker));
            otherPagesHtml = finalHtml.substring(finalHtml.indexOf(fac63Marker));
        } else {
            classifiedAbstractHtml = finalHtml;
        }
        
        const grandTotalEl = document.getElementById('grand-total-value');
        const grandTotalBeforeTaxEl = document.getElementById('grand-total-before-tax-value');
        
        const grandTotal = grandTotalEl ? parseFloat(grandTotalEl.dataset.value) : 0;
        const grandTotalBeforeTax = grandTotalBeforeTaxEl ? parseFloat(grandTotalBeforeTaxEl.dataset.value) : 0;


        const reportToSave = {
            id: currentEditingReportId || Date.now(),
            title: `Report for Token ${params.tokenNo} (${params.month} ${params.year})`,
            mainHeader: `Classified abstract of ${params.rfoName}, ${params.rangeName || ''} for the month ${params.month} ${params.year}`,
            budgetHead: params.budgetHead,
            grandTotal,
            grandTotalBeforeTax,
            month: params.month,
            year: params.year,
            classifiedAbstractHtml,
            otherPagesHtml,
            schemeName: params.schemeName,
            svrNumbersUsed: vouchers.map(v => v.svrNo),
            vouchersData: vouchers,
            inputs: { ...params }
        };

        let reports = getSavedReports();
        const reportIndex = reports.findIndex(r => r.id === currentEditingReportId);

        if (reportIndex !== -1) {
            reports[reportIndex] = reportToSave;
        } else {
            reports = reports.filter(r => !(r.inputs.tokenNo === tokenNo));
            reports.unshift(reportToSave);
        }
        
        saveSavedReports(reports);
        
        if (!currentEditingReportId) {
             currentEditingReportId = reportToSave.id;
        }
    }
    
    function renderFac84Html(vouchers, params) { // vouchers is now an array with one summary object
        const { reportType, rfoName, subDivision, contractorDetails, k2BillNoDate, division, taxes, tenderData, gstData, tokenNo, schemeName, budgetHead, month, year, manualRoyaltyData } = params;
        
        if (!vouchers || vouchers.length === 0) return '';
		
		let voucherSpecificHtml = '';
		vouchers.forEach(voucher => { // This will run once for merged reports, or multiple times for regular reports
			const firstItem = voucher.items[0];
			const rangeName = firstItem.estimate.rangeName || '';
			const formattedDate = formatDateSafely(firstItem.date, '.......................');

			let payeeName = contractorDetails ? contractorDetails.split(',')[0].trim() : '';
			if (reportType === 'non-work' || voucher.payeeDetails) {
				const payeeSource = voucher.payeeDetails ? voucher.payeeDetails.name : (voucher.items[0].finalParticularsText.match(/<b>Payee:<\/b> (.*?)</)?.[1] || 'Payee');
				payeeName = payeeSource.split(',')[0].trim();
			}

			let uniqueEstimateIds, uniqueWorkNames, subTotal, netPayable, itDeductAmount, labourCessDeductAmount, cgstDeductAmount, sgstDeductAmount, royaltyDeductAmount;

            if(voucher.aggregatedSubTotal !== undefined) { // This is a merged summary voucher
                uniqueEstimateIds = [...new Set(currentReportVouchers.flatMap(v => v.items.map(i => i.estimate.id)))];
                uniqueWorkNames = [...new Set(currentReportVouchers.flatMap(v => v.items.map(i => i.estimate.workName)))];
                subTotal = voucher.aggregatedSubTotal;
                itDeductAmount = voucher.aggregatedDeductions.it;
                labourCessDeductAmount = voucher.aggregatedDeductions.labour;
                cgstDeductAmount = voucher.aggregatedDeductions.cgst;
                sgstDeductAmount = voucher.aggregatedDeductions.sgst;
                royaltyDeductAmount = voucher.aggregatedDeductions.royalty;
                netPayable = subTotal - (itDeductAmount + labourCessDeductAmount + cgstDeductAmount + sgstDeductAmount + royaltyDeductAmount);
            } else { // This is a regular, single voucher
			    uniqueEstimateIds = [...new Set(voucher.items.map(i => i.estimate.id))];
			    uniqueWorkNames = [...new Set(voucher.items.map(i => i.estimate.workName))];
                subTotal = voucher.subTotalForDeductions;
                itDeductAmount = voucher.deductions.it;
                labourCessDeductAmount = voucher.deductions.labour;
                cgstDeductAmount = voucher.deductions.cgst;
                sgstDeductAmount = voucher.deductions.sgst;
                royaltyDeductAmount = voucher.deductions.royalty;
			    netPayable = subTotal - (itDeductAmount + labourCessDeductAmount + cgstDeductAmount + sgstDeductAmount + royaltyDeductAmount);
            }

			let deductionHtml = '';
			if (itDeductAmount > 0) deductionHtml += `<tr><td style="border: none; padding: 2px;">${taxes.itPercent}% IT Deduction Rs.</td><td style="border: none; padding: 2px; text-align: right;">${itDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
			if (labourCessDeductAmount > 0) deductionHtml += `<tr><td style="border: none; padding: 2px;">${taxes.labourCessPercent}% Labour Cess Rs.</td><td style="border: none; padding: 2px; text-align: right;">${labourCessDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
			if (cgstDeductAmount > 0) deductionHtml += `<tr><td style="border: none; padding: 2px;">${taxes.cgstPercent}% CGST Deduction Rs.</td><td style="border: none; padding: 2px; text-align: right;">${cgstDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
			if (sgstDeductAmount > 0) deductionHtml += `<tr><td style="border: none; padding: 2px;">${taxes.sgstPercent}% SGST Deduction Rs.</td><td style="border: none; padding: 2px; text-align: right;">${sgstDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
			if (royaltyDeductAmount > 0) {
                 if ((reportType === 'work' || reportType === 'selectedVoucher') && manualRoyaltyData && manualRoyaltyData.total > 0) {
                    deductionHtml += `<tr><td style="border: none; padding: 2px;">Royalty (Sand/Redearth) Rs.</td><td style="border: none; padding: 2px; text-align: right;">${royaltyDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
                } else {
                    deductionHtml += `<tr><td style="border: none; padding: 2px;">${taxes.royaltyPercent}% Royalty Rs.</td><td style="border: none; padding: 2px; text-align: right;">${royaltyDeductAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`;
                }
            }


			const getK2Date = (k2Str) => (k2Str || '').split('Dt:')[1]?.trim() || '.......................';
			const k2Date = getK2Date(k2BillNoDate);

			voucherSpecificHtml += `
			<div class="fac84-wrapper" style="border: 2px solid #4CAF50; padding: 20px; font-family: 'Times New Roman', Times, serif; background-color: #f0fff0;">
				<div style="text-align: center; margin-bottom: 20px;">
					<h3 style="margin: 0; font-weight: bold;">KARNATAKA FOREST DEPARTMENT</h3>
					<h4 style="margin: 5px 0; font-weight: bold;">Piece work Agreement</h4>
					<p style="margin: 5px 0; text-align:right;">FAC-84</p>
				</div>
				<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
					<span contenteditable="true"><strong>R.NO.</strong> ${voucher.svrNo}/2025-26</span>
					<span contenteditable="true"><strong>Date:</strong> ${formattedDate}</span>
				</div>
				<p contenteditable="true"><strong>Name of the Unit:</strong> ${rfoName}, ${rangeName}</p>
				<p contenteditable="true" style="line-height: 1.6;">I / we ${payeeName} forest contractor herby agree to execute the under Mentioned piece work in accordance with the condition noted below in Consideration of the payment being made for the quality of the work executed at schedule of rate ${year}-${parseInt(year.toString().slice(-2)) + 1} when any works are materials for the for the provided by the Government such Materials and the rates to them be paid for shall as provided in the schedule “A”.</p>
				<p contenteditable="true" style="line-height: 1.6;">The rules and regarding execution of works have read by me and I agree to carry cut work mentioned bellow in full conformity with the rules and ordered to hold myself responsible for the proper observance.</p>
				
				<h4 style="text-align: center; text-decoration: underline;">Schedule</h4>
				<table style="width: 100%; border: none;">
					<tr><td style="border: none; padding: 2px; width: 30%;">1. Name of the Place</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${rangeName}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">2. Name of the Range</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${rfoName}, ${rangeName}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">3. Name of the work</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${uniqueWorkNames.join(', ')}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">4. Head of Account</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${budgetHead}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">5. S.O No</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${uniqueEstimateIds.join(', ')}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">6. Quality</td><td style="border: none; padding: 2px;">: <span contenteditable="true">As per Estimate</span></td></tr>
					<tr><td style="border: none; padding: 2px;">7. Rate claimed</td><td style="border: none; padding: 2px;">: <span contenteditable="true">As per Estimate</span></td></tr>
					<tr><td style="border: none; padding: 2px;">8. Amount</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></td></tr>
					<tr><td style="border: none; padding: 2px;">9. Period of work execution</td><td style="border: none; padding: 2px;">: <span contenteditable="true">${year}</span></td></tr>
				</table>
				
				<div style="display: flex; justify-content: space-between; margin-top: 50px; font-weight: bold;">
					<div style="text-align: left;">
						<p>Place: ${division.split(' ')[0]}</p>
						<p>Date:</p>
					</div>
					<div style="text-align: right;">
						 <p style="margin-bottom: 60px;">Signature of piece work<br>Contractor</p>
						 <p>${rfoName}<br>${rangeName}</p>
					</div>
				</div>
				<p style="margin-top: 30px;" contenteditable="true">The Above agreement is here by accepted by me us on behalf of the government of Karnataka.</p>
				<div style="text-align: right; margin-top: 40px; font-weight: bold;">
					<p>Deputy Conservator of Forest<br>${division}</p>
				</div>
			</div>
			<div class="fac84-office-use-wrapper page-break-before: always;" style="padding: 20px; font-family: 'Times New Roman', Times, serif;">
				<h4 style="text-align: center; text-decoration: underline;">(For use in the Office)</h4>
				<p contenteditable="true" style="line-height: 1.6;">Received Rs. ${netPayable.toLocaleString('en-IN', {minimumFractionDigits: 2})}/- (${numberToWordsLocal(netPayable)}) By Cash and by adjustment of payment as per Memorandum. (in final settlement of all demands).</p>
				<p>Witnesses:</p>
				<p contenteditable="true">1.</p>
				<p contenteditable="true">2.</p>
				<div style="text-align: right; margin-top: 40px; margin-bottom: 40px;">
					 <p style="margin-bottom: 30px;">Signature of Contractor.</p>
				</div>
				<p contenteditable="true">Paid by me vide K2 Bill No & Date: ${k2BillNoDate || '.......................'}</p>
				
				<table style="width: 400px; margin-left: auto; margin-right: 0; border: none;">
					<tr><td style="border: none; padding: 2px;">Total Amount Rs.</td><td style="border: none; padding: 2px; text-align: right;">${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
					${deductionHtml}
					<tr style="font-weight: bold;"><td style="border: none; border-top: 1px solid black; padding: 2px;">Net Payable Rs.</td><td style="border: none; border-top: 1px solid black; padding: 2px; text-align: right;">${netPayable.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>
				</table>
				
				<p style="margin-top: 30px;" contenteditable="true">Cash Rs. Passed for Rs. ${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}/- (${numberToWordsLocal(subTotal)}) initial of Officer making payment.</p>
				<p contenteditable="true">K2 Bill Date: ${k2Date}</p>
				<div style="display: flex; justify-content: space-between; margin-top: 80px; font-weight: bold;">
					<div style="text-align: left;">
						 <p>${rfoName}<br>${rangeName}</p>
					</div>
					<div style="text-align: right;">
						 <p>Deputy Conservator of Forests.<br>${division}</p>
					</div>
				</div>
			</div>
			`;
		});
		return voucherSpecificHtml;
    }

    function renderReportHtmlFromData(vouchers, params) {
        const { reportType, rfoName, subDivision, agreementData, workOrderData, contractorDetails, k2BillNoDate, division, taxes, tenderData, gstData, nonWorkPayees, tokenNo, schemeName, budgetHead, month, year, selectedVoucherSubType, manualRoyaltyData } = params;
        
        let royaltyChartShown = false; // Flag to ensure the royalty chart is only shown once per report.

        vouchers.forEach(voucher => {
            voucher.items.forEach(item => {
                if (!item.finalParticularsText && item.particularsTextSnapshot) {
                    item.finalParticularsText = item.particularsTextSnapshot;
                }
            });
        });

        const firstTx = vouchers[0]?.items[0];
        if (!firstTx) return '<p>No data to display.</p>';

        const rangeName = firstTx.estimate.rangeName || '';
        params.rangeName = rangeName;

        let classifiedAbstractHtml = '';
        let newPagesHtml = '';
        let grandTotal = 0;
        let grandTotalBeforeTax = 0;
        const formatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
		
		// Payee Wise Summary data collection
		let payeeWiseTotals = {};
        
        // --- START: Pre-calculation of totals and deductions ---
        vouchers.forEach(voucher => {
            let voucherNetAfterTender = 0;
            voucher.items.forEach(tx => {
                const grossAmount = tx.expenditureAmount;
                const roundedGrossAmount = Math.round(grossAmount);
                const tenderPercent = (tenderData && tenderData[tx.estimate.id] !== undefined) ? tenderData[tx.estimate.id] : 0;
                const itemDeduction = (roundedGrossAmount * tenderPercent) / 100;
                voucherNetAfterTender += (roundedGrossAmount - Math.round(itemDeduction));
            });
            
            voucher.netAfterTender = voucherNetAfterTender;

            let subTotalForDeductions = voucherNetAfterTender;
            if ((['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) && gstData) {
                let applyGst = true;
                if(reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                if(applyGst) {
                    const addCgstAmount = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                    const addSgstAmount = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                    subTotalForDeductions += addCgstAmount + addSgstAmount;
                }
            }
            voucher.subTotalForDeductions = subTotalForDeductions;
            grandTotalBeforeTax += subTotalForDeductions;
        });

        let totalManualRoyaltyDistributed = 0;
        vouchers.forEach((voucher, index) => {
            const subTotal = voucher.subTotalForDeductions;
            let royaltyDeduct = 0;
            
            if (reportType === 'civil') {
                royaltyDeduct = Math.round((subTotal * taxes.royaltyPercent) / 100);
            } else if ((reportType === 'work' || reportType === 'selectedVoucher') && manualRoyaltyData && manualRoyaltyData.total > 0) {
                if (index === vouchers.length - 1) { // Last voucher gets the remainder
                    royaltyDeduct = manualRoyaltyData.total - totalManualRoyaltyDistributed;
                } else if (grandTotalBeforeTax > 0) {
                    royaltyDeduct = Math.round((subTotal / grandTotalBeforeTax) * manualRoyaltyData.total);
                    totalManualRoyaltyDistributed += royaltyDeduct;
                }
            } else {
                royaltyDeduct = 0; 
            }
            
            // --- START: MODIFIED LOGIC FOR CGST/SGST DEDUCTION ---
            let totalCgstDeduct = 0;
            let totalSgstDeduct = 0;

            voucher.items.forEach(tx => {
                let deductionBase = 0;

                const isPurchaseItem = /purchase|cost of/i.test(tx.particularsTextSnapshot || tx.finalParticularsText || '');

                if (isPurchaseItem && tx.purchaseDetails && tx.purchaseDetails.original > 0) {
                    // Requirement Met: Use original bill amount as base
                    deductionBase = tx.purchaseDetails.original;
                } else {
                    // Standard Logic: Use net after tender for the individual item
                    const tenderPercent = (tenderData && tenderData[tx.estimate.id] !== undefined) ? tenderData[tx.estimate.id] : 0;
                    const itemNetAfterTender = Math.round(tx.expenditureAmount) - Math.round((Math.round(tx.expenditureAmount) * tenderPercent) / 100);
                    deductionBase = itemNetAfterTender;
                }
                
                totalCgstDeduct += Math.round((deductionBase * taxes.cgstPercent) / 100);
                totalSgstDeduct += Math.round((deductionBase * taxes.sgstPercent) / 100);
            });
            // --- END: MODIFIED LOGIC FOR CGST/SGST DEDUCTION ---

            voucher.deductions = {
                it: Math.round((subTotal * taxes.itPercent) / 100),
                labour: Math.round((subTotal * taxes.labourCessPercent) / 100),
                cgst: totalCgstDeduct, // Use new aggregated value
                sgst: totalSgstDeduct, // Use new aggregated value
                royalty: royaltyDeduct
            };
        });
        // --- END: Pre-calculation ---


        vouchers.forEach(voucher => {
            let currentPayee = 'Unknown';
            if (voucher.payeeDetails) {
                currentPayee = voucher.payeeDetails.fullDetails || voucher.payeeDetails.name;
            } else if (reportType === 'non-work') {
                const payeeMatch = voucher.items[0]?.finalParticularsText.match(/<b>Payee:<\/b> (.*?)</);
                if (payeeMatch) currentPayee = payeeMatch[1];
            } else {
                currentPayee = contractorDetails;
            }

            if (!payeeWiseTotals[currentPayee]) {
                payeeWiseTotals[currentPayee] = { billAmount: 0, addCgst: 0, addSgst: 0, it: 0, labour: 0, cgst: 0, sgst: 0, royalty: 0, netPaid: 0 };
            }
			
            let addCgstAmount = 0, addSgstAmount = 0;
            if ((['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) && gstData) {
                let applyGst = true;
                if(reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                if(applyGst) {
                    let voucherNetAfterTender = voucher.items.reduce((sum, tx) => {
                         const tenderPercent = (tenderData && tenderData[tx.estimate.id] !== undefined) ? tenderData[tx.estimate.id] : 0;
                         return sum + (Math.round(tx.expenditureAmount) - Math.round((Math.round(tx.expenditureAmount) * tenderPercent) / 100));
                    }, 0);
                    addCgstAmount = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                    addSgstAmount = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                }
            }

            const totalDeductions = Object.values(voucher.deductions).reduce((a, b) => a + b, 0);
			const netPayable = voucher.subTotalForDeductions - totalDeductions;

            payeeWiseTotals[currentPayee].billAmount += voucher.subTotalForDeductions;
            payeeWiseTotals[currentPayee].addCgst += addCgstAmount;
            payeeWiseTotals[currentPayee].addSgst += addSgstAmount;
            payeeWiseTotals[currentPayee].it += voucher.deductions.it;
            payeeWiseTotals[currentPayee].labour += voucher.deductions.labour;
            payeeWiseTotals[currentPayee].cgst += voucher.deductions.cgst;
            payeeWiseTotals[currentPayee].sgst += voucher.deductions.sgst;
            payeeWiseTotals[currentPayee].royalty += voucher.deductions.royalty;
            payeeWiseTotals[currentPayee].netPaid += netPayable;
        });

        classifiedAbstractHtml = `<div><div class="main-report-header"><h2>Classified abstract of ${rfoName}, ${rangeName} for the month ${month} ${year}</h2><h3>Budget Head: ${budgetHead || ''}</h3><h3>Scheme: ${schemeName || ''}</h3></div><hr style="border: 1px solid black;"><div class="report-wrapper"><div class="report"><table><thead><tr><th>Particulars of works</th><th class="amount" style="width: 15%;">Amount</th></tr></thead><tbody>`;
        let mainSrNoCounter = 1;
        vouchers.forEach((voucher, voucherIndex) => {
            let voucherTotalForAbstract = 0;
            let lastEstimateId = null;

            voucher.items.forEach((tx, itemIndex) => {
                 if (reportType === 'e-procurmentTender' && tx.estimate.id !== lastEstimateId) {
                    classifiedAbstractHtml += `<tr><td colspan="2" style="background-color: #e0e0e0; font-weight: bold; text-align: center;">Estimate No: ${tx.estimate.id}</td></tr>`;
                    lastEstimateId = tx.estimate.id;
                }

                let srNoDisplay = (itemIndex === 0 && reportType !== 'e-procurmentTender') ? mainSrNoCounter : (reportType === 'e-procurmentTender' ? itemIndex + 1 : '');
                let svrNoDisplay = (reportType === 'e-procurmentTender') ? voucher.svrNo : (voucher.items.length > 1 ? `${voucher.svrNo}/${itemIndex + 1}` : `${voucher.svrNo}`);

                let grossAmount = tx.expenditureAmount;
                let roundedGrossAmount = Math.round(grossAmount);
                const tenderPercent = (tenderData && tenderData[tx.estimate.id] !== undefined) ? tenderData[tx.estimate.id] : 0;
                const itemDeduction = (roundedGrossAmount * tenderPercent) / 100;
                const roundedItemTenderDeduction = Math.round(itemDeduction);
                const netItemAmount = roundedGrossAmount - roundedItemTenderDeduction;
                
                voucherTotalForAbstract += netItemAmount;

                const unitOptions = ['Days', 'Nos', 'Ls', 'rmt', 'Cmt', 'pbs', 'plant','km','time','seedls', 'seeds', 'kg','Cum','grms','logs','poles', 'Smt'].map(u => `<option value="${u}" ${tx.unitSnapshot === u ? 'selected' : ''}>${u}</option>`).join('');
                
                let royaltyChartHtml = '';
                if (!royaltyChartShown && manualRoyaltyData && manualRoyaltyData.total > 0 && /sand|redearth/i.test(tx.finalParticularsText)) {
                    const sandTotal = Math.round(manualRoyaltyData.sandQty * manualRoyaltyData.sandRate);
                    const redearthTotal = Math.round(manualRoyaltyData.redearthQty * manualRoyaltyData.redearthRate);
                    const roundedTotal = sandTotal + redearthTotal;
                    
                    royaltyChartHtml = `
                    <div class="royalty-calculation-chart" style="margin-left: 130px; padding: 8px; border: 1px dashed #555; margin-top: 8px; font-size: 0.9em; background-color: #f9f9f9;">
                        <strong style="text-decoration: underline;">Royalty Calculation Details:</strong>
                        <table style="width: auto; margin-top: 5px; border: none; font-size: 0.95em;">
                            <tbody>
                                <tr style="border: none;">
                                    <td style="border: none; padding: 2px 8px;">${manualRoyaltyData.sandQty.toFixed(2)} cum. of Sand</td>
                                    <td style="border: none; padding: 2px 8px;">x ${manualRoyaltyData.sandRate.toFixed(2)}/-</td>
                                    <td style="border: none; padding: 2px 8px; text-align: right;">= ${sandTotal.toLocaleString('en-IN', formatOptions)}/-</td>
                                </tr>
                                <tr style="border: none;">
                                    <td style="border: none; padding: 2px 8px;">${manualRoyaltyData.redearthQty.toFixed(2)} cum of Redearth</td>
                                    <td style="border: none; padding: 2px 8px;">x ${manualRoyaltyData.redearthRate.toFixed(2)}/-</td>
                                    <td style="border: none; padding: 2px 8px; text-align: right;">= ${redearthTotal.toLocaleString('en-IN', formatOptions)}/-</td>
                                </tr>
                                <tr style="border: none; font-weight: bold; border-top: 1px solid #999;">
                                    <td style="border: none; padding: 4px 8px 2px;" colspan="2">Total Royalty:</td>
                                    <td style="border: none; padding: 4px 8px 2px; text-align: right;">= ${roundedTotal.toLocaleString('en-IN', formatOptions)}/-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;
                    royaltyChartShown = true;
                }

                const showPurchaseBtn = /purchase|cost of/i.test(tx.particularsTextSnapshot);
                let purchaseChartHtml = '';
                if (tx.purchaseDetails) {
                    const { original, cgst, sgst } = tx.purchaseDetails;
                    const cgstAmount = original * (cgst / 100);
                    const sgstAmount = original * (sgst / 100);
                    const total = original + cgstAmount + sgstAmount;
                    purchaseChartHtml = `<div class="purchase-calculation-chart" style="margin-left: 130px; padding: 8px; border: 1px dashed #555; margin-top: 8px; font-size: 0.9em; background-color: #f0f8ff;"><strong style="text-decoration: underline;">Purchase Calculation:</strong><table style="width: auto; margin-top: 5px; border: none; font-size: 0.95em;"><tbody><tr style="border: none;"><td style="border: none; padding: 2px 8px;">Original Bill Amount:</td><td class="amount" style="border: none; padding: 2px 8px;">${original.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none;"><td style="border: none; padding: 2px 8px;">CGST (${cgst.toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${cgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none;"><td style="border: none; padding: 2px 8px;">SGST (${sgst.toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${sgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none; font-weight: bold; border-top: 1px solid #999;"><td style="border: none; padding: 4px 8px 2px;">Total:</td><td class="amount" style="border: none; padding: 4px 8px 2px;">${Math.round(total).toLocaleString('en-IN', formatOptions)}</td></tr></tbody></table></div>`;
                }


                classifiedAbstractHtml += `<tr style="vertical-align: top;"><td><div style="display: flex; align-items: flex-start; width: 100%;"><div style="flex: 0 0 120px; padding-right: 10px; font-weight: bold; line-height: 1.5;">${srNoDisplay ? `Sr.No: ${srNoDisplay}<br>` : ''}${!srNoDisplay && reportType === 'e-procurmentTender' ? `Sr.No: ${srNoDisplay}<br>`:''}SVr, no: ${svrNoDisplay}<button class="no-print delete-item-btn" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}">❌</button>${showPurchaseBtn ? `<button class="no-print edit-purchase-btn" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}">Edit Purchase Details</button>` : ''}</div><div style="flex: 1; border-left: 1px solid #eee; padding-left: 10px;"><div class="editable-particulars" contenteditable="true" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="finalParticularsText">${tx.finalParticularsText}</div>${royaltyChartHtml}${purchaseChartHtml}</div></div><div style="display: flex; justify-content: flex-end; margin-top: 8px; padding-right: 5px;"><table style="width: auto; border: none; font-size: 0.9em; margin-left: auto;"><thead style="font-weight: bold;"><tr style="background-color: #fafafa;">
                <td style="border:2px solid black; text-align:center; width: 8%;">Quantity</td>
                <td style="border:2px solid black; text-align:center; width: 8%;">Rate</td>
                <td style="border:2px solid black; text-align:center; width: 8%;">Times/day</td>
                <td style="border:2px solid black; text-align:center; width: 8%;">Unit</td>
                <td style="border:2px solid black; text-align:center; width: 8%;">Per</td>
                <td style="border:2px solid black; text-align:center; width: 10%;">Item sub amount</td></tr></thead><tbody><tr>
                <td style="border:2px solid black;" class="amount"><input type="number" class="editable-input" value="${parseFloat(tx.quantitySnapshot.toFixed(3))}" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="quantitySnapshot"></td>
                <td style="border:2px solid black;" class="amount"><input type="number" class="editable-input" value="${tx.rateSnapshot}" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="rateSnapshot"></td>
                <td style="border:2px solid black;" class="amount"><input type="number" class="editable-input" value="${tx.timesdaySnapshot}" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="timesdaySnapshot"></td>
                <td style="border:2px solid black;" class="amount"><select class="editable-select" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="unitSnapshot">${unitOptions}</select></td>
                <td style="border:2px solid black;" class="amount"><input type="number" class="editable-input" value="${tx.perSnapshot}" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" data-field="perSnapshot"></td>
                <td style="border:2px solid black;" class="amount">${roundedGrossAmount.toLocaleString('en-IN', formatOptions)}</td></tr></tbody></table></div>${tenderPercent > 0 ? `<div style="text-align: right; padding-right: 5px; font-style: italic; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">Less: ${tenderPercent.toFixed(2)}% value (${roundedItemTenderDeduction.toLocaleString('en-IN', formatOptions)})</div>` : ''}</td><td class="amount" style="font-weight: bold; vertical-align: bottom;">${netItemAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
            });
            if (voucher.items.length > 0) {
                mainSrNoCounter++;
                if (reportType !== 'e-procurmentTender') {
                    classifiedAbstractHtml += `<tr><td colspan="2"><button class="no-print add-item-btn" data-voucher-index="${voucherIndex}">➕ Add Item to SVr, no. ${voucher.svrNo}</button></td></tr>`;
                }
            }
            if ((['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) && gstData) {
                let applyGst = true;
                if(reportType === 'timber' && voucher.isEngagingVoucher) {
                    applyGst = false;
                }

                if(applyGst) {
                    const addCgstAmount = Math.round((voucherTotalForAbstract * gstData.cgst) / 100);
                    const addSgstAmount = Math.round((voucherTotalForAbstract * gstData.sgst) / 100);
                    
                    if (addCgstAmount > 0) {
                        classifiedAbstractHtml += `<tr><td style="text-align: right; font-style: italic;">ADD CGST ${gstData.cgst}%</td><td class="amount" style="font-style: italic;">${addCgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                    }
                    if (addSgstAmount > 0) {
                        classifiedAbstractHtml += `<tr><td style="text-align: right; font-style: italic;">ADD SGST ${gstData.sgst}%</td><td class="amount" style="font-style: italic;">${addSgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                    }
                }
            }
            
            const subTotalForDeductions = voucher.subTotalForDeductions;
            grandTotal += subTotalForDeductions;

            if (reportType !== 'e-procurmentTender') {
                classifiedAbstractHtml += `<tr><td style="text-align: right; font-weight: bold; background-color: #f2f2f2;">Net Total for SVr, no. ${voucher.svrNo}</td><td class="amount" style="font-weight: bold; background-color: #f2f2f2;">${subTotalForDeductions.toLocaleString('en-IN', formatOptions)}</td></tr>`;
            }
        });

        classifiedAbstractHtml += `<tr><td style="text-align: right; font-weight: bold;">Grand Total</td><td class="amount" style="font-weight: bold;">${grandTotalBeforeTax.toLocaleString('en-IN', formatOptions)}</td></tr></tbody></table></div></div>`;
        
        let abstractDataForTable = {};
        vouchers.forEach(v => {
            const amountForAbstract = v.subTotalForDeductions;
            const voucherGrossTotal = v.items.reduce((sum, item) => sum + Math.round(item.expenditureAmount), 0);
            if (voucherGrossTotal > 0) {
                v.items.forEach(tx => {
                    if (!abstractDataForTable[tx.estimate.id]) abstractDataForTable[tx.estimate.id] = 0;
                    abstractDataForTable[tx.estimate.id] += (amountForAbstract * (Math.round(tx.expenditureAmount) / voucherGrossTotal));
                });
            }
        });
		
		// Payee Wise Summary table generation
		let payeeSummaryRows = '';
		let totalSummary = { billAmount: 0, addCgst: 0, addSgst: 0, it: 0, labour: 0, cgst: 0, sgst: 0, royalty: 0, netPaid: 0 };
        Object.keys(payeeWiseTotals).forEach(payee => {
            const d = payeeWiseTotals[payee];
            const totalDeductions = d.it + d.labour + d.cgst + d.sgst + d.royalty;
            payeeSummaryRows += `
                <tr>
                    <td>${payee}</td>
                    <td class="amount">${d.billAmount.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.addCgst.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.addSgst.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.it.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.labour.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.cgst.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.sgst.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.royalty.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${totalDeductions.toLocaleString('en-IN', formatOptions)}</td>
                    <td class="amount">${d.netPaid.toLocaleString('en-IN', formatOptions)}</td>
                </tr>
            `;
			Object.keys(totalSummary).forEach(key => totalSummary[key] += d[key]);
        });

		const totalSummaryDeductions = totalSummary.it + totalSummary.labour + totalSummary.cgst + totalSummary.sgst + totalSummary.royalty;
		const summaryFooter = `
			<tr style="font-weight: bold; background-color: #f2f2f2;">
				<td>Grand Total</td>
				<td class="amount">${totalSummary.billAmount.toLocaleString('en-IN', formatOptions)}</td>
                <td class="amount">${totalSummary.addCgst.toLocaleString('en-IN', formatOptions)}</td>
                <td class="amount">${totalSummary.addSgst.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.it.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.labour.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.cgst.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.sgst.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.royalty.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummaryDeductions.toLocaleString('en-IN', formatOptions)}</td>
				<td class="amount">${totalSummary.netPaid.toLocaleString('en-IN', formatOptions)}</td>
			</tr>
		`;


        let abstractRows = ''; Object.keys(abstractDataForTable).forEach((estimateId, index) => { abstractRows += `<tr><td>${index + 1}</td><td>${estimateId}</td><td class="amount">${Math.round(abstractDataForTable[estimateId]).toLocaleString('en-IN', formatOptions)}</td></tr>`; });
        
        // UPDATE: Ensure unique token numbers are displayed
        const uniqueTokens = [...new Set((tokenNo || '').toString().split(',').map(t => t.trim()))].join(', ');
        
        classifiedAbstractHtml += `<div class="grand-total-section" style="page-break-before: auto;"><div class="abstract-section"><div class="abstract-table"><h3>ABSTRACT</h3><table><thead><tr><th style="width: 15%;">Sr,No</th><th>DSO:/CCFSO:/PCCFSO:</th><th class="amount">Total amount</th></tr></thead><tbody>${abstractRows}</tbody><tfoot><tr><td colspan="2" style="text-align: right;"><strong>Grand Total</strong></td><td class="amount"><strong>${grandTotalBeforeTax.toLocaleString('en-IN', formatOptions)}</strong></td></tr></tfoot></table></div>
		<div class="payee-wise-summary"><h3>Payee Wise Summary</h3><table><thead>
		<tr><th>Payee Name</th><th class="amount">Total Bill</th><th class="amount">ADD CGST</th><th class="amount">ADD SGST</th><th class="amount">IT</th><th class="amount">Labour</th><th class="amount">CGST</th><th class="amount">SGST</th><th class="amount">Royalty</th><th class="amount">Total Ded.</th><th class="amount">Net Paid</th></tr>
		</thead><tbody>${payeeSummaryRows}</tbody><tfoot>${summaryFooter}</tfoot></table></div>
		</div><div class="grand-total"><h3 id="grand-total-value" data-value="${grandTotalBeforeTax}">Grand Total for Token No: ${uniqueTokens}</h3><h3 id="grand-total-before-tax-value" data-value="${grandTotalBeforeTax}">Grand Total Amount: ${grandTotalBeforeTax.toLocaleString('en-IN', formatOptions)}/-</h3><p>In Words: ${numberToWordsLocal(grandTotalBeforeTax)}</p></div><div class="signature-container"><div class="acf-signature"><p>Submitted for Rs. ${grandTotalBeforeTax.toLocaleString('en-IN', formatOptions)}/-</p><p>${numberToWordsLocal(grandTotalBeforeTax)}</p><p style="margin-top: 30px;">Assistent Conservator of Forests</p><p>${subDivision}</p></div><div class="rfo-signature"><p>${rfoName}</p><p>${rangeName}</p></div></div></div></div>`;
        
        if (reportType === 'non-work' || (reportType === 'selectedVoucher' && selectedVoucherSubType === 'fac63')) {
             vouchers.forEach((voucher, voucherIndex) => {
                const item = voucher.items[0];
                if (!item) return;

                const est = item.estimate;
                const formattedDate = formatDateSafely(item.date, '.......................');
                
				let payeeName = contractorDetails ? contractorDetails.split(',')[0].trim() : '';
				if (reportType === 'non-work' || voucher.payeeDetails) {
					const payeeSource = voucher.payeeDetails ? voucher.payeeDetails.name : (item.finalParticularsText.match(/<b>Payee:<\/b> (.*?)</)?.[1] || 'Payee');
					payeeName = payeeSource.split(',')[0].trim();
				}

                const allCmDatesForPages = [...new Set(voucher.items.map(i => i.checkMeasurementDate).filter(Boolean))].join(', ');

                let fac63Particulars, voucherGrossTotal, voucherNetAfterTender, subTotal, netPayable;
                let calculationRows = '';
                
                voucherGrossTotal = voucher.items.reduce((sum, tx) => sum + Math.round(tx.expenditureAmount), 0);
                voucherNetAfterTender = voucher.items.reduce((sum, tx) => {
                    const tenderPercent = tenderData[tx.estimate.id] || 0;
                    const itemDeduction = (Math.round(tx.expenditureAmount) * tenderPercent) / 100;
                    return sum + (Math.round(tx.expenditureAmount) - Math.round(itemDeduction));
                }, 0);

                let addCgstAmount = 0;
                let addSgstAmount = 0;
                if ((['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) && gstData) {
                    let applyGst = true;
                    if(reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                    if(applyGst) {
                        addCgstAmount = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                        addSgstAmount = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                    }
                }
                
                subTotal = voucher.subTotalForDeductions;
                const {it, labour, cgst, sgst, royalty} = voucher.deductions;
                const totalDeductions = it + labour + cgst + sgst + royalty;
                netPayable = subTotal - totalDeductions;
                
                if (reportType === 'selectedVoucher' || reportType === 'non-work') {
                    let voucherWorkAbstractHtml = '';
                    voucher.items.forEach((tx, itemIndex) => {
                        const roundedItemGrossAmount = Math.round(tx.expenditureAmount);
                        const tenderPercent = tenderData[tx.estimate.id] || 0;
                        const roundedItemTenderDeduction = Math.round((roundedItemGrossAmount * tenderPercent) / 100);
                        voucherWorkAbstractHtml += `<tr><td style="text-align: center;">${itemIndex + 1}</td><td>${tx.finalParticularsText}</td><td style="text-align: right;">${parseFloat(tx.quantitySnapshot.toFixed(3))}</td><td style="text-align: right;">${tx.rateSnapshot.toFixed(2)}</td><td style="text-align: center;">${tx.timesdaySnapshot}</td><td style="text-align: center;">${tx.unitSnapshot}</td><td style="text-align: center;">${tx.perSnapshot}</td><td style="text-align: right;">${roundedItemGrossAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                        if (tenderPercent > 0) { voucherWorkAbstractHtml += `<tr><td colspan="7" style="text-align: right; font-style: italic; border-top: 1px dashed #ccc;">Less Tender: ${tenderPercent.toFixed(2)}%</td><td style="text-align: right; font-style: italic; border-top: 1px dashed #ccc;">(${roundedItemTenderDeduction.toLocaleString('en-IN', formatOptions)})</td></tr>`; }
                    });
                    fac63Particulars = `<div class="work-abstract-wrapper" style="margin: 0; padding: 0;"><table class="wa-table" style="margin: 0; border: none;"><thead><tr><th>Sl.No</th><th>PARTICULARS</th><th>Qty</th><th>Rate</th><th>Times/day</th><th>Unit</th><th>Per</th><th>Total</th></tr></thead><tbody>${voucherWorkAbstractHtml}</tbody></table></div>`;
                }

                calculationRows += `<tr class="sub-total"><td colspan="8" style="text-align: right; font-weight: bold;">Total Amount :</td><td style="text-align: right; font-weight: bold;">${voucherGrossTotal.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                calculationRows += `<tr class="sub-total"><td colspan="8" style="text-align: right; font-weight: bold;">Net Total:</td><td style="text-align: right; font-weight: bold;">${voucherNetAfterTender.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                if (addCgstAmount > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Add: CGST ${gstData.cgst.toFixed(2)}%</td><td style="text-align: right;">${addCgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                if (addSgstAmount > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Add: SGST ${gstData.sgst.toFixed(2)}%</td><td style="text-align: right;">${addSgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                calculationRows += `<tr class="sub-total"><td colspan="8" style="text-align: right; font-weight: bold;">Subtotal:</td><td style="text-align: right; font-weight: bold;">${subTotal.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                if (it > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Less: IT ${taxes.itPercent.toFixed(2)}%</td><td style="text-align: right;">(${it.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                if (labour > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Less Labour Cess: ${taxes.labourCessPercent.toFixed(2)}%</td><td style="text-align: right;">(${labour.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                if (cgst > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Less: CGST ${taxes.cgstPercent.toFixed(2)}%</td><td style="text-align: right;">(${cgst.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                if (sgst > 0) calculationRows += `<tr><td colspan="8" style="text-align: right;">Less: SGST ${taxes.sgstPercent.toFixed(2)}%</td><td style="text-align: right;">(${sgst.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                if (royalty > 0) {
                     let royaltyText = `Less Royalty: ${taxes.royaltyPercent.toFixed(2)}%`;
                     if((reportType === 'work' || reportType === 'selectedVoucher') && manualRoyaltyData && manualRoyaltyData.total > 0) {
                        royaltyText = `Less Royalty (Manual)`;
                     }
                     calculationRows += `<tr><td colspan="8" style="text-align: right;">${royaltyText}</td><td style="text-align: right;">(${royalty.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                }
                calculationRows += `<tr class="sub-total"><td colspan="8" style="text-align: right; font-weight: bold;">Total deduction amount ;</td><td style="text-align: right; font-weight: bold;">${totalDeductions.toLocaleString('en-IN', formatOptions)}</td></tr>`;
                calculationRows += `<tr class="sub-total"><td colspan="8" style="text-align: right; font-weight: bold;">Net Payment:</td><td style="text-align: right; font-weight: bold;">${netPayable.toLocaleString('en-IN', formatOptions)}</td></tr>`;

                newPagesHtml += `<div class="fac63-wrapper" style="border: 2px solid black; padding: 20px; font-family: 'Times New Roman', Times, serif;">
                    <div class="fac63-header" style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-weight: bold;">KARNATAKA FOREST DEPARTMENT</h3>
                        <h4 style="margin: 5px 0; font-weight: bold;">${division}</h4>
                        <p style="margin: 5px 0; font-weight: bold; text-decoration: underline;">Form FAC-63</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="width: 50%; border: 1px solid black; padding: 5px;"><strong>Head of Account:</strong> ${budgetHead}<br><strong>Location:</strong> ${est.location || ''}<br><strong>Division:</strong> ${division}<br><strong>Sub Division:</strong> ${subDivision}</td>
                            <td style="width: 50%; border: 1px solid black; padding: 5px; vertical-align: top;"><strong>Vr.No.:</strong> ${voucher.svrNo}<br><strong>Date:</strong> ${formattedDate}<br><strong>Range:</strong> ${rangeName}<br><strong>Section:</strong> ${rangeName}</td>
                        </tr>
                    </table>
                    <table class="fac63-main-table" style="width: 100%; border: 2px solid black; border-collapse: collapse;">
                       <tbody><tr><td colspan="9" style="padding:0;">${fac63Particulars}</td></tr></tbody>
                        <tfoot>${calculationRows}</tfoot>
                    </table>
                    <div class="fac63-footer" style="margin-top: 30px; line-height: 1.8;">
                        <p>Received the above amount of Rs. <strong>${netPayable.toLocaleString('en-IN', formatOptions)}</strong> (${numberToWordsLocal(netPayable)}) by adjustment of advance / cash in full / part Settlement of the bill / claim.</p>
                        <div style="text-align: right; margin-top: 40px; margin-bottom: 40px; padding-right: 50px;"><p style="border-top: 1px dotted black; display: inline-block; padding-top: 5px;">Signature of the payee</p></div>
                        <p>Certified that the work has been carried out completely and satisfactorily and the same has been checked by Range forest officer and checked by Asst. Conservator of Forests on C.M DATE: ${allCmDatesForPages || '-'}</p>
                        <p>The amount of Rs. <strong>${subTotal.toLocaleString('en-IN', formatOptions)}</strong> (${numberToWordsLocal(subTotal)}) has been disbursed by me through K2 Bill No & Date: ${k2BillNoDate || '.......................'}</p>
                        <div style="text-align: right; margin-top: 40px; font-weight: bold;"><p style="margin: 0;">${rfoName}</p><p style="margin: 0;">${rangeName}</p></div>
                        <p style="margin-top: 40px;">Paid and Passed for Rs. <strong>${subTotal.toLocaleString('en-IN', formatOptions)}</strong> (${numberToWordsLocal(subTotal)})</p>
                        <div style="text-align: right; margin-top: 40px; font-weight: bold;"><p style="margin: 0;">Deputy Conservator of Forests</p><p style="margin: 0;">${division}</p></div>
                    </div>
                </div>`;
            });
        } else if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) {
            vouchers.forEach((voucher, voucherIndex) => {
                 const firstItem = voucher.items[0];
                 if (!firstItem) return;
                 const est = firstItem.estimate; const formattedItemDate = formatDateSafely(firstItem.date, '');
                 const currentAgreementNo = agreementData[est.id] || est.agreementNo || '----'; const currentWorkOrder = workOrderData[est.id] || '----';
                 const allCmDatesForPages = [...new Set(voucher.items.map(item => item.checkMeasurementDate).filter(Boolean))].join(', ');
                 const checkDate = allCmDatesForPages || '.......................';
				 
				 let currentPayeeDetails = contractorDetails;
				 if (voucher.payeeDetails) { // For merged reports
					currentPayeeDetails = voucher.payeeDetails.fullDetails || voucher.payeeDetails.name;
				 }
				 
                 let voucherGrossTotal = 0; let voucherNetAfterTender = 0; let workAbstractItemsHtml = ''; let lastEstIdWA = null;
                 voucher.items.forEach((tx, itemIndex) => {
                    if (reportType === 'e-procurmentTender' && tx.estimate.id !== lastEstIdWA) {
                        workAbstractItemsHtml += `<tr><td colspan="8" style="background-color: #e0e0e0; font-weight: bold; text-align: center;">Estimate No: ${tx.estimate.id}</td></tr>`;
                        lastEstIdWA = tx.estimate.id;
                    }
                     const itemGrossAmount = tx.expenditureAmount;
                     const roundedItemGrossAmount = Math.round(itemGrossAmount);
                     voucherGrossTotal += roundedItemGrossAmount;
                     const tenderPercent = tenderData[tx.estimate.id] || 0;
                     const itemTenderDeduction = (roundedItemGrossAmount * tenderPercent) / 100;
                     const roundedItemTenderDeduction = Math.round(itemTenderDeduction);
                     voucherNetAfterTender += (roundedItemGrossAmount - roundedItemTenderDeduction);
                     
                    const showPurchaseBtn = /purchase|cost of/i.test(tx.particularsTextSnapshot);
                    let purchaseChartHtml = '';
                    if (tx.purchaseDetails) {
                        const { original, cgst, sgst } = tx.purchaseDetails;
                        const cgstAmount = original * (cgst / 100);
                        const sgstAmount = original * (sgst / 100);
                        const total = original + cgstAmount + sgstAmount;
                        purchaseChartHtml = `<div class="purchase-calculation-chart" style="padding: 8px; border: 1px dashed #555; margin-top: 8px; font-size: 0.9em; background-color: #f0f8ff;"><strong style="text-decoration: underline;">Purchase Calculation:</strong><table style="width: auto; margin-top: 5px; border: none; font-size: 0.95em;"><tbody><tr style="border: none;"><td style="border: none; padding: 2px 8px;">Original Bill Amount:</td><td class="amount" style="border: none; padding: 2px 8px;">${original.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none;"><td style="border: none; padding: 2px 8px;">CGST (${cgst.toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${cgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none;"><td style="border: none; padding: 2px 8px;">SGST (${sgst.toFixed(2)}%):</td><td class="amount" style="border: none; padding: 2px 8px;">${sgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr><tr style="border: none; font-weight: bold; border-top: 1px solid #999;"><td style="border: none; padding: 4px 8px 2px;">Total:</td><td class="amount" style="border: none; padding: 4px 8px 2px;">${Math.round(total).toLocaleString('en-IN', formatOptions)}</td></tr></tbody></table></div>`;
                    }
                    const purchaseButtonHtml = showPurchaseBtn ? `<button class="no-print edit-purchase-btn" data-voucher-index="${voucherIndex}" data-item-index="${itemIndex}" style="display: block; margin-top: 8px;">Edit Purchase Details</button>` : '';

                     workAbstractItemsHtml += `<tr>
                        <td style="text-align: center;">${itemIndex + 1}</td>
                        <td><div contenteditable="true">${tx.finalParticularsText}</div>${purchaseChartHtml}${purchaseButtonHtml}</td>
                        <td style="text-align: right;" contenteditable="true">${parseFloat(tx.quantitySnapshot.toFixed(3))}</td>
                        <td style="text-align: right;" contenteditable="true">${tx.rateSnapshot.toFixed(2)}</td>
                        <td style="text-align: center;" contenteditable="true">${tx.timesdaySnapshot}</td>
                        <td style="text-align: center;" contenteditable="true">${tx.unitSnapshot}</td>
                        <td style="text-align: center;" contenteditable="true">${tx.perSnapshot}</td>
                        <td style="text-align: right;" contenteditable="true">${roundedItemGrossAmount.toLocaleString('en-IN', formatOptions)}</td>
                     </tr>`;

                     if (tenderPercent > 0) {
                        workAbstractItemsHtml += `<tr><td colspan="7" style="text-align: right; font-style: italic; border-left: none; border-bottom: none; border-top: 1px dashed #ccc;">Less Tender: ${tenderPercent.toFixed(2)}%</td><td style="text-align: right; font-style: italic; border-top: 1px dashed #ccc;">(${roundedItemTenderDeduction.toLocaleString('en-IN', formatOptions)})</td></tr>`;
                     }
                 });
                 const netAfterTender = voucherNetAfterTender;
                 
                 let addCgstAmount = 0, addSgstAmount = 0;
                 if ((['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) && gstData) {
                    let applyGst = true;
                    if (reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                    if(applyGst) {
                        addCgstAmount = Math.round((netAfterTender * gstData.cgst) / 100);
                        addSgstAmount = Math.round((netAfterTender * gstData.sgst) / 100);
                    }
                 }
                 
                const subTotal = voucher.subTotalForDeductions;
                const {it, labour, cgst, sgst, royalty} = voucher.deductions;
                const totalDeductions = it + labour + cgst + sgst + royalty;
                const netPayable = subTotal - totalDeductions;
                 
                 newPagesHtml += `<div class="work-abstract-wrapper">
                    <div class="wa-header"><h4 style="text-decoration: underline;">Work Abstract</h4></div>
                    <table class="wa-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">Sl. No.</th>
                                <th>PARTICULARS OF WORK</th>
                                <th style="width: 8%;">Quantity</th>
                                <th style="width: 8%;">Rate</th>
                                <th style="width: 8%;">Times/day</th>
                                <th style="width: 8%;">Unit</th>
                                <th style="width: 8%;">Per</th>
                                <th style="width: 12%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>${workAbstractItemsHtml}</tbody>
                        <tfoot>
                            ${reportType !== 'e-procurmentTender' ? `<tr><td colspan="8"><button class="no-print add-item-btn" data-voucher-index="${voucherIndex}">➕ Add Item to SVr, no. ${voucher.svrNo}</button></td></tr>` : ''}
                            <tr><td colspan="7" style="text-align: right; font-weight: bold;">Total</td><td style="text-align: right; font-weight: bold;">${voucherGrossTotal.toLocaleString('en-IN', formatOptions)}</td></tr>
                            <tr class="sub-total"><td colspan="7" style="text-align: right; font-weight: bold;">Net Total:</td><td style="text-align: right; font-weight: bold;">${netAfterTender.toLocaleString('en-IN', formatOptions)}</td></tr>
                            ${addCgstAmount > 0 ? `<tr><td colspan="7" style="text-align: right;">Add: CGST ${gstData.cgst.toFixed(2)}%</td><td style="text-align: right;">${addCgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>` : ''}
                            ${addSgstAmount > 0 ? `<tr><td colspan="7" style="text-align: right;">Add: SGST ${gstData.sgst.toFixed(2)}%</td><td style="text-align: right;">${addSgstAmount.toLocaleString('en-IN', formatOptions)}</td></tr>` : ''}
                            <tr class="sub-total"><td colspan="7" style="text-align: right; font-weight: bold;">Subtotal:</td><td style="text-align: right; font-weight: bold;">${subTotal.toLocaleString('en-IN', formatOptions)}</td></tr>
                            ${it > 0 ? `<tr><td colspan="7" style="text-align: right;">Less: IT ${taxes.itPercent.toFixed(2)}%</td><td style="text-align: right;">(${it.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                            ${cgst > 0 ? `<tr><td colspan="7" style="text-align: right;">Less: CGST ${taxes.cgstPercent.toFixed(2)}%</td><td style="text-align: right;">(${cgst.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                            ${sgst > 0 ? `<tr><td colspan="7" style="text-align: right;">Less: SGST ${taxes.sgstPercent.toFixed(2)}%</td><td style="text-align: right;">(${sgst.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                            ${royalty > 0 ? `<tr><td colspan="7" style="text-align: right;">Less Royalty: ${(reportType === 'civil' ? taxes.royaltyPercent.toFixed(2)+'%' : '(Manual)')}</td><td style="text-align: right;">(${royalty.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                            ${labour > 0 ? `<tr><td colspan="7" style="text-align: right;">Less Labour Cess: "${taxes.labourCessPercent.toFixed(2)}%"</td><td style="text-align: right;">(${labour.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                            <tr><td colspan="7" style="text-align: right; font-weight: bold;">Total deduction amount ;</td><td style="text-align: right; font-weight: bold;">${totalDeductions.toLocaleString('en-IN', formatOptions)}</td></tr>
                            <tr><td colspan="7" style="text-align: right; font-weight: bold;">Net amount;</td><td style="text-align: right; font-weight: bold;">${netPayable.toLocaleString('en-IN', formatOptions)}</td></tr>
                        </tfoot>
                    </table>
                    <div class="wa-footer">
                         <p style="font-weight: bold;">NET PAYABLE AMOUNT FOR THIS VOUCHER Rs. ${subTotal.toLocaleString('en-IN', formatOptions)}/-</p><p>Received of Rs ${netPayable.toLocaleString('en-IN', formatOptions)} (Rs. ${numberToWordsLocal(netPayable)})</p><p>(For Use In the Office) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vno.: ${voucher.svrNo}</p><p>By cash/ credit / cheque and by adjustment of payment as per Memorandum (in final settlement of all demands)</p><p>Witnesses:<br>1.<br>2.</p><div class="wa-signatures" style="padding: 10px 0;"><span style="border-top: 1px dotted #000; padding-top: 5px;">Signature of the Contractor</span><span style="border-top: 1px dotted #000; padding-top: 5px;">initial of the Officer making Payment</span></div><p>Paid by me vide K-2 Bill No: ${k2BillNoDate || '________________'}</p><br><p>Passed for Rs ${subTotal.toLocaleString('en-IN', formatOptions)} (Rupees. ${numberToWordsLocal(subTotal)})</p><div class="wa-signatures" style="margin-top: 30px;"><span>${rfoName}<br>${rangeName}</span><span>Deputy Conservator of Forests<br>${division}</span></div>
                    </div>
                 </div>`;

                 newPagesHtml += `<div class="fac85-wrapper"><div class="fac85-header"><span><strong>Para-125</strong></span><span style="text-align:right;"><strong>Form FAC 85</strong></span></div><div class="fac85-title">Original/Duplicate/Triplicate.<br>CONTRACT CERTIFICATE</div><div class="fac85-details"><span><strong>Bill No./Vno.:</strong> ${voucher.svrNo}</span><span></span><span style="text-align:right;"><strong>Dated:-</strong> ${formattedItemDate}</span></div><p><strong>Sanction Order No.:-</strong> ${est.id}</p><p><strong>Name of the Contractor and full: address :-</strong> ${currentPayeeDetails}</p><p><strong>Reference to Agreement No:-</strong> ${currentAgreementNo}</p><p><strong>Work Order No. & Date:</strong> ${currentWorkOrder}</p><div class="fac85-body"><p>Certified that the measurement were taken by me on <strong>${checkDate}</strong> and recorded on PAGE NO: ${firstItem.fnbMbPageNumber} of FNB/MB:${firstItem.fnbMbBookNumber} and that the work is satisfacotrily executed.</p><div class="fac85-signatures"><span><strong>Contractor Signature</strong></span><span style="text-align:right;"><strong>Range Forest Officer<br>${rangeName}</strong></span></div><p>Certified that the measurement were checked by ACF ${subDivision} on C.M DATE: <strong>${checkDate}</strong> and found correct. the work is satisfactorily executed.</p><p>Certified that the quantities of Materials shown in column 3 of account I have been actually brought to site of the work and contractor has not previously received any advance on this security. These materials are not an imperishable nature and are all required by the contractor for immediate use on the work in connection with items for which rates for finished works have been agreed upon A formal agreement signed and executed by the contractor is recorded in the office.</p></div><div style="text-align:right; margin-top:20px; font-weight:bold;">Assistant Conservator of Forests<br>${subDivision}</div><h4 style="text-align:center;">II Memorandum of payment</h4><table class="fac85-memo-table" style="width:100%;"><tr><td>1. Total value of work of supplies made as per account with in</td><td class="amount">${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr><tr><td>2. Deduct amount to be held in reserve being ................. Percent Rs.</td><td class="amount"></td></tr><tr><td>3. Balance</td><td class="amount">${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr><tr><td>4. Deduct Payments<br>a) I.T: ${taxes.itPercent.toFixed(2)} % <br>b) CGST: ${taxes.cgstPercent.toFixed(2)} % <br>c) SGST: ${taxes.sgstPercent.toFixed(2)} % <br>d) Royalty: ${ (reportType === 'civil' ? taxes.royaltyPercent.toFixed(2)+' %' : '(Manual)') } <br>e) Labour Cess: ${taxes.labourCessPercent.toFixed(2)} %</td><td class="amount" style="vertical-align:bottom;">${it.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>${cgst.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>${sgst.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>${royalty.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>${labour.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr><tr><td><strong>Total amount adjusted.........................Net. Amt.</strong></td><td class="amount"><strong>${netPayable.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td></tr></table><div style="text-align:right; margin-top:40px; font-weight:bold;">Signature of the Contractor</div></div>`;
            });
        }
        
        if (['work', 'timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType)) {
             const uniquePayees = [...new Set(vouchers.map(voucher => {
				if (voucher.payeeDetails) return voucher.payeeDetails.fullDetails;
				if (reportType === 'non-work') return (voucher.items[0]?.finalParticularsText.match(/<b>Payee:<\/b> (.*?)</) || [])[1];
				return contractorDetails;
			}).filter(Boolean))];

			if (vouchers.every(v => v.payeeDetails) && uniquePayees.length > 1) { // Merged report with multiple payees
				uniquePayees.forEach(payeeString => {
					const vouchersForThisPayee = vouchers.filter(v => v.payeeDetails && v.payeeDetails.fullDetails === payeeString);
					if(vouchersForThisPayee.length === 0) return;
					
                    const totalSubTotalForFAC84 = vouchersForThisPayee.reduce((sum, v) => sum + v.subTotalForDeductions, 0);
                    const aggregatedDeductions = vouchersForThisPayee.reduce((acc, v) => {
                        Object.keys(v.deductions).forEach(key => acc[key] = (acc[key] || 0) + v.deductions[key]);
                        return acc;
                    }, {});

					const summaryVoucherForFAC84 = {
						svrNo: vouchersForThisPayee.map(v => v.svrNo).join(', '),
						items: [vouchersForThisPayee[0].items[0]],
						payeeDetails: { name: payeeString.split(',')[0], fullDetails: payeeString },
						aggregatedSubTotal: totalSubTotalForFAC84,
						aggregatedDeductions: aggregatedDeductions
					};
					newPagesHtml += renderFac84Html([summaryVoucherForFAC84], params);
				});

			} else { // Not a merged report, or merged with single payee
				newPagesHtml += renderFac84Html(vouchers, params);
			}
        }
        
        return classifiedAbstractHtml + newPagesHtml;
    }
    
    // --- START: New Edit/Merge/Unmerge Report Logic ---
    const editReportModal = document.getElementById('edit-report-modal');
    const editSavedReportsBtn = document.getElementById('edit-saved-reports-btn');
    const editReportListContainer = document.getElementById('edit-report-list-container');
    const editReportFormContainer = document.getElementById('edit-report-form-container');
    const editReportListDiv = document.getElementById('edit-report-list');
    const mergeReportsBtn = document.getElementById('merge-reports-btn');


    editSavedReportsBtn.addEventListener('click', () => {
        renderEditableReportsList();
        editReportListContainer.style.display = 'block';
        editReportFormContainer.style.display = 'none';
        editReportFormContainer.innerHTML = '';
        editReportModal.style.display = 'block';
    });

    function renderEditableReportsList() {
        const reports = getSavedReports();
        if (reports.length === 0) {
            editReportListDiv.innerHTML = '<p>No saved reports to edit.</p>';
            return;
        }
        editReportListDiv.innerHTML = '<ul>' + reports.map(report => {
            let payeeInfo = '';
            if (report.inputs.reportType === 'non-work' && report.inputs.nonWorkPayees && report.inputs.nonWorkPayees.length > 0) {
                payeeInfo = report.inputs.nonWorkPayees.map(p => p.name).join(', ');
            } else {
                payeeInfo = (report.inputs.contractorDetails || 'N/A').split(',')[0];
            }

            const isMerged = report.inputs.originalReportIds && report.inputs.originalReportIds.length > 0;
            let titleHtml = `<strong>Token No: ${report.inputs.tokenNo}</strong>`;
            if (isMerged) {
                titleHtml += ` <span style="color: #9b59b6; font-size: 0.8em; font-weight: bold;">[MERGED]</span>`;
            }

            let actionButtonHtml = isMerged 
                ? `<button class="unmerge-btn" data-id="${report.id}">Unmerge</button>`
                : `<button class="edit-btn" data-id="${report.id}">Edit</button>`;

            return `
                <li>
					<input type="checkbox" class="report-select-checkbox" data-id="${report.id}" data-budget-head="${report.budgetHead}" ${isMerged ? 'disabled' : ''}>
                    <div style="flex-grow: 1; margin-right: 10px; margin-left: 10px;">
                        ${titleHtml}<br>
                        <small>
							Payee(s): ${payeeInfo}<br>
                            Budget: ${report.budgetHead || 'N/A'}<br>
                            <strong>Total: Rs. ${Math.round(report.grandTotal).toLocaleString('en-IN')}/-</strong>
                        </small>
                    </div>
                    <div>
                        ${actionButtonHtml}
                    </div>
                </li>`;
        }).join('') + '</ul>';

		document.querySelectorAll('.report-select-checkbox').forEach(cb => {
            cb.addEventListener('change', () => {
                const checked = document.querySelectorAll('.report-select-checkbox:checked');
                if (checked.length > 1) {
                    const firstBudgetHead = checked[0].dataset.budgetHead;
                    const allSameBudget = Array.from(checked).every(c => c.dataset.budgetHead === firstBudgetHead);
                    mergeReportsBtn.style.display = allSameBudget ? 'inline-flex' : 'none';
                } else {
                    mergeReportsBtn.style.display = 'none';
                }
            });
        });
    }
	
	mergeReportsBtn.addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.report-select-checkbox:checked')).map(cb => cb.dataset.id);
        if (selectedIds.length < 2) {
            alert("Please select at least two reports with the same Budget Head to merge.");
            return;
        }
        showMergePayeeModal(selectedIds);
    });

    editReportListDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const reportId = e.target.dataset.id;
            const report = getSavedReports().find(r => r.id == reportId);
            if (report) {
                showEditForm(report);
            }
        } else if (e.target.classList.contains('unmerge-btn')) {
            const reportId = e.target.dataset.id;
            handleUnmergeReport(reportId);
        }
    });

    function handleUnmergeReport(mergedReportId) {
        if (!confirm('Are you sure you want to unmerge this report? This will delete the merged report entry. The original reports will remain.')) {
            return;
        }

        let reports = getSavedReports();
        const updatedReports = reports.filter(r => r.id != mergedReportId);

        if (reports.length === updatedReports.length) {
            alert('Error: Could not find the merged report to delete.');
            return;
        }

        saveSavedReports(updatedReports);
        alert('Report unmerged successfully!');
        renderEditableReportsList();
    }
    
    function showEditForm(report) {
        editReportListContainer.style.display = 'none';
        
        let formHtml = `<form id="report-edit-form">`;
        formHtml += `<input type="hidden" id="editing-report-id" value="${report.id}">`;
        formHtml += `<h4>Editing Report for Token: <span style="color: blue;">${report.inputs.tokenNo}</span></h4>`;
        
        formHtml += `<hr><h5>General Details</h5>`;
        formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
            <label for="edit-token-no">Token No:</label>
            <input type="text" id="edit-token-no" value="${report.inputs.tokenNo || ''}">
        </div>`;
        formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
            <label for="edit-k2-bill">K2 Bill No & Date:</label>
            <input type="text" id="edit-k2-bill" value="${report.inputs.k2BillNoDate || ''}">
        </div>`;

        if (report.inputs.reportType === 'non-work') {
            formHtml += '<h5>Payee Details (Non-Work)</h5>';
            (report.inputs.nonWorkPayees || []).forEach((payee, index) => {
                formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                    <label>Payee ${index + 1}:</label>
                    <input type="text" class="edit-nonwork-payee-name" data-index="${index}" value="${payee.name}">
                </div>`;
            });
        } else {
            const contractors = getContractors();
            let contractorOptions = contractors.map(c => {
                const fullDetails = `${c.name}, ${c.address} (GST: ${c.gst}, PAN: ${c.pan})`;
                return `<option value="${fullDetails}" ${report.inputs.contractorDetails === fullDetails ? 'selected' : ''}>${c.name}</option>`;
            }).join('');
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-payee-select">Payee:</label>
                <select id="edit-payee-select">${contractorOptions}</select>
            </div>`;
        }

        formHtml += `<hr><h5>Estimate & Agreement Details</h5>`;
        const uniqueEstimates = report.vouchersData.reduce((acc, v) => {
            v.items.forEach(i => acc.set(i.estimate.id, i.estimate));
            return acc;
        }, new Map());

        uniqueEstimates.forEach(estimate => {
            const estId = estimate.id;
            formHtml += `<div style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; margin-bottom: 10px;">`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-est-no-${estId}">Est No:</label>
                <input type="text" id="edit-est-no-${estId}" class="edit-est-no" data-old-est-id="${estId}" value="${estId}">
            </div>`;
             formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-work-name-${estId}">Work:</label>
                <input type="text" id="edit-work-name-${estId}" class="edit-work-name" data-est-id="${estId}" value="${estimate.workName}">
            </div>`;
            // New Editable Fields
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-location-${estId}">Location:</label>
                <input type="text" id="edit-location-${estId}" class="edit-plantation-details" data-field="location" data-est-id="${estId}" value="${estimate.location || ''}">
            </div>`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-fsy-no-${estId}">FSy, No:</label>
                <input type="text" id="edit-fsy-no-${estId}" class="edit-plantation-details" data-field="plantationFSyNo" data-est-id="${estId}" value="${estimate.plantationFSyNo || ''}">
            </div>`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-extent-${estId}">Extent (Ha):</label>
                <input type="text" id="edit-extent-${estId}" class="edit-plantation-details" data-field="plantationExtentHa" data-est-id="${estId}" value="${estimate.plantationExtentHa || ''}">
            </div>`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-seedlings-${estId}">No. of Seedlings:</label>
                <input type="text" id="edit-seedlings-${estId}" class="edit-plantation-details" data-field="plantationNoOfSeedlings" data-est-id="${estId}" value="${estimate.plantationNoOfSeedlings || ''}">
            </div>`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-quantity-${estId}">Quantity:</label>
                <input type="text" id="edit-quantity-${estId}" class="edit-plantation-details" data-field="quantity" data-est-id="${estId}" value="${estimate.quantity || ''}">
            </div>`;
            // End New Fields
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-agreement-${estId}">Agreement:</label>
                <input type="text" id="edit-agreement-${estId}" class="edit-agreement" data-est-id="${estId}" value="${report.inputs.agreementData[estId] || ''}">
            </div>`;
            formHtml += `<div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                <label for="edit-work-order-${estId}">Work Order:</label>
                <input type="text" id="edit-work-order-${estId}" class="edit-work-order" data-est-id="${estId}" value="${report.inputs.workOrderData[estId] || ''}">
            </div>`;
            formHtml += `</div>`;
        });
        
        formHtml += `<hr><h5>Voucher-Specific Details</h5>`;
        report.vouchersData.forEach((voucher, vIndex) => {
             const firstItem = voucher.items[0];
             if (!firstItem) return;
             
             const aggregatedPeriod = [...new Set(voucher.items.map(i => i.periodOfWork).filter(Boolean))].join(', ');
             const aggregatedCmDate = [...new Set(voucher.items.map(i => i.checkMeasurementDate).filter(Boolean))].join(', ');
             
             formHtml += `<div style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                <strong>SVr, no: ${voucher.svrNo}</strong>
                <div class="modal-form" style="grid-template-columns: 1fr 3fr; margin-top: 10px;">
                    <label for="edit-period-${vIndex}">Period of Work:</label>
                    <input type="text" id="edit-period-${vIndex}" class="edit-voucher-period" data-voucher-index="${vIndex}" value="${aggregatedPeriod}">
                </div>
                <div class="modal-form" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <label>FNB/MB No:</label>
                    <input type="text" class="edit-voucher-fnb" data-voucher-index="${vIndex}" value="${firstItem.fnbMbBookNumber || ''}">
                     <label>FNB/MB Page:</label>
                    <input type="text" class="edit-voucher-fnb-page" data-voucher-index="${vIndex}" value="${firstItem.fnbMbPageNumber || ''}">
                </div>
                 <div class="modal-form" style="grid-template-columns: 1fr 3fr;">
                    <label for="edit-cm-date-${vIndex}">C.M Date:</label>
                    <input type="text" id="edit-cm-date-${vIndex}"
                    class="edit-voucher-cmdate" data-voucher-index="${vIndex}" value="${aggregatedCmDate}">
                </div>
             </div>`;
        });

        formHtml += `<div style="margin-top: 20px; text-align: right;">
            <button type="button" id="back-to-edit-list-btn" class="toolbar-btn btn-secondary">Back to List</button>
            <button type="submit" class="toolbar-btn btn-success">Save Changes</button>
        </div>`;
        formHtml += `</form>`;
        
        editReportFormContainer.innerHTML = formHtml;
        editReportFormContainer.style.display = 'block';

        document.getElementById('back-to-edit-list-btn').addEventListener('click', () => {
            editReportFormContainer.style.display = 'none';
            editReportListContainer.style.display = 'block';
        });

        document.getElementById('report-edit-form').addEventListener('submit', handleUpdateReport);
    }
    
    function handleUpdateReport(e) {
        e.preventDefault();
        const reportId = document.getElementById('editing-report-id').value;
        let reports = getSavedReports();
        const reportIndex = reports.findIndex(r => r.id == reportId);
        if (reportIndex === -1) {
            alert("Error: Report not found!");
            return;
        }

        let report = JSON.parse(JSON.stringify(reports[reportIndex]));
        
        const oldTokenNo = report.inputs.tokenNo;
        const newTokenNo = document.getElementById('edit-token-no').value.trim();
        report.inputs.tokenNo = newTokenNo;
        report.inputs.k2BillNoDate = document.getElementById('edit-k2-bill').value;

        if (report.inputs.reportType === 'non-work') {
            document.querySelectorAll('.edit-nonwork-payee-name').forEach(input => {
                const index = parseInt(input.dataset.index, 10);
                if (report.inputs.nonWorkPayees[index]) {
                    report.inputs.nonWorkPayees[index].name = input.value;
                }
            });
        } else {
            report.inputs.contractorDetails = document.getElementById('edit-payee-select').value;
        }

        const estIdChanges = new Map();
        document.querySelectorAll('.edit-est-no').forEach(input => {
            const oldEstId = input.dataset.oldEstId;
            const newEstId = input.value.trim();
            if (oldEstId !== newEstId) {
                estIdChanges.set(oldEstId, newEstId);
            }

        });
        
        document.querySelectorAll('.edit-work-name').forEach(input => {
            const estId = input.dataset.estId;
            const newWorkName = input.value;
            report.vouchersData.forEach(v => v.items.forEach(i => {
                if (i.estimate.id === estId) i.estimate.workName = newWorkName;
            }));
        });
        document.querySelectorAll('.edit-plantation-details').forEach(input => {
            const estId = input.dataset.estId;
            const field = input.dataset.field;
            const newValue = input.value;
            report.vouchersData.forEach(v => v.items.forEach(i => {
                if (i.estimate.id === estId) i.estimate[field] = newValue;
            }));
        });
        document.querySelectorAll('.edit-agreement').forEach(input => {
            const estId = input.dataset.estId;
            report.inputs.agreementData[estId] = input.value;
        });
        document.querySelectorAll('.edit-work-order').forEach(input => {
            const estId = input.dataset.estId;
            report.inputs.workOrderData[estId] = input.value;
        });
        
        if (estIdChanges.size > 0) {
            report.vouchersData.forEach(v => {
                v.items.forEach(i => {
                    if (estIdChanges.has(i.estimate.id)) {
                        i.estimate.id = estIdChanges.get(i.estimate.id);
                    }
                });
            });
            ['agreementData', 'workOrderData', 'tenderData'].forEach(key => {
                 if(report.inputs[key]) {
                    const newData = {};
                    Object.keys(report.inputs[key]).forEach(oldId => {
                        const newId = estIdChanges.get(oldId) || oldId;
                        newData[newId] = report.inputs[key][oldId];
                    });
                    report.inputs[key] = newData;
                 }
            });
        }

        document.querySelectorAll('.edit-voucher-period').forEach(input => {
            const vIndex = parseInt(input.dataset.voucherIndex, 10);
            if (report.vouchersData[vIndex]) {
                report.vouchersData[vIndex].items.forEach(i => i.periodOfWork = input.value);
            }
        });
        document.querySelectorAll('.edit-voucher-fnb').forEach(input => {
            const vIndex = parseInt(input.dataset.voucherIndex, 10);
            if (report.vouchersData[vIndex]) {
                 report.vouchersData[vIndex].items.forEach(i => i.fnbMbBookNumber = input.value);
            }
        });
        document.querySelectorAll('.edit-voucher-fnb-page').forEach(input => {
            const vIndex = parseInt(input.dataset.voucherIndex, 10);
            if (report.vouchersData[vIndex]) {
                 report.vouchersData[vIndex].items.forEach(i => i.fnbMbPageNumber = input.value);
            }
        });
        document.querySelectorAll('.edit-voucher-cmdate').forEach(input => {
            const vIndex = parseInt(input.dataset.voucherIndex, 10);
            if (report.vouchersData[vIndex]) {
                 report.vouchersData[vIndex].items.forEach(i => i.checkMeasurementDate = input.value);
            }
        });

        report.vouchersData.forEach((voucher, vIndex) => {
            const allCmDates = [...new Set(voucher.items.map(item => item.checkMeasurementDate).filter(Boolean))].join(', ');
            const allPeriodsOfWork = [...new Set(voucher.items.map(item => item.periodOfWork).filter(Boolean))].join(', ');

            voucher.items.forEach((tx, itemIndex) => {
                const est = tx.estimate;
                let baseParticulars = tx.finalParticularsText.split('<br><br>')[1] || tx.finalParticularsText;
                // A more robust way to strip the old header
                baseParticulars = baseParticulars.replace(/<b>.*?<\/b>.*?<br\/?>/gi, '').trim();


                let headerPart = '';
                if (report.inputs.reportType !== 'non-work') {
                    const contractorDetails = report.inputs.contractorDetails;
                    const agreementData = report.inputs.agreementData;
                    const workOrderData = report.inputs.workOrderData;
                    let plantationDetailsHtml = '';
                    if (est.location) plantationDetailsHtml += `<b>Location:</b> ${est.location}<br/>`;
                    if (est.plantationFSyNo) plantationDetailsHtml += `<b>FSy, No:</b> ${est.plantationFSyNo}<br/>`;
                    if (est.plantationExtentHa) plantationDetailsHtml += `<b>Extent(Ha):</b> ${est.plantationExtentHa}<br/>`;
                    if (est.plantationNoOfSeedlings) plantationDetailsHtml += `<b>No.of Seedlings:</b> ${est.plantationNoOfSeedlings}<br/>`;
                    if (est.quantity) plantationDetailsHtml += `<b>Quantity:</b> ${est.quantity}<br/>`;
                    headerPart = `<b>Payee:</b> ${contractorDetails}<br/><b>Agreement:</b> ${agreementData[est.id] || '----'} &nbsp;&nbsp; <b>Work Order:</b> ${workOrderData[est.id] || '----'}<br/><b>Work:</b> ${est.workName || ''}<br/>${plantationDetailsHtml}<b>Est No:</b> ${est.id || ''}<br/><b>Period of Work:</b> ${allPeriodsOfWork || ''}<br/><b>FNB/MB:</b> ${tx.fnbMbBookNumber || ''} <b>Page:</b> ${tx.fnbMbPageNumber || ''}<br/><b>C.M Date:</b> ${allCmDates || ''}`;
                    tx.finalParticularsText = `${headerPart}<br><br>${baseParticulars}`;
                } else {
                     const payeeName = report.inputs.nonWorkPayees[vIndex]?.name || 'Payee';
                     tx.finalParticularsText = `<b>Payee:</b> ${payeeName}<br><b>Work:</b> ${est.workName || ''}<br><b>Estimate No:</b> ${est.id}<br><b>Period of Work:</b> ${tx.periodOfWork || '-'}<br><b>FNB/MB:</b> ${tx.fnbMbBookNumber || 'N/A'} &nbsp;&nbsp; <b>PAGE NO:</b> ${tx.fnbMbPageNumber || 'N/A'}<br><b>C.M DATE:</b> ${allCmDates || '-'}`;
                }
            });
        });

        const fullReportHtml = renderReportHtmlFromData(report.vouchersData, report.inputs);
        const workAbstractMarker = '<div class="work-abstract-wrapper">';
        const fac63Marker = '<div class="fac63-wrapper">';
        
        if (fullReportHtml.includes(workAbstractMarker)) {
             report.classifiedAbstractHtml = fullReportHtml.substring(0, fullReportHtml.indexOf(workAbstractMarker));
             report.otherPagesHtml = fullReportHtml.substring(fullReportHtml.indexOf(workAbstractMarker));
        } else if (fullReportHtml.includes(fac63Marker)) {
            report.classifiedAbstractHtml = fullReportHtml.substring(0, fullReportHtml.indexOf(fac63Marker));
            report.otherPagesHtml = fullReportHtml.substring(fullReportHtml.indexOf(fac63Marker));
        } else {
            report.classifiedAbstractHtml = fullReportHtml;
            report.otherPagesHtml = '';
        }

        report.title = `Report for Token ${report.inputs.tokenNo} (${report.inputs.month} ${report.inputs.year})`;
        report.mainHeader = `Classified abstract of ${report.inputs.rfoName}, ${report.inputs.rangeName || ''} for the month ${report.inputs.month} ${report.inputs.year}`;

        reports[reportIndex] = report;
        
        if(oldTokenNo !== newTokenNo) {
            const treasuryData = getTreasuryData();
            if(treasuryData[oldTokenNo]) {
                treasuryData[newTokenNo] = treasuryData[oldTokenNo];
                delete treasuryData[oldTokenNo];
                saveTreasuryData(treasuryData);
            }
        }
        
        saveSavedReports(reports);
        
        alert('Report updated successfully! All sections have been regenerated with the new data.');
        renderEditableReportsList();
        editReportFormContainer.style.display = 'none';
        editReportListContainer.style.display = 'block';
    }
	
	function showMergePayeeModal(selectedIds) {
        const mergePayeeModal = document.getElementById('merge-payee-modal');
        const confirmMergeBtn = document.getElementById('confirm-merge-btn');
        
        confirmMergeBtn.onclick = () => {
            mergePayeeModal.style.display = 'none';
            handleMergeReports(selectedIds);
        };

        mergePayeeModal.style.display = 'block';
    }

    function handleMergeReports(selectedIds) {
        const allReports = getSavedReports();
        const reportsToMerge = allReports.filter(r => selectedIds.includes(String(r.id)));

        if (reportsToMerge.length < 2) return;

        let combinedVouchers = [];
        reportsToMerge.forEach(report => {
            const payees = (report.inputs.reportType === 'non-work')
                ? report.inputs.nonWorkPayees.map(p => ({ name: p.name, fullDetails: p.name }))
                : [{ name: report.inputs.contractorDetails.split(',')[0], fullDetails: report.inputs.contractorDetails }];
			
			if(report.inputs.reportType === 'non-work' && payees.length > 1 && report.vouchersData.length === payees.length) {
				report.vouchersData.forEach((voucher, index) => {
					const voucherWithPayee = JSON.parse(JSON.stringify(voucher));
					voucherWithPayee.payeeDetails = payees[index]; 
					combinedVouchers.push(voucherWithPayee);
				});
			} else {
				report.vouchersData.forEach(voucher => {
					const voucherWithPayee = JSON.parse(JSON.stringify(voucher));
					voucherWithPayee.payeeDetails = payees[0];
					combinedVouchers.push(voucherWithPayee);
				});
			}
        });

        combinedVouchers.sort((a,b) => a.svrNo - b.svrNo);
        let svrCounter = 0;
        combinedVouchers.forEach(v => {
            svrCounter++;
            v.svrNo = svrCounter;
        });
		
        const baseReport = reportsToMerge[0];
        let mergedParams = JSON.parse(JSON.stringify(baseReport.inputs));
        mergedParams.tokenNo = reportsToMerge.map(r => r.inputs.tokenNo).join(', ');
        mergedParams.k2BillNoDate = reportsToMerge.map(r => r.inputs.k2BillNoDate).filter(Boolean).join('; ');
        
        mergedParams.tenderData = Object.assign({}, ...reportsToMerge.map(r => r.inputs.tenderData));
        mergedParams.agreementData = Object.assign({}, ...reportsToMerge.map(r => r.inputs.agreementData));
        mergedParams.workOrderData = Object.assign({}, ...reportsToMerge.map(r => r.inputs.workOrderData));
        mergedParams.gstData = Object.assign({}, ...reportsToMerge.map(r => r.inputs.gstData).filter(Boolean));
        
        // **NEW**: Store original report IDs for unmerging
        mergedParams.originalReportIds = selectedIds;
        
        currentReportVouchers = combinedVouchers;
        currentReportParameters = mergedParams;
        currentEditingReportId = `merged-${Date.now()}`;

        const mergedHtml = renderReportHtmlFromData(combinedVouchers, mergedParams);
        reportOutput.innerHTML = mergedHtml;
        addEditEventListeners();

        document.getElementById('print-report-btn').style.display = 'inline-flex';
        document.getElementById('save-edits-btn').style.display = 'inline-flex';
        document.getElementById('view-payee-ledger-btn').style.display = 'inline-flex';
        
        editReportModal.style.display = 'none';
        statusMessage.textContent = `${reportsToMerge.length} reports merged successfully. You can now save the merged result.`;
        statusMessage.style.color = 'green';
    }
    
    // --- START: New Purchase/Cost Modal Logic ---
    function showPurchaseModal(voucherIndex, itemIndex) {
        const item = currentReportVouchers[voucherIndex]?.items[itemIndex];
        if (!item) return;

        const modal = document.getElementById('purchase-modal');
        const form = document.getElementById('purchase-form');
        const originalAmountInput = document.getElementById('purchase-original-amount');
        const cgstInput = document.getElementById('purchase-add-cgst');
        const sgstInput = document.getElementById('purchase-add-sgst');
        const totalDisplay = document.getElementById('total-purchase-display');
        document.getElementById('purchase-voucher-index').value = voucherIndex;
        document.getElementById('purchase-item-index').value = itemIndex;

        // Load existing data if available
        const purchaseData = item.purchaseDetails || { original: 0, cgst: 9, sgst: 9 };
        originalAmountInput.value = purchaseData.original;
        cgstInput.value = purchaseData.cgst;
        sgstInput.value = purchaseData.sgst;

        const calculateTotal = () => {
            const original = parseFloat(originalAmountInput.value) || 0;
            const cgst = parseFloat(cgstInput.value) || 0;
            const sgst = parseFloat(sgstInput.value) || 0;
            const cgstAmount = original * (cgst / 100);
            const sgstAmount = original * (sgst / 100);
            const total = original + cgstAmount + sgstAmount;
            totalDisplay.value = `Rs. ${total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            return Math.round(total);
        };
        
        const inputHandler = () => calculateTotal();
        modal.querySelectorAll('.purchase-calc-input').forEach(input => {
            input.removeEventListener('input', inputHandler); // Remove old listener
            input.addEventListener('input', inputHandler); // Add new one
        });

        const submitHandler = (e) => {
            e.preventDefault();
            const newTotal = calculateTotal();
            item.expenditureAmount = newTotal;
            item.purchaseDetails = {
                original: parseFloat(originalAmountInput.value) || 0,
                cgst: parseFloat(cgstInput.value) || 0,
                sgst: parseFloat(sgstInput.value) || 0,
            };
            modal.style.display = 'none';
            form.removeEventListener('submit', submitHandler);
            rerenderReport();
        };
        
        form.removeEventListener('submit', submitHandler); // Ensure no duplicate listeners
        form.addEventListener('submit', submitHandler);

        modal.querySelector('.modal-close-btn').onclick = () => { modal.style.display = 'none'; };
        calculateTotal();
        modal.style.display = 'block';
    }


    function getFilteredReports() {
        const allSavedReports = getSavedReports();
        const selectedPayee = document.getElementById('ledger-payee-filter').value;
        const selectedMonth = document.getElementById('ledger-month-filter').value;
        const selectedToken = document.getElementById('ledger-token-filter').value;

        return allSavedReports.filter(report => {
            const reportMonthYear = `${report.year}-${String(new Date(Date.parse(report.month + " 1, 2012")).getMonth() + 1).padStart(2, '0')}`;
            const monthMatch = (selectedMonth === 'all') || (reportMonthYear === selectedMonth);
            const tokenMatch = (selectedToken === 'all') || (report.inputs.tokenNo === selectedToken);
            
            let payeeMatch = (selectedPayee === 'all');
            if (!payeeMatch) {
                 if (report.inputs.reportType === 'non-work') {
                    payeeMatch = (report.inputs.nonWorkPayees || []).some(p => p.name === selectedPayee);
                } else if (report.inputs.contractorDetails) {
                    payeeMatch = report.inputs.contractorDetails.startsWith(selectedPayee);
                }
            }
            return monthMatch && tokenMatch && payeeMatch;
        });
    }

    function getFilteredLedgerData() {
        const filteredReports = getFilteredReports();
        const dataByToken = {};

        filteredReports.forEach(report => {
            const tokenNo = report.inputs.tokenNo;
            if (!dataByToken[tokenNo]) {
                dataByToken[tokenNo] = {
                    payees: new Set(),
                    date: `${report.month} ${report.year}`,
                    addCgst: 0, addSgst: 0,
                    deductIt: 0, deductLabour: 0, deductCgst: 0, deductSgst: 0, deductRoyalty: 0,
                    gross: 0, tender: 0, subTotal: 0, netPayable: 0
                };
            }

            const { vouchersData, inputs } = report;
            const { taxes, tenderData, gstData, reportType, manualRoyaltyData } = inputs;
            
            let reportSubtotal = 0;
            vouchersData.forEach(voucher => { reportSubtotal += voucher.subTotalForDeductions });


            (vouchersData || []).forEach(voucher => {
                let voucherPayees = [];
                if (voucher.payeeDetails) {
                    voucherPayees.push(voucher.payeeDetails.name);
                } else if (reportType === 'non-work') {
                    voucherPayees = voucher.items.map(i => (i.finalParticularsText.match(/<b>Payee:<\/b> (.*?)</) || [])[1] || 'Unknown');
                } else {
                    voucherPayees.push((inputs.contractorDetails || '').split(',')[0]);
                }
                voucherPayees.forEach(p => dataByToken[tokenNo].payees.add(p));

                const voucherGross = voucher.items.reduce((s, i) => s + Math.round(i.expenditureAmount), 0);
                const voucherNetAfterTender = voucher.items.reduce((sum, tx) => {
                const tenderPercent = (tenderData && tenderData[tx.estimate.id]) ? tenderData[tx.estimate.id] : 0;
                    return sum + (Math.round(tx.expenditureAmount) - Math.round((Math.round(tx.expenditureAmount) * tenderPercent) / 100));
                }, 0);

                let addCgst = 0, addSgst = 0;
                let applyGst = (['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType) && gstData);
                if(reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                if(applyGst) {
                    addCgst = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                    addSgst = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                }
                
                const subTotal = voucher.subTotalForDeductions;
                const itDeduct = voucher.deductions.it;
                const labourDeduct = voucher.deductions.labour;
                const cgstDeduct = voucher.deductions.cgst;
                const sgstDeduct = voucher.deductions.sgst;
                const royaltyDeduct = voucher.deductions.royalty;

                dataByToken[tokenNo].gross += voucherGross;
                dataByToken[tokenNo].tender += (voucherGross - voucherNetAfterTender);
                dataByToken[tokenNo].addCgst += addCgst;
                dataByToken[tokenNo].addSgst += addSgst;
                dataByToken[tokenNo].subTotal += subTotal;
                dataByToken[tokenNo].deductIt += itDeduct;
                dataByToken[tokenNo].deductLabour += labourDeduct;
                dataByToken[tokenNo].deductCgst += cgstDeduct;
                dataByToken[tokenNo].deductSgst += sgstDeduct;
                dataByToken[tokenNo].deductRoyalty += royaltyDeduct;
                dataByToken[tokenNo].netPayable += subTotal - (itDeduct + labourDeduct + cgstDeduct + sgstDeduct + royaltyDeduct);
            });
        });
        return dataByToken;
    }

    function renderFilteredLedger() {
        const dataByToken = getFilteredLedgerData();
        const chartContainer = document.getElementById('payee-ledger-chart-container');
        const formatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        if (Object.keys(dataByToken).length === 0) {
            chartContainer.innerHTML = '<p style="text-align: center; font-weight: bold;">No matching reports found for the selected filters.</p>';
            return;
        }

        let finalHtml = '';
        for (const tokenNo in dataByToken) {
            const totals = dataByToken[tokenNo];
            const taxData = [
                { label: 'Add CGST', value: totals.addCgst, type: 'added' },
                { label: 'Add SGST', value: totals.addSgst, type: 'added' },
                { label: 'Deduct IT', value: totals.deductIt, type: 'deducted' },
                { label: 'Deduct Labour Cess', value: totals.deductLabour, type: 'deducted' },
                { label: 'Deduct CGST', value: totals.deductCgst, type: 'deducted' },
                { label: 'Deduct SGST', value: totals.deductSgst, type: 'deducted' },
                { label: 'Deduct Royalty', value: totals.deductRoyalty, type: 'deducted' }
            ].filter(d => d.value > 0);

            let chartHtml = '';
            if (taxData.length > 0) {
                const maxValue = Math.max(...taxData.map(d => d.value));
                const chartBarsHtml = taxData.map(d => `
                    <div class="chart-bar-group">
                        <div class="chart-bar bar-${d.type}" style="height: ${maxValue > 0 ? (d.value / maxValue) * 100 : 0}%;">
                            <span class="bar-value">${Math.round(d.value).toLocaleString('en-IN')}</span>
                        </div>
                        <div class="chart-label">${d.label}</div>
                    </div>`).join('');
                chartHtml = `<div class="chart-container"><h4>Added vs Deducted Tax Summary</h4><div class="chart-bars">${chartBarsHtml}</div></div>`;
            }

            let summaryTableHtml = `
                <table class="ledger-table" style="margin-top: 20px; font-size: 0.9em;">
                    <tr style="background-color:#d4edda;"><td colspan="2"><b>Totals for Token: ${tokenNo}</b> (Payee(s): ${Array.from(totals.payees).join(', ')})</td></tr>
                    <tr><td>Total Gross Amount</td><td>${totals.gross.toLocaleString('en-IN', formatOptions)}</td></tr>
                    ${totals.tender > 0 ? `<tr><td>Total Less: Tender</td><td>(${totals.tender.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    ${totals.addCgst > 0 ? `<tr><td>Total Add: CGST</td><td>${totals.addCgst.toLocaleString('en-IN', formatOptions)}</td></tr>` : ''}
                    ${totals.addSgst > 0 ? `<tr><td>Total Add: SGST</td><td>${totals.addSgst.toLocaleString('en-IN', formatOptions)}</td></tr>` : ''}
                    <tr class="total-row"><td>Grand Subtotal</td><td>${totals.subTotal.toLocaleString('en-IN', formatOptions)}</td></tr>
                    ${totals.deductIt > 0 ? `<tr><td>Total Less: IT</td><td>(${totals.deductIt.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    ${totals.deductLabour > 0 ? `<tr><td>Total Less: Labour Cess</td><td>(${totals.deductLabour.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    ${totals.deductCgst > 0 ? `<tr><td>Total Less: CGST</td><td>(${totals.deductCgst.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    ${totals.deductSgst > 0 ? `<tr><td>Total Less: SGST</td><td>(${totals.deductSgst.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    ${totals.deductRoyalty > 0 ? `<tr><td>Total Less: Royalty</td><td>(${totals.deductRoyalty.toLocaleString('en-IN', formatOptions)})</td></tr>` : ''}
                    <tr class="total-row"><td>Grand Total Deductions</td><td>${(totals.deductIt + totals.deductLabour + totals.deductCgst + totals.deductSgst + totals.deductRoyalty).toLocaleString('en-IN', formatOptions)}</td></tr>
                    <tr class="total-row"><td>Grand Total Net Payable</td><td>${totals.netPayable.toLocaleString('en-IN', formatOptions)}</td></tr>
                </table>`;

            finalHtml += `<div class="token-summary-wrapper" style="border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="margin-top:0;">Summary for Token No: ${tokenNo}</h3>
                            <div class="ledger-summary-container">${chartHtml}${summaryTableHtml}</div>
                         </div>`;
        }

        chartContainer.innerHTML = finalHtml || '<p style="text-align: center; font-weight: bold;">No matching reports found for the selected filters.</p>';
    }

    function exportLedgerToExcel() {
        const allSavedReports = getSavedReports();
        const mergedOriginalIds = new Set(allSavedReports.flatMap(r => r.inputs.originalReportIds || []));
        const reportsToExport = allSavedReports.filter(report => !mergedOriginalIds.has(String(report.id)));

        if (reportsToExport.length === 0) {
            alert('No data to export.');
            return;
        }

        let tableHtml = `<table border="1">
            <thead>
                <tr>
                    <th>Token No</th>
                    <th>Payee</th>
                    <th>Gross Amount</th>
                    <th>Tender Deduction</th>
                    <th>Net After Tender</th>
                    <th>Add CGST</th>
                    <th>Add SGST</th>
                    <th>Subtotal for Deductions</th>
                    <th>IT Deduction</th>
                    <th>Labour Cess Deduction</th>
                    <th>CGST Deduction</th>
                    <th>SGST Deduction</th>
                    <th>Royalty Deduction</th>
                    <th>Total Deductions</th>
                    <th>Net Payable</th>
                </tr>
            </thead>
            <tbody>
        `;

        reportsToExport.forEach(report => {
            const { vouchersData, inputs } = report;
            const { taxes, tenderData, gstData, reportType, contractorDetails, tokenNo } = inputs;
            const dataByPayeeInReport = {};

            (vouchersData || []).forEach(voucher => {
                let currentPayee = 'Unknown';
                 if (voucher.payeeDetails) { // Merged report
                    currentPayee = voucher.payeeDetails.name;
                } else if (reportType === 'non-work') {
                    const payeeMatch = voucher.items[0]?.finalParticularsText.match(/<b>Payee:<\/b> (.*?)</);
                    if (payeeMatch) currentPayee = payeeMatch[1];
                } else if (contractorDetails) { // Regular report
                    currentPayee = contractorDetails.split(',')[0];
                }

                if (!dataByPayeeInReport[currentPayee]) {
                    dataByPayeeInReport[currentPayee] = {
                        gross: 0, tender: 0, addCgst: 0, addSgst: 0, subTotal: 0,
                        deductIt: 0, deductLabour: 0, deductCgst: 0, deductSgst: 0, deductRoyalty: 0,
                        netPayable: 0
                    };
                }

                const voucherGross = voucher.items.reduce((s, i) => s + Math.round(i.expenditureAmount), 0);
                const voucherNetAfterTender = voucher.items.reduce((sum, tx) => {
                    const tenderPercent = (tenderData && tenderData[tx.estimate.id] !== undefined) ? tenderData[tx.estimate.id] : 0;
                    return sum + (Math.round(tx.expenditureAmount) - Math.round((Math.round(tx.expenditureAmount) * tenderPercent) / 100));
                }, 0);
                const voucherTender = voucherGross - voucherNetAfterTender;
                
                let addCgst = 0, addSgst = 0;
                let applyGst = (['timber', 'civil', 'e-procurmentTender', 'selectedVoucher'].includes(reportType) && gstData);
                if (reportType === 'timber' && voucher.isEngagingVoucher) applyGst = false;
                if (applyGst) {
                    addCgst = Math.round((voucherNetAfterTender * gstData.cgst) / 100);
                    addSgst = Math.round((voucherNetAfterTender * gstData.sgst) / 100);
                }

                const subTotal = voucher.subTotalForDeductions;
                const {it, labour, cgst, sgst, royalty} = voucher.deductions;
                const netPayable = subTotal - (it + labour + cgst + sgst + royalty);

                dataByPayeeInReport[currentPayee].gross += voucherGross;
                dataByPayeeInReport[currentPayee].tender += voucherTender;
                dataByPayeeInReport[currentPayee].addCgst += addCgst;
                dataByPayeeInReport[currentPayee].addSgst += addSgst;
                dataByPayeeInReport[currentPayee].subTotal += subTotal;
                dataByPayeeInReport[currentPayee].deductIt += it;
                dataByPayeeInReport[currentPayee].deductLabour += labour;
                dataByPayeeInReport[currentPayee].deductCgst += cgst;
                dataByPayeeInReport[currentPayee].deductSgst += sgst;
                dataByPayeeInReport[currentPayee].deductRoyalty += royalty;
                dataByPayeeInReport[currentPayee].netPayable += netPayable;
            });

            for (const payee in dataByPayeeInReport) {
                const totals = dataByPayeeInReport[payee];
                const totalDeductions = totals.deductIt + totals.deductLabour + totals.deductCgst + totals.deductSgst + totals.deductRoyalty;
                const netAfterTender = totals.gross - totals.tender;

                tableHtml += `
                    <tr>
                        <td style="mso-number-format:'\@';">${tokenNo}</td>
                        <td>${payee}</td>
                        <td>${totals.gross.toFixed(2)}</td>
                        <td>${totals.tender.toFixed(2)}</td>
                        <td>${netAfterTender.toFixed(2)}</td>
                        <td>${totals.addCgst.toFixed(2)}</td>
                        <td>${totals.addSgst.toFixed(2)}</td>
                        <td>${totals.subTotal.toFixed(2)}</td>
                        <td>${totals.deductIt.toFixed(2)}</td>
                        <td>${totals.deductLabour.toFixed(2)}</td>
                        <td>${totals.deductCgst.toFixed(2)}</td>
                        <td>${totals.deductSgst.toFixed(2)}</td>
                        <td>${totals.deductRoyalty.toFixed(2)}</td>
                        <td>${totalDeductions.toFixed(2)}</td>
                        <td>${totals.netPayable.toFixed(2)}</td>
                    </tr>
                `;
            }
        });


        tableHtml += `</tbody></table>`;
        
        const blob = new Blob([tableHtml], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'PayeeLedger.xls';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function showPayeeLedger() {
        const allSavedReports = getSavedReports();
        if (allSavedReports.length === 0) {
            alert('No saved reports available to generate a ledger. (ಲೆడ్ಜರ್ ರಚಿಸಲು ಯಾವುದೇ ಉಳಿಸಿದ ವರದಿಗಳು ಲಭ್ಯವಿಲ್ಲ.)');
            return;
        }

        const uniquePayees = new Set();
        const uniqueMonths = new Set();
        const uniqueTokens = new Set();

        allSavedReports.forEach(report => {
            uniqueTokens.add(report.inputs.tokenNo);
            const monthYear = `${report.year}-${String(new Date(Date.parse(report.month +" 1, 2012")).getMonth()+1).padStart(2, '0')}`;
            uniqueMonths.add(monthYear);

            if (report.inputs.reportType === 'non-work') {
                (report.inputs.nonWorkPayees || []).forEach(p => uniquePayees.add(p.name));
            } else {
                if (report.inputs.contractorDetails) {
                    uniquePayees.add(report.inputs.contractorDetails.split(',')[0]);
                }
            }
        });

        const sortedMonths = Array.from(uniqueMonths).sort().reverse();
        
        let filterHtml = `
            <style>
                #payee-ledger-filters { display: flex; gap: 15px; margin-bottom: 20px; padding: 10px; background-color: #f0f8ff; border-radius: 5px; align-items: center; flex-wrap: wrap; justify-content: space-between; }
                #payee-ledger-filters label { font-weight: bold; }
                #payee-ledger-filters select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
                .ledger-summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                .chart-container { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #fdfdfd; }
                .chart-container h4 { margin-top: 0; text-align: center; }
                .chart-bars { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
                .chart-bar-group { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 0 5px; }
                .chart-bar { width: 80%; max-width: 40px; border-radius: 5px 5px 0 0; position: relative; transition: height 0.5s ease-out; }
                .bar-added { background-color: #28a745; }
                .bar-deducted { background-color: #dc3545; }
                .bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; color: #333; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 3px; }
                .chart-label { font-size: 10px; margin-top: 8px; word-wrap: break-word; }
            </style>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label for="ledger-payee-filter">Payee:</label>
                <select id="ledger-payee-filter">
                    <option value="all">All Payees</option>
                    ${Array.from(uniquePayees).sort().map(p => `<option value="${p}">${p}</option>`).join('')}
                </select>
                <label for="ledger-month-filter">Month & Year:</label>
                <select id="ledger-month-filter">
                    <option value="all">All Months</option>
                    ${sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        const monthName = new Date(year, month-1, 1).toLocaleString('default', { month: 'long' });
                        return `<option value="${m}">${monthName} ${year}</option>`;
                    }).join('')}
                </select>
                <label for="ledger-token-filter">Token No:</label>
                <select id="ledger-token-filter">
                    <option value="all">All Tokens</option>
                    ${Array.from(uniqueTokens).sort().map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
            </div>
            <div>
                <button id="export-ledger-excel-btn" class="toolbar-btn btn-info no-print">📄 Export to Excel</button>
                <button id="print-ledger-btn" class="toolbar-btn btn-special no-print">🖨️ Print Ledger</button>
            </div>
        `;
        
        document.getElementById('payee-ledger-filters').innerHTML = filterHtml;
        
        document.getElementById('ledger-payee-filter').addEventListener('change', renderFilteredLedger);
        document.getElementById('ledger-month-filter').addEventListener('change', renderFilteredLedger);
        document.getElementById('ledger-token-filter').addEventListener('change', renderFilteredLedger);
        document.getElementById('export-ledger-excel-btn').addEventListener('click', exportLedgerToExcel);

        document.getElementById('print-ledger-btn').addEventListener('click', () => {
            document.body.classList.add('printing-ledger');
            window.print();
            document.body.classList.remove('printing-ledger');
        });

        renderFilteredLedger(); // Initial render with all data
        
        document.getElementById('payee-ledger-modal').style.display = 'block';
    }

    refreshApplicationState();
    toggleRoyaltyInput(); // Initial check on page load

});
</script>

</body>
</html>
